function darktheme(){}function lighttheme(){}function initSVGpatterns(){var a='<!-- SVG fill properties: url(#diagonal-dots) // url(#dots) url(#diagonal-circles) url(#diagonal-stripes) url(#grid) --><svg xmlns="http://www.w3.org/2000/svg"><defs><pattern id="diagonal-dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke:none; fill:blue;" /></pattern></defs><defs><pattern id="dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="4" style="stroke:none; fill:red;" /></pattern><pattern id="diagonal-circles" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke-width:2; stroke:green; fill:none;" /></pattern><pattern id="diagonal-stripes" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(30)"><rect x="0" y="0" width="4" height="8" style="stroke:none; fill:purple;" /></pattern><pattern id="grid" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="10" height="4" style="stroke:none; fill:orange;" /><rect x="3" y="3" width="4" height="10" style="stroke:none; fill:orange;" /></pattern></defs></svg>';Wu.DomUtil.get("styletag").innerHTML=a}var ich=ich||{};ich.$=function(a){return a},Wu={},Wu.Class=function(){},Wu.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks.length&&this.callInitHooks()},c=b.__super__=this.prototype,d=Wu.Util.create(c);d.constructor=b,b.prototype=d;for(var e in this)this.hasOwnProperty(e)&&"prototype"!==e&&(b[e]=this[e]);return a.statics&&(Wu.extend(b,a.statics),delete a.statics),a.includes&&(Wu.Util.extend.apply(null,[d].concat(a.includes)),delete a.includes),d.options&&(a.options=Wu.Util.extend(Wu.Util.create(d.options),a.options)),Wu.extend(d,a),d._initHooks=[],d.callInitHooks=function(){if(!this._initHooksCalled){c.callInitHooks&&c.callInitHooks.call(this),this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;b>a;a++)d._initHooks[a].call(this)}},b},Wu.Class.include=function(a){Wu.extend(this.prototype,a)},Wu.Class.mergeOptions=function(a){Wu.extend(this.prototype.options,a)},Wu.Class.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1),c="function"==typeof a?a:function(){this[a].apply(this,b)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(c)},Wu.Util={extend:function(a){var b,c,d,e,f=Array.prototype.slice.call(arguments,1);for(c=0,d=f.length;d>c;c++){e=f[c];for(b in e)a[b]=e[b]}return a},create:Object.create||function(){function a(){}return function(b){return a.prototype=b,new a}}(),bind:function(a,b){var c=Array.prototype.slice;if(a.bind)return a.bind.apply(a,c.call(arguments,1));var d=c.call(arguments,2);return function(){return a.apply(b,d.length?d.concat(c.call(arguments)):arguments)}},stamp:function(a){return a._leaflet_id=a._leaflet_id||++Wu.Util.lastId,a._leaflet_id},lastId:0,throttle:function(a,b,c){var d,e,f,g;return g=function(){d=!1,e&&(f.apply(c,e),e=!1)},f=function(){d?e=arguments:(a.apply(c,arguments),setTimeout(g,b),d=!0)}},wrapNum:function(a,b,c){var d=b[1],e=b[0],f=d-e;return a===d&&c?a:((a-e)%f+f)%f+e},falseFn:function(){return!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},trim:function(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},trimAll:function(a){return a.replace(/\s+/g,"")},splitWords:function(a){return Wu.Util.trim(a).split(/\s+/)},setOptions:function(a,b){a.hasOwnProperty("options")||(a.options=a.options?Wu.Util.create(a.options):{});for(var c in b)a.options[c]=b[c];return a.options},getParamString:function(a,b,c){var d=[];for(var e in a)d.push(encodeURIComponent(c?e.toUpperCase():e)+"="+encodeURIComponent(a[e]));return(b&&-1!==b.indexOf("?")?"&":"?")+d.join("&")},template:function(a,b){return a.replace(Wu.Util.templateRe,function(a,c){var d=b[c];if(void 0===d)throw new Error("No value provided for variable "+a);return"function"==typeof d&&(d=d(b)),d})},templateRe:/\{ *([\w_]+) *\}/g,emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",templateIch:function(a,b,c){var d=Wu.DomUtil.create("div","");if(d.innerHTML=ich[a](b),c){for(var e=d,f=0;f<e.children.length;f++)c.appendChild(e.children[f]);return c.children[0]}return d.children},isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return"[object Object]"===Object.prototype.toString.call(a)},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},setAddressBar:function(a){window.history.pushState({},"",a)},checkDisconnect:function(a){"<!doctype html>"==a.substring(0,16)},post:function(a,b){var c=new XMLHttpRequest,d=window.location.origin;d+=a,c.open("POST",d,!0),c.setRequestHeader("Content-type","application/json"),c.onreadystatechange=function(){4==c.readyState&&200==c.status&&Wu.Util.checkDisconnect(c.responseText)},c.send(b)},postcb:function(a,b,c,d,e){var f=new XMLHttpRequest,g=e||window.location.origin;g+=a,f.open("POST",g,!0),f.setRequestHeader("Content-type","application/json"),f.onreadystatechange=function(){4==f.readyState&&200==f.status&&(Wu.Util.checkDisconnect(f.responseText),c&&c(d,f.responseText))},f.send(b)},send:function(a,b,c){var d=new XMLHttpRequest,e=window.location.origin;e+=a,d.open("POST",e,!0),d.setRequestHeader("Content-type","application/json"),d.onreadystatechange=function(){4==d.readyState&&(Wu.Util.checkDisconnect(d.responseText),200==d.status?c&&c(null,d.responseText):c&&c(d.status))},d.send(b)},_parse:function(a){try{var b=JSON.parse(a);return b}catch(c){return!1}},_getJSON:function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.setRequestHeader("Content-type","application/json"),c.onreadystatechange=function(){4==c.readyState&&200==c.status&&b(c.responseText)},c.send(null)},_getParentClientID:function(a){var b="";for(c in Wu.app.Clients){var d=Wu.app.Clients[c];d.projects.forEach(function(c){c==a&&(b=d.uuid)})}return b||(b=Wu.app._activeClient.uuid),b},guid:function(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)});return a?a+"-"+b:b},createRandom:function(a){return Math.random().toString(36).slice(-1*a).toUpperCase()},deselectText:function(){var a="getSelection"in window?window.getSelection():"selection"in document?document.selection:null;"removeAllRanges"in a?a.removeAllRanges():"empty"in a&&a.empty()},generateZip:function(a){var b=LZString.compress(a);return b},zipSave:function(a,b){var c,c=b,d=new LZMA("//85.10.202.87:8080/js/lib/lzma/lzma_worker.js");d.compress(c,1,function(b){var c=JSON.stringify(b),d=new XMLHttpRequest,e=window.location.origin;e+=a,d.open("POST",e,!0),d.onreadystatechange=function(){4==d.readyState&&200==d.status},d.send(c)},function(){})},zippedSave:function(){},setColorTheme:function(){injectCSS()},can:{create:{project:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1},client:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1},superadmin:function(){var a=app.User.store;return a.role.superadmin?!0:!1},admin:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1},manager:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1},editor:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1},reader:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:a.role.manager.projects.indexOf(uuid)>=0?!0:!1}},read:{project:function(a){var b=app.User.store;return b.role.superadmin?!0:b.role.admin?!0:b.role.manager.projects.indexOf(a)>=0?!0:b.role.editor.projects.indexOf(a)>=0?!0:b.role.reader.projects.indexOf(a)>=0?!0:!1},client:function(a){var b=app.User.store;return b.role.superadmin?!0:b.role.admin?!0:b.role.manager.clients.indexOf(a)>=0?!0:b.role.editor.clients.indexOf(a)>=0?!0:b.role.reader.clients.indexOf(a)>=0?!0:!1}},update:{project:function(a){var b=app.User.store;return b.role.superadmin?!0:b.role.admin?!0:b.role.editor.projects.indexOf(a)>=0?!0:!1},client:function(a){var b=app.User.store;return b.role.superadmin?!0:b.role.admin?!0:b.role.editor.clients.indexOf(a)>=0?!0:!1},user:function(a){var b=app.User.store;return b.role.superadmin?!0:b.role.admin?!0:b.role.manager.indexOf(a)>=0?!0:!1}},remove:{project:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1},client:function(){var a=app.User.store;return a.role.superadmin?!0:a.role.admin?!0:!1}}},prettyDate:function(a,b){function c(a,b){var c=.1;return a>=b&&b*(1+c)>=a?b:a}if(a){var d,e={ago:"Ago",from:"",now:"Just Now",minute:"Minute",minutes:"Minutes",hour:"Hour",hours:"Hours",day:"Day",days:"Days",week:"Week",weeks:"Weeks",month:"Month",months:"Months",year:"Year",years:"Years"},f=[[60,e.now],[3600,e.minute,e.minutes,60],[86400,e.hour,e.hours,3600],[604800,e.day,e.days,86400],[2628e3,e.week,e.weeks,604800],[31536e3,e.month,e.months,2628e3],[1/0,e.year,e.years,31536e3]],g="string"==typeof a,a=g?new Date((""+a).replace(/-/g,"/").replace(/T|(?:\.\d+)?Z/g," ")):a,b=b||new Date,h=(b-a+6e4*(b.getTimezoneOffset()-(g?0:a.getTimezoneOffset())))/1e3;0>h?(h=Math.abs(h),d=e.from?" "+e.from:""):d=e.ago?" "+e.ago:"";for(var i=0,j=f[0];f[i];j=f[++i])if(h<j[0]){if(0===i)return j[1];var k=Math.ceil(c(h,j[3])/j[3]);return k+" "+(1!=k?j[2]:j[1])+(i>0?d:"")}}},stripAccents:function(a){var b={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ý":"Y","ß":"s","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ý":"y","ÿ":"y","Ā":"A","ā":"a","Ă":"A","ă":"a","Ą":"A","ą":"a","Ć":"C","ć":"c","Ĉ":"C","ĉ":"c","Ċ":"C","ċ":"c","Č":"C","č":"c","Ď":"D","ď":"d","Đ":"D","đ":"d","Ē":"E","ē":"e","Ĕ":"E","ĕ":"e","Ė":"E","ė":"e","Ę":"E","ę":"e","Ě":"E","ě":"e","Ĝ":"G","ĝ":"g","Ğ":"G","ğ":"g","Ġ":"G","ġ":"g","Ģ":"G","ģ":"g","Ĥ":"H","ĥ":"h","Ħ":"H","ħ":"h","Ĩ":"I","ĩ":"i","Ī":"I","ī":"i","Ĭ":"I","ĭ":"i","Į":"I","į":"i","İ":"I","ı":"i","Ĳ":"IJ","ĳ":"ij","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","Ĺ":"L","ĺ":"l","Ļ":"L","ļ":"l","Ľ":"L","ľ":"l","Ŀ":"L","ŀ":"l","Ł":"l","ł":"l","Ń":"N","ń":"n","Ņ":"N","ņ":"n","Ň":"N","ň":"n","ŉ":"n","Ō":"O","ō":"o","Ŏ":"O","ŏ":"o","Ő":"O","ő":"o","Œ":"OE","œ":"oe","Ŕ":"R","ŕ":"r","Ŗ":"R","ŗ":"r","Ř":"R","ř":"r","Ś":"S","ś":"s","Ŝ":"S","ŝ":"s","Ş":"S","ş":"s","Š":"S","š":"s","Ţ":"T","ţ":"t","Ť":"T","ť":"t","Ŧ":"T","ŧ":"t","Ũ":"U","ũ":"u","Ū":"U","ū":"u","Ŭ":"U","ŭ":"u","Ů":"U","ů":"u","Ű":"U","ű":"u","Ų":"U","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","ź":"z","Ż":"Z","ż":"z","Ž":"Z","ž":"z","ſ":"s","ƒ":"f","Ơ":"O","ơ":"o","Ư":"U","ư":"u","Ǎ":"A","ǎ":"a","Ǐ":"I","ǐ":"i","Ǒ":"O","ǒ":"o","Ǔ":"U","ǔ":"u","Ǖ":"U","ǖ":"u","Ǘ":"U","ǘ":"u","Ǚ":"U","ǚ":"u","Ǜ":"U","ǜ":"u","Ǻ":"A","ǻ":"a","Ǽ":"AE","ǽ":"ae","Ǿ":"O","ǿ":"o"},c=/\W/g,d=function(a){return b[a]||a};return a.replace(c,d)},bytesToSize:function(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Byte";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]},parseUrl:function(){var a=window.location.search.substr(1),b={};return a.split("&").forEach(function(a){var c=a.split("=");""!=c[0]&&(b[c[0]]=decodeURIComponent(c[1]))}),_.size(b)?b:!1},getWindowSize:function(){var a={width:window.innerWidth,height:window.innerHeight};return a},setStyle:function(a,b){jss.set(a,b)},getStyle:function(a){return jss.getAll(a)}},function(){function a(a){return window["webkit"+a]||window["moz"+a]||window["ms"+a]}function b(a){var b=+new Date,d=Math.max(0,16-(b-c));return c=b+d,window.setTimeout(a,d)}var c=0,d=window.requestAnimationFrame||a("RequestAnimationFrame")||b,e=window.cancelAnimationFrame||a("CancelAnimationFrame")||a("CancelRequestAnimationFrame")||function(a){window.clearTimeout(a)};Wu.Util.requestAnimFrame=function(a,c,e,f){return e&&d===b?void a.call(c):d.call(window,Wu.bind(a,c),f)},Wu.Util.cancelAnimFrame=function(a){a&&e.call(window,a)}}(),Wu.extend=Wu.Util.extend,Wu.bind=Wu.Util.bind,Wu.stamp=Wu.Util.stamp,Wu.setOptions=Wu.Util.setOptions,Wu.save=Wu.Util.post,Wu.post=Wu.Util.postcb,Wu.send=Wu.Util.send,Wu.parse=Wu.Util._parse,Wu.zip=Wu.Util.generateZip,Wu.zave=Wu.Util.zipSave,Wu.can=Wu.Util.can,ichDiv=Wu.Util.templateIch,Wu.setStyle=Wu.Util.setStyle,Wu.getStyle=Wu.Util.getStyle,Wu.Evented=Wu.Class.extend({on:function(a,b,c){if("object"==typeof a)for(var d in a)this._on(d,a[d],b);else{a=Wu.Util.splitWords(a);for(var e=0,f=a.length;f>e;e++)this._on(a[e],b,c)}return this},off:function(a,b,c){if(a)if("object"==typeof a)for(var d in a)this._off(d,a[d],b);else{a=Wu.Util.splitWords(a);for(var e=0,f=a.length;f>e;e++)this._off(a[e],b,c)}else delete this._events;return this},_on:function(a,b,c){var d=this._events=this._events||{},e=c&&c!==this&&Wu.stamp(c);if(e){var f=a+"_idx",g=a+"_len",h=d[f]=d[f]||{},i=Wu.stamp(b)+"_"+e;h[i]||(h[i]={fn:b,ctx:c},d[g]=(d[g]||0)+1)}else d[a]=d[a]||[],d[a].push({fn:b})},_off:function(a,b,c){var d=this._events,e=a+"_idx",f=a+"_len";if(d){if(!b)return delete d[a],delete d[e],void delete d[f];var g,h,i,j,k,l=c&&c!==this&&Wu.stamp(c);if(l)k=Wu.stamp(b)+"_"+l,g=d[e],g&&g[k]&&(j=g[k],delete g[k],d[f]--);else if(g=d[a])for(h=0,i=g.length;i>h;h++)if(g[h].fn===b){j=g[h],g.splice(h,1);break}j&&(j.fn=Wu.Util.falseFn)}},fire:function(a,b,c){if(!this.listens(a,c))return this;var d=Wu.Util.extend({},b,{type:a,target:this}),e=this._events;if(e){var f,g,h,i,j=e[a+"_idx"];if(e[a])for(h=e[a].slice(),f=0,g=h.length;g>f;f++)h[f].fn.call(this,d);for(i in j)j[i].fn.call(j[i].ctx,d)}return c&&this._propagateEvent(d),this},listens:function(a,b){var c=this._events;if(c&&(c[a]||c[a+"_len"]))return!0;if(b)for(var d in this._eventParents)if(this._eventParents[d].listens(a,b))return!0;return!1},once:function(a,b,c){if("object"==typeof a){for(var d in a)this.once(d,a[d],b);return this}var e=Wu.bind(function(){this.off(a,b,c).off(a,e,c)},this);return this.on(a,b,c).on(a,e,c)},addEventParent:function(a){return this._eventParents=this._eventParents||{},this._eventParents[Wu.stamp(a)]=a,this},removeEventParent:function(a){return this._eventParents&&delete this._eventParents[Wu.stamp(a)],this},_propagateEvent:function(a){for(var b in this._eventParents)this._eventParents[b].fire(a.type,Wu.extend({layer:a.target},a),!0)}});var proto=Wu.Evented.prototype;proto.addEventListener=proto.on,proto.removeEventListener=proto.clearAllEventListeners=proto.off,proto.addOneTimeEventListener=proto.once,proto.fireEvent=proto.fire,proto.hasEventListeners=proto.listens,Wu.Mixin={Events:proto},Wu.DomUtil={get:function(a){return"string"==typeof a?document.getElementById(a):a},getStyle:function(a,b){var c=a.style[b]||a.currentStyle&&a.currentStyle[b];if((!c||"auto"===c)&&document.defaultView){var d=document.defaultView.getComputedStyle(a,null);c=d?d[b]:null}return"auto"===c?null:c},create:function(a,b,c,d){var e=document.createElement(a);return e.className=b,c&&c.appendChild(e),d&&("input"==a?e.setAttribute("placeholder",d):"image"==a?e.src=d:e.innerHTML=d),e},makeit:function(a){var b=document.createElement(a.type);return a.id&&(b.id=a.id),a.cname&&(b.className=a.cname),a.style&&b.setAttribute("style",a.style),a.hlink&&b.setAttribute("href",a.hlink),a.source&&(b.src=a.source),a.inner&&(b.innerHTML=a.inner),a.appendto&&a.appendto.appendChild(b),a.attr&&a.attr.forEach(function(a){b.setAttribute(a[0],a[1])}),b},createId:function(a,b,c){var d=document.createElement(a);return d.id=b,c&&c.appendChild(d),d},remove:function(a){var b=a.parentNode;b&&b.removeChild(a)},toFront:function(a){a.parentNode.appendChild(a)},toBack:function(a){var b=a.parentNode;b.insertBefore(a,b.firstChild)},hasClass:function(a,b){if(void 0!==a.classList)return a.classList.contains(b);var c=Wu.DomUtil.getClass(a);return c.length>0&&new RegExp("(^|\\s)"+b+"(\\s|$)").test(c)},addClass:function(a,b){if(!a)return void 0;if(void 0!==a.classList)for(var c=Wu.Util.splitWords(b),d=0,e=c.length;e>d;d++)a.classList.add(c[d]);else if(!Wu.DomUtil.hasClass(a,b)){var f=Wu.DomUtil.getClass(a);Wu.DomUtil.setClass(a,(f?f+" ":"")+b)}},removeClass:function(a,b){return a?void(void 0!==a.classList?a.classList.remove(b):Wu.DomUtil.setClass(a,Wu.Util.trim((" "+Wu.DomUtil.getClass(a)+" ").replace(" "+b+" "," ")))):void 0},classed:function(a,b,c){c?this.addClass(a,b):this.removeClass(a,b)},setClass:function(a,b){void 0===a.className.baseVal?a.className=b:a.className.baseVal=b},getClass:function(a){return void 0===a.className.baseVal?a.className:a.className.baseVal},appendTemplate:function(a,b){if("string"==typeof b){var c=Wu.DomUtil.create("div");for(c.innerHTML=b,i=0;i<c.childNodes.length;i++)a.appendChild(c.childNodes[i])}return a},prependTemplate:function(a,b,c){if("string"==typeof b){var d=Wu.DomUtil.create("div");if(d.innerHTML=b,c)var e=a.firstChild;else var e=a.firstChild.nextSibling;for(i=0;i<d.childNodes.length;i++)a.insertBefore(d.childNodes[i],e)}return a},thumbAdjust:function(a,b){var c=new Image;c.src=a.src,c.onload=function(){var c=this.width,d=this.height,e=c/b,f=d/b,g=!0;c>=d&&(g=!1),g?(a.style.width="100%",a.style.top=-Math.floor(f)/2+"px"):(a.style.height="100%",a.style.left=-Math.floor(e)/2+"px")}}};var eventsKey="_leaflet_events";Wu.DomEvent={on:function(a,b,c,d){if("object"==typeof b)for(var e in b)this._on(a,e,b[e],c);else{b=Wu.Util.splitWords(b);for(var f=0,g=b.length;g>f;f++)this._on(a,b[f],c,d)}return this},off:function(a,b,c,d){if("object"==typeof b)for(var e in b)this._off(a,e,b[e],c);else{b=Wu.Util.splitWords(b);for(var f=0,g=b.length;g>f;f++)this._off(a,b[f],c,d)}return this},_on:function(a,b,c,d){var e=b+Wu.stamp(c)+(d?"_"+Wu.stamp(d):"");if(a[eventsKey]&&a[eventsKey][e])return this;var f=function(b){return c.call(d||a,b||window.event)},g=f;return Wu.Browser.pointer&&0===b.indexOf("touch")?this.addPointerListener(a,b,f,e):(Wu.Browser.touch&&"dblclick"===b&&this.addDoubleTapListener&&this.addDoubleTapListener(a,f,e),"addEventListener"in a?"mousewheel"===b?(a.addEventListener("DOMMouseScroll",f,!1),a.addEventListener(b,f,!1)):"mouseenter"===b||"mouseleave"===b?(f=function(b){return b=b||window.event,Wu.DomEvent._checkMouse(a,b)?g(b):void 0},a.addEventListener("mouseenter"===b?"mouseover":"mouseout",f,!1)):("click"===b&&Wu.Browser.android&&(f=function(a){return Wu.DomEvent._filterClick(a,g)}),a.addEventListener(b,f,!1)):"attachEvent"in a&&a.attachEvent("on"+b,f),a[eventsKey]=a[eventsKey]||{},a[eventsKey][e]=f,this)},_off:function(a,b,c,d){var e=b+Wu.stamp(c)+(d?"_"+Wu.stamp(d):""),f=a[eventsKey]&&a[eventsKey][e];return f?(Wu.Browser.pointer&&0===b.indexOf("touch")?this.removePointerListener(a,b,e):Wu.Browser.touch&&"dblclick"===b&&this.removeDoubleTapListener?this.removeDoubleTapListener(a,e):"removeEventListener"in a?"mousewheel"===b?(a.removeEventListener("DOMMouseScroll",f,!1),a.removeEventListener(b,f,!1)):a.removeEventListener("mouseenter"===b?"mouseover":"mouseleave"===b?"mouseout":b,f,!1):"detachEvent"in a&&a.detachEvent("on"+b,f),a[eventsKey][e]=null,this):this},stopPropagation:function(a){return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,Wu.DomEvent._skipped(a),this},disableScrollPropagation:function(a){return Wu.DomEvent.on(a,"mousewheel MozMousePixelScroll",Wu.DomEvent.stopPropagation)},preventDefault:function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1,this},stop:function(a){return Wu.DomEvent.preventDefault(a).stopPropagation(a)},getWheelDelta:function(a){var b=0;return a.wheelDelta&&(b=a.wheelDelta/120),a.detail&&(b=-a.detail/3),b},_skipEvents:{},_fakeStop:function(a){Wu.DomEvent._skipEvents[a.type]=!0},_skipped:function(a){var b=this._skipEvents[a.type];return this._skipEvents[a.type]=!1,b},_checkMouse:function(a,b){var c=b.relatedTarget;if(!c)return!0;try{for(;c&&c!==a;)c=c.parentNode}catch(d){return!1}return c!==a},_filterClick:function(a,b){var c=a.timeStamp||a.originalEvent.timeStamp,d=Wu.DomEvent._lastClick&&c-Wu.DomEvent._lastClick;return d&&d>100&&500>d||a.target._simulatedClick&&!a._simulated?void Wu.DomEvent.stop(a):(Wu.DomEvent._lastClick=c,b(a))}},Wu.DomEvent.addListener=Wu.DomEvent.on,Wu.DomEvent.removeListener=Wu.DomEvent.off,function(){var a=navigator.userAgent.toLowerCase(),b=document.documentElement,c="ActiveXObject"in window,d=-1!==a.indexOf("webkit"),e=-1!==a.indexOf("phantom"),f=-1!==a.search("android [23]"),g=-1!==a.indexOf("chrome"),h="undefined"!=typeof orientation,i=navigator.msPointerEnabled&&navigator.msMaxTouchPoints&&!window.PointerEvent,j=window.PointerEvent&&navigator.pointerEnabled&&navigator.maxTouchPoints||i,k=c&&"transition"in b.style,l="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!f,m="MozPerspective"in b.style,n="OTransition"in b.style,o="devicePixelRatio"in window&&window.devicePixelRatio>1;if(!o&&"matchMedia"in window){var p=window.matchMedia("(min-resolution:1.5dppx)");o=p&&p.matches}var q=!window.L_NO_TOUCH&&!e&&(j||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);Wu.Browser={ie:c,ielt9:c&&!document.addEventListener,webkit:d,gecko:-1!==a.indexOf("gecko")&&!d&&!window.opera&&!c,android:-1!==a.indexOf("android"),android23:f,chrome:g,safari:!g&&-1!==a.indexOf("safari"),ie3d:k,webkit3d:l,gecko3d:m,opera3d:n,any3d:!window.L_DISABLE_3D&&(k||l||m||n)&&!e,mobile:h,mobileWebkit:h&&d,mobileWebkit3d:h&&l,mobileOpera:h&&window.opera,touch:!!q,msPointer:!!i,pointer:!!j,retina:!!o}}(),Array.prototype.diff=function(a){return this.filter(function(b){return a.indexOf(b)<0})},Array.prototype.move=function(a,b){this.splice(b,0,this.splice(a,1)[0])},Array.prototype.moveUp=function(a,b){var c=this.indexOf(a),d=c-(b||1);if(-1===c)throw new Error("Element not found in array");0>d&&(d=0),this.splice(c,1),this.splice(d,0,a)},Array.prototype.moveDown=function(a,b){var c=this.indexOf(a),d=c+(b||1);if(-1===c)throw new Error("Element not found in array");d>=this.length&&(d=this.length),this.splice(c,1),this.splice(d,0,a)},String.prototype.camelize=function(){return this.replace(/(?:^|[-_])(\w)/g,function(a,b){return b?b.toUpperCase():""})},JSON.parseAsync=function(a,b){var c,d;return window.Worker?(c=new Worker("json.worker.js"),c.addEventListener("message",function(a){d=a.data,b(d)},!1),void c.postMessage(a)):(d=JSON.parse(a),void b(d))},Function.prototype.bind=Function.prototype.bind||function(a){var b=this;return function(){return b.apply(a,arguments)}},L.Map.include({reframe:function(){return this._loaded?(this._sizeChanged=!0,void this.fire("moveend")):this}}),L.Control.Draw.include({onAdd:function(a){var b,c=L.DomUtil.create("div","leaflet-draw"),d=!1,e="leaflet-draw-toolbar-top",f=L.DomUtil.create("div","leaflet-draw-section-button",c),g=L.DomUtil.create("div","leaflet-draw-section-wrapper",c);this._wrapper=g,app.Tooltip.add(f,"Draw on the map"),L.DomEvent.on(f,"mousedown",function(a){L.DomEvent.stop(a),L.DomUtil.hasClass(g,"draw-expander")?(L.DomUtil.removeClass(g,"draw-expander"),L.DomUtil.removeClass(f,"open-drawer")):(L.DomUtil.addClass(g,"draw-expander"),L.DomUtil.addClass(f,"open-drawer"))},this),L.DomEvent.on(f,"dblclick",L.DomEvent.stop,this);for(var h in this._toolbars)this._toolbars.hasOwnProperty(h)&&(b=this._toolbars[h].addToolbar(a),b&&(d||(L.DomUtil.hasClass(b,e)||L.DomUtil.addClass(b.childNodes[0],e),d=!0),g.appendChild(b)));return c}}),L.Popup.include({_initLayout:function(){var a,b="leaflet-popup",c=b+" "+this.options.className+" leaflet-zoom-"+(this._animated?"animated":"hide"),d=this._container=L.DomUtil.create("div",c);this.options.closeButton&&(a=this._closeButton=L.DomUtil.create("a",b+"-close-button",d),a.href="#close",a.innerHTML="&#215;",L.DomEvent.disableClickPropagation(a),L.DomEvent.on(a,"click",this._onCloseButtonClick,this));var e=this._wrapper=L.DomUtil.create("div",b+"-content-wrapper",d);L.DomEvent.disableClickPropagation(e),this._contentNode=L.DomUtil.create("div",b+"-content",e),L.DomEvent.disableScrollPropagation(this._contentNode),L.DomEvent.on(e,"contextmenu",L.DomEvent.stopPropagation),this._tipContainer=L.DomUtil.create("div",b+"-tip-container",d),this._tip=L.DomUtil.create("div",b+"-tip",this._tipContainer)},_updateLayout:function(){var a=this._contentNode,b=a.style,c=a.parentNode;b.width="",b.whiteSpace="nowrap";var d=a.offsetWidth;d=Math.min(d,this.options.maxWidth),d=Math.max(d,this.options.minWidth),b.width=d+46+"px",b.whiteSpace="",b.height="";var e=a.offsetHeight,f=this.options.maxHeight,g="leaflet-popup-scrolled";f&&e>f?(b.height=f+"px",L.DomUtil.addClass(a,g)):L.DomUtil.removeClass(a,g),this._containerWidth=this._container.offsetWidth,c.style.width=d+46+"px"}}),Wu.SidePane=Wu.Class.extend({_:"sidepane",initialize:function(a){return this.options=a||app.options,this.initContainer(),this.initContent(),this.render(),this},initContainer:function(){var a="q-editor-container";this._container=Wu.DomUtil.create("div",a,Wu.app._appPane),this.paneOpen=!1,this.whichPaneOpen="projects",Wu.app.mobile&&(this._mobileFullScreenCloser=Wu.DomUtil.create("div","q-editor-fullscreen-mobile-close displayNone",this._container),Wu.DomEvent.on(this._mobileFullScreenCloser,"mousedown",this.closeMobileFullscreen,this))},closeMobileFullscreen:function(){app.SidePane.fullscreen&&(Wu.app._editorMenuPane.style.opacity=1,Wu.DomUtil.addClass(app.SidePane._mobileFullScreenCloser,"displayNone"),Wu.DomUtil.removeClass(app._mapPane,"map-blur"),Wu.DomUtil.removeClass(Wu.app._active,"show"),app.SidePane.fullscreen=!1)},initContent:function(){var a="q-editor-menu";Wu.app._editorMenuPane=Wu.DomUtil.create("menu",a,this._container);var a="q-editor-content hide-menu displayNone";app._editorContentPane=Wu.DomUtil.create("content",a,this._container),app._menuSlider=Wu.DomUtil.createId("div","menuslider",Wu.app._editorMenuPane),app._menuSliderArrow=Wu.DomUtil.createId("div","menuslider-arrow",Wu.app._menuSlider)},render:function(){var a=this.options.panes;a.clients&&(this.Clients=new Wu.SidePane.Clients),a.mapOptions&&(this.Map=new Wu.SidePane.Map),a.documents&&(this.Documents=new Wu.SidePane.Documents),a.dataLibrary&&(this.DataLibrary=new Wu.SidePane.DataLibrary),a.mediaLibrary&&(this.MediaLibrary=new Wu.SidePane.MediaLibrary),a.users&&(this.Users=new Wu.SidePane.Users),a.share&&(this.Share=new Wu.SidePane.Share),a.account&&(this.Account=new Wu.SidePane.Account)},calculateHeight:function(){var a=app.HeaderPane,b=a.getHeight();b||(b=80),this._minHeight=0},setHeight:function(a){this._container.style.height=a+"px"},collapse:function(){this.calculateHeight(),this.setHeight(this._minHeight),this.closePane(),this._deactivate()},_deactivate:function(){this.Clients&&this.Clients._deactivate(),this.Map&&this.Map._deactivate(),this.Documents&&this.Documents._deactivate(),this.DataLibrary&&this.DataLibrary._deactivate(),this.MediaLibrary&&this.MediaLibrary._deactivate(),this.Users&&this.Users._deactivate(),this.Share&&this.Share._deactivate(),this.Account&&this.Account._deactivate()},expand:function(){this._setMenuHeight(),this.openPane()},_setMenuHeight:function(){if(Wu.app.mobile)var a=50;else var a=70;var b=this._getPaneArray(),c=app.Account.isManager()?3:2;if(0!=b)var d=b.length*a;else var d=c*a;app._editorMenuPane.style.height=parseInt(d)+"px"},_getPaneArray:function(a){var a=a||app.activeProject;if(!a)return[];var b=[],c=this.options.panes,d=a.getSettings(),e=app.Account.canUpdateProject(a.getUuid()),f=app.Account.canManageProject(a.getUuid());return c.clients&&b.push("Clients"),c.mapOptions&&e&&b.push("Map"),c.documents&&d.documentsPane&&b.push("Documents"),c.dataLibrary&&d.dataLibrary&&b.push("DataLibrary"),c.MediaLibrary&&d.mediaLibrary&&b.push("MediaLibrary"),c.users&&f&&b.push("Users"),c.share&&d.socialSharing&&b.push("Share"),c.account&&b.push("Account"),b},setProject:function(a){this.Home&&this.Home.updateContent(a),this.Map&&this.Map.updateContent(a),this.Documents&&this.Documents.updateContent(a),this.DataLibrary&&this.DataLibrary.updateContent(a)},refreshProject:function(a){var b=a.editMode,c=this._getPaneArray(a);this.paneOpen&&this._setMenuHeight(),b||_.pull(c,"Map"),app.Account.isManager()||_.pull(c,"Users"),this.refresh(c)},refreshClient:function(){var a=["Clients"];app.Account.isManager()&&a.push("Users"),a.push("Account"),this.refresh(a)},refresh:function(a){var a=a||this.panes;this.panes=[];var b=["Clients","Map","Documents","DataLibrary","Users","Share","Account"],c=app.SidePane;b.forEach(function(a){c[a]||(c[a]=new Wu.SidePane[a]),c[a].enable(),this.panes.push(a)},this);var d=b.diff(a);d.forEach(function(a){var b=c[a];b&&c[a].disable(),_.pull(this.panes,a)},this),this.paneOpen&&setTimeout(this._setMenuHeight.bind(this),100)},_refresh:function(){var a=this._getPaneArray();this.refresh(a)},addPane:function(a){var b=this._addPane(a);this.refresh(b)},_addPane:function(a){var b=Wu.extend([],this.panes);return b.push(a),b=_.unique(b)},removePane:function(a){var b=this._removePane(a);this.refresh(b)},_removePane:function(a){var b=Wu.extend([],this.panes);return _.pull(b,a),b},closePane:function(){this.paneOpen&&(this.paneOpen=!1,Wu.app._editorMenuPane.style.height="0px",Wu.DomUtil.addClass(app._editorContentPane,"hide-menu"),setTimeout(function(){Wu.DomUtil.addClass(app._editorContentPane,"displayNone")},300),this._refreshLeaflet(),Wu.DomUtil.removeClass(app.SidePane.Documents._content,"show"),Wu.DomUtil.removeClass(app.SidePane.DataLibrary._content,"show"),Wu.DomUtil.removeClass(app.SidePane.Users._content,"show"))},_closePane:function(){},openPane:function(){this.paneOpen||(this.paneOpen=!0,Wu.DomUtil.addClass(app._active,"show"),Wu.DomUtil.removeClass(app._editorContentPane,"displayNone"),setTimeout(function(){Wu.DomUtil.removeClass(app._editorContentPane,"hide-menu")},10),this._refreshLeaflet(),Wu.app.mobile&&this.openOnMobile())},openOnMobile:function(){("documents"==app._activeMenuItem||"dataLibrary"==app._activeMenuItem||"users"==app._activeMenuItem)&&app.SidePane.Clients.activate()},widenContainer:function(){this._container.style.width="100%"},_refreshLeaflet:function(){setTimeout(function(){var a=Wu.app._map;a&&a.reframe()},300)}}),Wu.SidePane.Item=Wu.Class.extend({_wu:"sidepane.item",type:"item",initialize:function(){Wu.setOptions(this,Wu.app.options),this.render()},render:function(){this.initContainer(),this.initContent(),this.addHooks(),this.disable()},initContainer:function(){var a="q-editor-menu-item "+this.type;this._menu=Wu.DomUtil.create("div",a,Wu.app._editorMenuPane),this._title=Wu.DomUtil.create("a",this.type,this._menu),this._title.innerHTML=Wu.Util.capitalize(this.title||this.type);var a="q-editor-content-item "+this.type;this._content=Wu.DomUtil.create("div",a,Wu.app._editorContentPane),this._scrollWrapper=Wu.DomUtil.create("div","editor-scroll-wrapper",this._content),this._container=Wu.DomUtil.create("div","editor-wrapper",this._scrollWrapper)},initContent:function(){},addHooks:function(){Wu.DomEvent.on(this._menu,"mousedown",this._clickActivate,this),Wu.DomEvent.on(this._menu,"mouseenter",this._mouseenter,this),Wu.DomEvent.on(this._menu,"mouseleave",this._mouseleave,this)},_mouseenter:function(){Wu.DomUtil.addClass(this._menu,"red")},_mouseleave:function(){Wu.DomUtil.removeClass(this._menu,"red")},_reclick:function(){Wu.DomUtil.get("menuslider-arrow");if(Wu.app.SidePane.paneOpen)Wu.DomUtil.removeClass(Wu.app._active,"show"),Wu.app.SidePane.closePane(),Wu.DomUtil.removeClass(app._mapPane,"map-blur");else{Wu.DomUtil.addClass(Wu.app._active,"show"),Wu.app.SidePane.openPane();var a=Wu.app._active.classList;(_.contains(a,"fullpage-documents")||_.contains(a,"data-library")||_.contains(a,"fullpage-users"))&&Wu.DomUtil.addClass(app._mapPane,"map-blur")}},_clickActivate:function(){Wu.app.mobile&&this.mobileReActivate(),Wu.app._activeMenu!=this&&(Wu.app.SidePane.paneOpen||Wu.app.SidePane.openPane(),this.activate())
},mobileReActivate:function(){this.activate(),("documents"==app._activeMenuItem||"dataLibrary"==app._activeMenuItem||"users"==app._activeMenuItem)&&(Wu.DomUtil.addClass(Wu.app._active,"show"),this.mobileFullScreenAdjustment())},activate:function(){var a=Wu.app._activeMenu||!1;Wu.app._activeMenu=this,Wu.app._active=this._content,app._activeMenuItem=this.type,this.checkSwipe(a),a&&Wu.DomUtil.removeClass(a._menu,"active"),Wu.DomUtil.addClass(this._menu,"active"),a&&a._deactivate(),this._activate(),this.update()},mobileFullScreenAdjustment:function(){Wu.app._editorMenuPane.style.opacity=0,Wu.DomUtil.removeClass(app.SidePane._mobileFullScreenCloser,"displayNone",this),app.SidePane.fullscreen=!0},_activate:function(){},_deactivate:function(){},checkSwipe:function(a){return a?this.swiper(a):(Wu.app._active&&Wu.DomUtil.removeClass(Wu.app._active,"show"),Wu.app._active=this._content,void Wu.DomUtil.addClass(Wu.app._active,"show"))},swiper:function(a){if(Wu.app.mobile)var b=50;else var b=70;var c=a._content,d=Wu.app._active;if(c!=d){var e=b,f=Wu.DomUtil.get("menuslider"),g=(this._menu.classList,Wu.app.SidePane.paneOpen),h="100px";g&&(h="400px");var i=Wu.DomUtil.get("map"),j=Wu.DomUtil.get("menuslider-arrow");if(j.style.width="9px","clients"==app._activeMenuItem&&(f.style.top="0px",Wu.app.SidePane._container.style.width=h,Wu.DomUtil.removeClass(i,"map-blur")),"map"==app._activeMenuItem){var k=app.SidePane.panes.indexOf("Map");f.style.top=e*k+"px",Wu.app.SidePane._container.style.width=h,Wu.DomUtil.removeClass(i,"map-blur")}if("documents"==app._activeMenuItem){var k=app.SidePane.panes.indexOf("Documents");f.style.top=e*k+"px",Wu.app.SidePane._container.style.width="100%",Wu.DomUtil.addClass(i,"map-blur"),Wu.app.mobile&&this.mobileFullScreenAdjustment()}if("dataLibrary"==app._activeMenuItem){var k=app.SidePane.panes.indexOf("DataLibrary");f.style.top=e*k+"px",Wu.app.SidePane._container.style.width="100%",Wu.DomUtil.addClass(i,"map-blur"),Wu.app.mobile&&this.mobileFullScreenAdjustment()}if("mediaLibrary"==app._activeMenuItem){var k=app.SidePane.panes.indexOf("MediaLibrary");f.style.top=e*k+"px",Wu.app.SidePane._container.style.width="100%",Wu.DomUtil.addClass(i,"map-blur"),Wu.app.mobile&&this.mobileFullScreenAdjustment()}if("users"==app._activeMenuItem){var k=app.SidePane.panes.indexOf("Users");f.style.top=e*k+"px",Wu.app.SidePane._container.style.width="100%",Wu.DomUtil.addClass(i,"map-blur"),Wu.app.mobile&&this.mobileFullScreenAdjustment()}if("share"==app._activeMenuItem){var k=app.SidePane.panes.indexOf("Share");f.style.top=e*k+"px",Wu.app.SidePane._container.style.width="100%",Wu.DomUtil.removeClass(i,"map-blur")}for(var l,m,n=document.getElementsByTagName("menu")[0],o=n.getElementsByTagName("div"),p=0;p<o.length;p++)o[p]==a._menu&&(l=p),o[p]==this._menu&&(m=p);Wu.app._active&&Wu.DomUtil.removeClass(c,"show"),Wu.DomUtil.addClass(d,"show")}},updateContent:function(){},_addHook:function(a,b,c,d){Wu.DomEvent.on(a,b,c,d)},disable:function(){Wu.DomEvent.off(this._menu,"mousedown",this._clickActivate,this),Wu.DomUtil.addClass(this._menu,"disabled")},enable:function(){Wu.DomEvent.on(this._menu,"mousedown",this._clickActivate,this),Wu.DomUtil.removeClass(this._menu,"disabled")},remove:function(){delete this._menu,delete this._content,delete this},setContentHeight:function(){this.calculateHeight(),this._content.style.maxHeight=this.maxHeight+"px",this._scrollWrapper.style.maxHeight=parseInt(this.maxHeight-20)+"px"},calculateHeight:function(){var a=window.innerHeight,b=app.MapPane.legendsControl,c=-107+a;if(!b)return void(this.maxHeight=c-6);var d=parseInt(b._legendsHeight);c-=b._isOpen?d:6,this.maxHeight=c}}),Wu.SidePane.Clients=Wu.SidePane.Item.extend({_:"sidepane.clients",type:"clients",title:"Projects",initialize:function(){Wu.SidePane.Item.prototype.initialize.call(this),this.activate()},initContent:function(){this.clients=[],this._clientsContainer=Wu.DomUtil.create("div","editor-clients",this._container),this.options.json.clients.forEach(function(a){var b=new Wu.SidePane.Client(a);b.addTo(this._clientsContainer),this.clients.push(b)},this),app.Account.canCreateClient()&&this._insertNewClientButton(),app.Tooltip.add(this._menu,"Here is a list of clients and projects you have access to.")},_insertNewClientButton:function(){var a="smap-button-white new-client",b=this._newClientButton=Wu.DomUtil.create("div",a,this._clientsContainer,"+");b.id="new-client-button",this._addHook(b,"click",this.newClient,this),app.Tooltip.add(b,"Click to create new client")},addHooks:function(){Wu.SidePane.Item.prototype.addHooks.call(this)},_activate:function(){},_deactivate:function(){this.clients.forEach(function(a){a.close()},this)},_create:function(a){var b=new Wu.SidePane.Client(a);b.addTo(this._clientsContainer),this.clients.push(b)},openClient:function(){this._container.style.height=""},closeClient:function(){},remove:function(){var a=this,b="Are you sure you want to DELETE the client "+a.name+"?",c="Are you REALLY sure you want to DELETE the client "+a.name+"? This CANNOT be undone!";confirm(b)&&confirm(c)&&a._delete()},_createNew:function(){this.newClient()},newClient:function(){var a={clientName:"New client"};this._newClient={},this._newClient._wrapper=Wu.DomUtil.create("div","editor-clients-new-wrapper",this._clientsContainer),this._newClient._innerWrapper=Wu.DomUtil.create("div","editor-inner-wrapper editor-projects-container",this._newClient._wrapper),this._newClient._clientTitleWrapper=Wu.DomUtil.create("div","editor-client-title",this._newClient._innerWrapper),this._newClient._title=Wu.DomUtil.create("h5","",this._newClient._clientTitleWrapper,a.clientName),this._newClient._logo=Wu.DomUtil.create("img","",this._newClient._clientTitleWrapper),this._newClient._container=Wu.DomUtil.create("div","new-client-container",this._newClient._innerWrapper),this._newClient._NameLabel=Wu.DomUtil.create("label","",this._newClient._container,"Name:"),this._newClient._NameLabel.setAttribute("for","editor-client-name-new"),this._newClient._NameInput=Wu.DomUtil.create("input","form-control margined eightyWidth",this._newClient._container),this._newClient._NameInput.value=a.clientName,this._newClient._DescriptionLabel=Wu.DomUtil.create("label","",this._newClient._container,"Description:"),this._newClient._DescriptionLabel.setAttribute("for","editor-client-description-new"),this._newClient._DescriptionInput=Wu.DomUtil.create("input","form-control margined eightyWidth",this._newClient._container),this._newClient._keywordsLabel=Wu.DomUtil.create("label","",this._newClient._container,"Keywords:"),this._newClient._keywordsLabel.setAttribute("for","editor-client-keywords-new"),this._newClient._keywordsInput=Wu.DomUtil.create("input","form-control margined eightyWidth",this._newClient._container),this._newClient._confirmButton=Wu.DomUtil.create("div","smap-button-white small",this._newClient._innerWrapper,"Confirm"),this._newClient._cancelButton=Wu.DomUtil.create("div","smap-button-white small",this._newClient._innerWrapper,"Cancel"),Wu.DomUtil.remove(this._newClientButton),this._clientsContainer.appendChild(this._newClientButton);var b=this._newClient._confirmButton;this._addHook(b,"click",this._confirm,this);var b=this._newClient._cancelButton;this._addHook(b,"click",this._cancel,this);var c=this._newClient._NameInput;this._addHook(c,"keyup",this._checkSlug,this)},_checkSlug:function(){clearTimeout(this._timer);var a=this;this._timer=setTimeout(function(){var b=this._newClient._NameInput,c=Wu.Util.trimAll(b.value).toLowerCase(),d=JSON.stringify({slug:c}),e="/api/client/unique";Wu.Util.postcb(e,d,a._checkedSlug,a)},500)},_checkedSlug:function(a,b){var c=JSON.parse(b);return c.unique?a._enableConfirm():void(c.error||a._disableConfirm())},_disableConfirm:function(){var a=this._newClient._confirmButton;a.style.backgroundColor="red"},_enableConfirm:function(){var a=this._newClient._confirmButton;a.style.backgroundColor=""},_cancel:function(){var a=this._newClient._wrapper;Wu.DomUtil.remove(a)},_confirm:function(){var a=this._newClient._NameInput.value,b=this._newClient._DescriptionInput.value,c=this._newClient._keywordsInput,d={name:a,description:b,keywords:c},e=new Wu.Client(d);e.saveNew()},_created:function(a,b){var c=Wu.app.SidePane.Clients,d=JSON.parse(b);Wu.extend(a,d),Wu.app.Clients[a.uuid]=a;var e=this._newClient._wrapper;Wu.DomUtil.remove(e);var f=app.Account;f.addUpdateClient(a),c._create(a),a.setActive(),Wu.DomUtil.remove(c._newClientButton),c._clientsContainer.appendChild(c._newClientButton)},toggleEdit:function(a){a&&Wu.DomEvent.stop(a);var b=this,c=Wu.DomUtil.get("editor-client-edit-wrapper-"+b.uuid),d=Wu.DomUtil.get("editor-clients-container-"+b.uuid);b.options.editMode?(Wu.DomUtil.removeClass(d,"client-editor-open"),Wu.DomUtil.removeClass(c,"client-editor-open"),b.options.editMode=!1):(Wu.DomUtil.addClass(d,"client-editor-open"),Wu.DomUtil.addClass(c,"client-editor-open"),b.options.editMode=!0)},_addHook:function(a,b,c,d){Wu.DomEvent.on(a,b,c,d)},select:function(a){Wu.app._activeClient!=a&&(a.setActive(),Wu.app.activeProject&&Wu.app.activeProject.unload(),Wu.app.SidePane.Clients.refreshSidePane(),Wu.app.SidePane.setSubheaders())},refreshSidePane:function(){Wu.app.SidePane.refreshClient(),Wu.app.SidePane.Users.update()},_select:function(){var a=Wu.app.SidePane.Clients;a._previousSelect&&Wu.DomUtil.removeClass(a._previousSelect,"active-client"),Wu.DomUtil.addClass(this,"active-client"),a._previousSelect=this},selectProject:function(){var a=this;a.setActive()},disable:function(){},update:function(){}}),Wu.SidePane.Project=Wu.Class.extend({initialize:function(a,b){return Wu.setOptions(this,b),this.project=a,this.project.setEditMode(),this.project.setSidepane(this),this._parent=this.options.parent,this.initLayout(),this.update(),this},initLayout:function(){this._container=Wu.DomUtil.create("div","project-item"),this.name=Wu.DomUtil.create("div","project-title",this._container),this.name.type="name",this.description=Wu.DomUtil.create("div","project-description",this._container),this.description.type="description",this.logoContainer=Wu.DomUtil.create("div","project-logo-container",this._container),this.logo=Wu.DomUtil.create("img","project-logo",this.logoContainer),this.logo.type="logo",this.users=Wu.DomUtil.create("div","project-users-wrap",this._container),this.usersInnerWrapper=Wu.DomUtil.create("div","project-users-inner-wrapper",this._container),this.projectStatsHeader=Wu.DomUtil.create("div","project-stats",this.usersInnerWrapper),this.projectStatsHeader.innerHTML="Project status:",this.createdBy=Wu.DomUtil.create("div","project-createdby",this.usersInnerWrapper),this.createdDate=Wu.DomUtil.create("div","project-createddate",this.usersInnerWrapper),this.lastUpdated=Wu.DomUtil.create("div","project-lastupdated",this.usersInnerWrapper),this.usersInner=Wu.DomUtil.create("div","project-users",this.usersInnerWrapper);var a=app.Account.canDeleteProject(this.project.store.uuid);(a||this.options.editMode)&&(this.makeThumb=Wu.DomUtil.create("div","new-project-thumb",this.usersInnerWrapper,"Generate thumbnail"),this.kill=Wu.DomUtil.create("div","project-delete",this.usersInnerWrapper,"Delete project")),this.hookThumb(),this.addHooks()},hookThumb:function(){this.project._sidePaneLogoContainer=this.logo},expandUsers:function(){},collapseUsers:function(){},update:function(a){this.project=a||this.project,this.name.innerHTML=this.project.store.name,this.description.innerHTML=this.project.store.description;var b=this.project.store.logo?this.project.store.logo:"/css/images/defaultProjectLogo.png";this.logo.src=b,this.createdBy.innerHTML='<div class="project-info-left">Created by:</div><div class="project-info-right">'+this.project.store.createdByName+"</div>",this.lastUpdated.innerHTML='<div class="project-info-left">Last updated:</div><div class="project-info-right">'+Wu.Util.prettyDate(this.project.store.lastUpdated)+"</div>",this.createdDate.innerHTML='<div class="project-info-left">Created time:</div><div class="project-info-right">'+Wu.Util.prettyDate(this.project.store.created)+"</div>",this.usersInner.innerHTML='<div class="project-users-header">Project users:</div>'+this.project.getUsersHTML()},addHooks:function(){Wu.DomEvent.on(this._container,"click",this.select,this),Wu.DomEvent.on(this._container,"mousedown",Wu.DomEvent.stopPropagation,this),this.project.editMode&&this.addEditHooks(),Wu.DomEvent.on(this.users,"mousedown",this.toggleProjectInfo,this),Wu.DomEvent.on(this.users,"click mousedown",Wu.DomEvent.stopPropagation,this)},toggleProjectInfo:function(){var a=this._parent._container.offsetHeight,b=this.usersInnerWrapper.offsetHeight;this.project._menuItem._isOpen?(Wu.DomUtil.removeClass(this.users,"active-project-user-button"),this._container.style.height="111px",this._parent._container.style.height=a-b+"px",this.project._menuItem._isOpen=!1):(Wu.DomUtil.addClass(this.users,"active-project-user-button"),this._container.style.height=b+110+"px",this._parent._container.style.height=a+b+"px",this.project._menuItem._isOpen=!0)},removeHooks:function(){Wu.DomEvent.off(this._container,"click",this.select,this),Wu.DomEvent.off(this._container,"mousedown",Wu.DomEvent.stopPropagation,this),this.project.editMode&&this.removeEditHooks()},addEditHooks:function(){this.project.editMode&&(Wu.DomEvent.on(this.name,"dblclick",this.edit,this),Wu.DomEvent.on(this.description,"dblclick",this.editDescription,this),this.addLogoDZ(),app.Account.canDeleteProject(this.project.getUuid())&&(Wu.DomEvent.on(this.kill,"click",this.deleteProject,this),Wu.DomEvent.on(this.makeThumb,"click",this.makeNewThumbnail,this),Wu.DomEvent.on(this.makeThumb,"mousedown click",Wu.DomEvent.stopPropagation,this)))},removeEditHooks:function(){Wu.DomEvent.off(this.name,"dblclick",this.edit,this),Wu.DomEvent.off(this.description,"dblclick",this.editDescription,this),this.removeLogoDZ(),app.Account.canDeleteProject(this.project.getUuid())&&(Wu.DomEvent.off(this.kill,"click",this.deleteProject,this),Wu.DomEvent.off(this.makeThumb,"click",this.makeNewThumbnail,this),Wu.DomEvent.off(this.makeThumb,"mousedown click",Wu.DomEvent.stopPropagation,this))},makeNewThumbnail:function(){this.project.setThumbCreated(!0),this.project.createProjectThumb()},addLogoDZ:function(){this.logodz=new Dropzone(this.logo,{url:"/api/project/uploadlogo",createImageThumbnails:!1,autoDiscover:!1}),this.logodz.options.params.project=this.project.getUuid();var a=this;this.logodz.on("success",function(b,c){a.editedLogo(c)}),Wu.DomUtil.addClass(this.logo,"editable")},removeLogoDZ:function(){this.logodz&&this.logodz.disable(),delete this.logodz,Wu.DomUtil.removeClass(this.logo,"editable")},editedLogo:function(a){this.project.setThumbCreated(!0);var b="/images/"+a;this.project.setLogo(b),this.logo.src=this.project.getLogo(),app.HeaderPane.addedLogo(a)},addTo:function(a){return a.appendChild(this._container),this},addToBefore:function(a){var b=a.lastChild;a.insertBefore(this._container,b)},remove:function(){return Wu.DomUtil.remove(this._container),this},open:function(){},close:function(){},openInfo:function(){this.users.style.opacity=1},closeInfo:function(){this.users.style.opacity=0},select:function(){this.project!=app.activeProject&&(this.project.select(),app.StartPane.deactivate())},_markActive:function(){var a=app.Projects;for(p in a){var b=a[p];b._menuItem&&b._menuItem._unmarkActive()}Wu.DomUtil.addClass(this._container,"active-project")},_unmarkActive:function(){Wu.DomUtil.removeClass(this._container,"active-project")},edit:function(a){if(!this.editing){this.editing=!0;var b=a.target,c=(b.type,b.innerHTML),d=Wu.DomUtil.create("input","project-edit editable");d.value=c,d.setAttribute("maxLength","30"),b.innerHTML="",b.appendChild(d);var e=d;e.focus(),e.selectionStart=e.selectionEnd,Wu.DomEvent.on(e,"blur",this._editNameBlur,this),Wu.DomEvent.on(e,"keyup",this._editKeyName,this)}},_editNameBlur:function(a){var b=a.target.value;this._valid||(b+="_2");var c=a.target.parentNode;c.innerHTML=b,this.project.setSlug(b),this.project.setName(b),this.project.setHeaderTitle(b),app.HeaderPane.setTitle(b),this.editing=!1},editDescription:function(a){if(!this.editing){this.editing=!0;var b=a.target,c=(b.type,b.innerHTML);b.innerHTML="";var d=Wu.DomUtil.create("textarea","project-edit-textarea",b);d.innerHTML=c;var e=d;e.focus(),e.selectionStart=e.selectionEnd,Wu.DomEvent.on(e,"blur",this._editDescriptionBlur,this),Wu.DomEvent.on(e,"keydown",this._editKey,this)}},_editDescriptionBlur:function(a){var b=a.target.value,c=a.target.parentNode;c.innerHTML=b,this.project.setDescription(b),this.project.setHeaderSubtitle(b),app.HeaderPane.setSubtitle(b),this.editing=!1},_editKey:function(a){(13==event.which||13==event.keyCode)&&a.target.blur()},_editKeyName:function(a){(13==event.which||13==event.keyCode)&&a.target.blur();var b=a.target.value,c=this;b=b.replace(/\s+/g,""),this._checkUniqueSlug(b,function(b,d){var e=JSON.parse(d);e.unique?c._unique(a.target):c._notUnique(a.target)})},_unique:function(a){this._valid=!0,Wu.DomUtil.removeClass(a,"invalid")},_notUnique:function(a){this._valid=!1,Wu.DomUtil.addClass(a,"invalid")},_checkUniqueSlug:function(a,b){var c=JSON.stringify({value:a,project:this.project.getUuid(),client:this.project.getClient().getUuid()});Wu.post("/api/project/unique",c,b,this)},deleteProject:function(a){Wu.DomEvent.stop(a);var b=confirm("Are you sure you want to delete project "+this.project.store.name+"?");if(b){var c=confirm("Are you REALLY sure you want to delete project "+this.project.store.name+"? You cannot UNDO this action!");c&&this.confirmDelete()}},confirmDelete:function(){this.removeHooks(),this._parent.removeProject(this.project),Wu.DomUtil.remove(this._container),this.project==app.activeProject&&(this.project.unload(),setTimeout(function(){app.StartPane.activate()},200),app.StatusPane.close()),this.project._delete(),delete this}}),Wu.SidePane.Client=Wu.Class.extend({initialize:function(a){return this.client=app.Clients[a.uuid],this.editable=app.Account.canCreateClient(),this.initLayout(),this.update(),this},initLayout:function(){this._container=Wu.DomUtil.create("div","editor-clients-container"),this.title=Wu.DomUtil.create("div","client-title",this._container),this.description=Wu.DomUtil.create("div","client-description",this._container),this.logoContainer=Wu.DomUtil.create("div","client-logo-container",this._container),this.logo=Wu.DomUtil.create("img","client-logo",this.logoContainer),this._projectsContainer=Wu.DomUtil.create("div","projects-container",this._container)},addTo:function(a){return a.appendChild(this._container),this.addHooks(),this.editable&&this.addEditHooks(),this},remove:function(){return Wu.DomUtil.remove(this._container),this},update:function(){if(this.title.innerHTML=this.client.getName(),this.description.innerHTML=this.client.getDescription(),this.client.getLogo())var a=this.client.getLogo();else var a="/css/images/defaultProjectLogo.png";this.logo.src=a,Wu.DomUtil.thumbAdjust(this.logo,70),this.insertProjects()},insertProjects:function(){var a=this.client;return this.projects=_.filter(Wu.app.Projects,function(b){return b.store.client==a.getUuid()}),this.projects?(this.projects=_.sortBy(this.projects,function(a){return a.store.lastUpdated}),this.projects.reverse(),this.projects.forEach(function(a){var b={parent:this},c=new Wu.SidePane.Project(a,b);c.addTo(this._projectsContainer)},this),this.editButtons(),void this.calculateHeight()):this.editButtons()},editButtons:function(){if(this._newProjectButton&&Wu.DomUtil.remove(this._newProjectButton),this._removeClientButton&&Wu.DomUtil.remove(this._removeClientButton),app.Account.canCreateProject()){var a="smap-button-white new-project-button";this._newProjectButton=Wu.DomUtil.create("div",a,this._projectsContainer,"+"),Wu.DomEvent.on(this._newProjectButton,"mousedown",this.createNewProject,this),Wu.DomEvent.on(this._newProjectButton,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(this._newProjectButton,"click",Wu.DomEvent.stop,this),app.Tooltip.add(this._newProjectButton,"Click to create new project.")}app.Account.canDeleteClient(this.client.uuid)&&(this._removeClientButton=Wu.DomUtil.create("div","client-kill displayNone",this._container,"Delete client"),Wu.DomEvent.on(this._removeClientButton,"mousedown",this.removeClient,this))},removeClient:function(){var a=this.projects.length;if(a>0)return alert("The client "+this.client.getName()+" has "+a+" projects. You must delete these individually first before deleting client.");var b=confirm("Are you sure you want to delete client "+this.client.getName()+"?");if(b){var c=confirm("Are you REALLY sure you want to delete client "+this.client.getName()+"? You cannot UNDO this action!");c&&this.confirmDeleteClient()}},confirmDeleteClient:function(){Wu.DomUtil.remove(this._container),this.client.destroy()},_lockNewProjectButton:function(){Wu.DomEvent.off(this._newProjectButton,"mousedown",this.createNewProject,this),Wu.DomUtil.addClass(this._newProjectButton,"inactive")},_unlockNewProjectButton:function(){Wu.DomEvent.on(this._newProjectButton,"mousedown",this.createNewProject,this),Wu.DomUtil.removeClass(this._newProjectButton,"inactive")},createNewProject:function(){app.setStatus("Loading..."),this._lockNewProjectButton();var a={name:"Project title",description:"Project description",created:(new Date).toJSON(),lastUpdated:(new Date).toJSON(),createdByName:app.Account.getName(),keywords:"",client:this.client.uuid,position:{},bounds:{northEast:{lat:0,lng:0},southWest:{lat:0,lng:0},minZoom:1,maxZoom:22},header:{height:50},folders:[]},b=new Wu.Project(a);b.editMode=!0;var c={callback:this._projectCreated,context:this};b._saveNew(c)},_markActive:function(a){var b=app.Projects;for(p in b){var c=b[p];c._menuItem&&c._menuItem._unmarkActive()}Wu.DomUtil.addClass(a._menuItem._container,"active-project")},_unmarkActive:function(){Wu.DomUtil.removeClass(this._container,"active-project")},_projectCreated:function(a,b){var c=JSON.parse(b),d=c.error,e=c.project;return d?void 0:(app.Projects[e.uuid]=a,a.setNewStore(e),a.addAccess(),void this._createNewProject(a))},_createNewProject:function(a){this.projects.push(a);var b=new Wu.SidePane.Project(a,{parent:this});b.addToBefore(this._projectsContainer),this.open(),b.project._menuItem.select(),app.setStatus("Done!"),this._unlockNewProjectButton(),app.StartPane.deactivate(),this._addDefaults(),a.createProjectThumb(),this._markActive(a)},_addDefaults:function(){app.SidePane&&app.SidePane.Map&&app.SidePane.Map.mapSettings&&app.SidePane.Map.mapSettings.baselayer&&app.SidePane.Map.mapSettings.baselayer.setDefaultLayer()},addHooks:function(){Wu.DomEvent.on(this._container,"mousedown",this.toggle,this)},removeHooks:function(){Wu.DomEvent.off(this._container,"mousedown",this.toggle,this)},addEditHooks:function(){Wu.DomEvent.on(this.title,"dblclick",this.editName,this),Wu.DomEvent.on(this.description,"dblclick",this.editDescription,this),this.addLogoDZ()},removeEditHooks:function(){Wu.DomEvent.off(this.title,"dblclick",this.editName,this),Wu.DomEvent.off(this.description,"dblclick",this.editDescription,this),this.removeLogoDZ()},editName:function(){if(!this.editing){this.editing=!0;var a=this.title,b=a.innerHTML,c=Wu.DomUtil.create("input","client-edit editable");c.value=b,a.innerHTML="",a.appendChild(c);var d=c;d.focus(),d.selectionStart=d.selectionEnd,Wu.DomEvent.on(d,"blur",this.editedName,this),Wu.DomEvent.on(d,"keydown",this.editKeyed,this)}},editedName:function(a){var b=a.target,c=b.value,d=this.title;d.innerHTML=c,this.client.setName(c),Wu.DomEvent.off(b,"blur",this.editedName,this),Wu.DomEvent.off(b,"keydown",this.editKeyed,this),this.editing=!1},editKeyed:function(a){(13==event.which||13==event.keyCode)&&a.target.blur()},editDescription:function(){if(!this.editing){this.editing=!0;var a=this.description,b=a.innerHTML;a.innerHTML=ich.injectClientEditInput({value:b});var c=a.firstChild;c.focus(),c.selectionStart=c.selectionEnd,Wu.DomEvent.on(c,"blur",this.editedDescription,this),Wu.DomEvent.on(c,"keydown",this.editKeyed,this)}},editedDescription:function(a){var b=a.target,c=b.value,d=this.description;d.innerHTML=c,this.client.setDescription(c),Wu.DomEvent.off(b,"blur",this.editedDescription,this),Wu.DomEvent.off(b,"keydown",this.editKeyed,this),this.editing=!1},addLogoDZ:function(){this.logodz=new Dropzone(this.logo,{url:"/api/client/uploadlogo",createImageThumbnails:!1,autoDiscover:!1}),this.logodz.options.params.client=this.client.getUuid();var a=this;this.logodz.on("success",function(b,c){a.editedLogo(c)}),Wu.DomUtil.addClass(this.logo,"editable")},removeLogoDZ:function(){this.logodz&&this.logodz.disable(),delete this.logodz,Wu.DomUtil.removeClass(this.logo,"editable")},editedLogo:function(a){var b="/images/"+a;this.client.setLogo(b),this.logo.src=b},pendingOpen:function(){if(app._timerOpenClient&&clearTimeout(app._timerOpenClient),!this._isOpen){var a=this;app._timerOpenClient=setTimeout(function(){a.open(),app._pendingCloseClient&&app._pendingCloseClient.close(),app._pendingCloseClient=a},200)}},toggle:function(){this._isOpen?this.close():this.open()},open:function(){this.resetOpenProjectInfo(),this.calculateHeight(),this._container.style.height=this.maxHeight+"px",this._isOpen=!0,Wu.DomUtil.removeClass(this._removeClientButton,"displayNone");var a=app.SidePane.Clients;a._lastOpened&&a._lastOpened!=this&&a._lastOpened.close(),a._lastOpened=this},close:function(){this.calculateHeight(),this._container.style.height=this.minHeight+"px",this._isOpen=!1,Wu.DomUtil.addClass(this._removeClientButton,"displayNone"),this.resetOpenProjectInfo()},resetOpenProjectInfo:function(){this.projects.forEach(function(a){Wu.DomUtil.removeClass(a._menuItem.users,"active-project-user-button"),a._menuItem._container.removeAttribute("style"),a._menuItem._isOpen&&(a._menuItem._isOpen=!1)})},removeProject:function(a){_.remove(this.projects,function(b){return b.store.uuid==a.store.uuid}),this.calculateHeight(),this.open()},calculateHeight:function(){if(Wu.app.mobile){var a=78;this.maxHeight=a+100*_.size(this.projects),this.minHeight=68}else{var a=150;this.maxHeight=a+116*_.size(this.projects),this.minHeight=80}}}),Wu.SidePane.Users=Wu.SidePane.Item.extend({_:"sidepane.users",type:"users",title:"Users",initContent:function(){this._content=Wu.DomUtil.create("div","fullpage-users",Wu.app._appPane),this._usersControls=Wu.DomUtil.create("div","users-controls",this._content),this._usersControlsInner=Wu.DomUtil.create("div","users-controls-inner",this._usersControls),this._addUser=Wu.DomUtil.create("div","users-add-user smap-button-gray users",this._usersControlsInner,"Create user"),this._deleteUser=Wu.DomUtil.create("div","users-delete-user smap-button-gray users",this._usersControlsInner,"Delete user"),this._search=Wu.DomUtil.createId("input","users-search",this._usersControlsInner),this._search.setAttribute("type","text"),this._search.setAttribute("placeholder","Search users"),Wu.DomUtil.addClass(this._search,"search"),this._container=Wu.DomUtil.create("div","editor-wrapper",this._content),this._userList=Wu.DomUtil.create("div","userlist",this._container),this._mainTitle=Wu.DomUtil.create("h4","user-management-client",this._userList),this._tableContainer=Wu.DomUtil.create("div","users-table-container",this._userList),this._uList=Wu.DomUtil.createId("div","userslist",this._tableContainer);var a=Wu.DomUtil.create("table","users-table",this._uList),b=Wu.DomUtil.create("thead","",a),c=Wu.DomUtil.create("tr","",b),d=Wu.DomUtil.create("th","fivep",c);d.setAttribute("data-sort","checkbox");var e=Wu.DomUtil.create("div","squaredThree users-squaredThree-checkbox-all",d);this._checkall=Wu.DomUtil.create("input","users-checkbox-all",e),this._checkall.setAttribute("type","checkbox"),this._checkall.setAttribute("name","check"),this._checkall.setAttribute("value","None"),this._checkallLabel=Wu.DomUtil.create("label","label-users-checkbox-all",d),this._checkallLabel.setAttribute("for","users-checkbox-all");var f=Wu.DomUtil.create("th","sort name thirtyp",c,"Name");f.setAttribute("data-sort","name"),f.setAttribute("data-insensitive","true");var g=Wu.DomUtil.create("th","sort company",c,"Company");g.setAttribute("data-sort","company"),g.setAttribute("data-insensitive","true");var h=Wu.DomUtil.create("th","sort position",c,"Position");h.setAttribute("data-sort","position"),h.setAttribute("data-insensitive","true");var i=Wu.DomUtil.create("th","sort phone",c,"Phone");i.setAttribute("data-sort","phone"),i.setAttribute("data-insensitive","true");var j=Wu.DomUtil.create("th","sort email",c,"Email");j.setAttribute("data-sort","email"),j.setAttribute("data-insensitive","true");var k=Wu.DomUtil.create("th","sort projects",c,"Access");k.setAttribute("data-sort","projects"),k.setAttribute("data-insensitive","true"),this._table=Wu.DomUtil.createId("tbody","users-insertrows",a),this._table.className="list",this.initList(),app.Tooltip.add(this._menu,"(Editors only) List of all users. Here you can create and delete users, as well as administer user access to projects.")},addHooks:function(){Wu.DomEvent.on(this._search,"keyup",this.searchList,this)},addEditHooks:function(){Wu.DomEvent.on(this._addUser,"mousedown",this.inputUser,this),Wu.DomEvent.on(this._deleteUser,"mousedown",this.deleteUser,this),Wu.DomEvent.on(this._checkallLabel,"mousedown",this.checkAll,this),Wu.DomUtil.removeClass(this._addUser,"displayNone"),Wu.DomUtil.removeClass(this._deleteUser,"displayNone"),Wu.DomUtil.removeClass(this._addUser,"displayNone")},removeEditHooks:function(){Wu.DomEvent.off(this._addUser,"mousedown",this.inputUser,this),Wu.DomEvent.off(this._deleteUser,"mousedown",this.deleteUser,this),Wu.DomEvent.off(this._checkallLabel,"mousedown",this.checkAll,this),Wu.DomUtil.addClass(this._addUser,"displayNone"),Wu.DomUtil.addClass(this._deleteUser,"displayNone"),Wu.DomUtil.addClass(this._addUser,"displayNone")},_deactivate:function(){this._showControls()},_activate:function(){this._hideControls()},_hideControls:function(){var a=app.MapPane.layerMenu;a&&a.hide();var b=app.MapPane.inspectControl;b&&b.hide();var c=app.MapPane.legendsControl;c&&c.hide();var d=app.MapPane.descriptionControl;d&&d.hide()},_showControls:function(){var a=app.MapPane.layerMenu;a&&a.show();var b=app.MapPane.inspectControl;b&&b.show();var c=app.MapPane.legendsControl;c&&c.show();var d=app.MapPane.descriptionControl;d&&d.show()},searchList:function(a){if(27==a.keyCode)return this.list.search(),void(this._search.value="");var b=this._search.value;this.list.search(b)},initList:function(){var a=Wu.DomUtil.createId("tr","dummy-table-entry");this._table.appendChild(a);var b=Wu.DomUtil.create("td","checkbox",a),c=Wu.DomUtil.create("div","squaredThree",b),d=Wu.DomUtil.create("input","",c);d.setAttribute("type","checkbox"),d.setAttribute("value","None"),d.setAttribute("name","check");var e=(Wu.DomUtil.create("label","",c),Wu.DomUtil.create("td","name",a),Wu.DomUtil.create("td","tdcont company",a));e.setAttribute("key","company"),e.setAttribute("id","company-"),e.setAttribute("uuid","");var f=Wu.DomUtil.create("td","tdcont position",a);f.setAttribute("key","position"),f.setAttribute("id","position-"),f.setAttribute("uuid","");var g=Wu.DomUtil.create("td","tdcont phone",a);g.setAttribute("key","phone"),g.setAttribute("id","phone-"),g.setAttribute("uuid","");var h=Wu.DomUtil.create("td","tdcont email",a);h.setAttribute("key","email"),h.setAttribute("id","email-"),h.setAttribute("uuid","");var i=Wu.DomUtil.create("td","tdcont access",a);i.setAttribute("key","access"),i.setAttribute("id","access-"),i.setAttribute("uuid","");var j=Wu.DomUtil.create("td","tdcont uuid",a);j.style.display="none";var k={valueNames:["name","company","position","phone","email","access"]};this.list=new List("userslist",k),this.list.clear()},updateContent:function(){this.update()},update:function(){this.reset(),this.refreshTable(),this.addEditHooks()},inputUser:function(){Wu.DomUtil.addClass(this._content,"hide-top",this),this._inputUser={};var a="Create new user",b="Enter details for the new user:",c="Password is auto-generated. The user will receive login details on email.",d=this._inputUser._container=Wu.DomUtil.create("div","backpane-container",this._content),e=this._inputUser._wrapper=Wu.DomUtil.create("div","backpane-wrapper",d),f=(this._inputUser._title=Wu.DomUtil.create("div","backpane-title",e,a),this._inputUser._subtitle=Wu.DomUtil.create("div","backpane-subtitle",e,b),this._inputUser._firstName=Wu.DomUtil.create("input","backpane-input",e,"First Name"),this._inputUser._lastName=Wu.DomUtil.create("input","backpane-input",e,"Last Name"),this._inputUser._companyName=Wu.DomUtil.create("input","backpane-input",e,"Company Name"),this._inputUser._position=Wu.DomUtil.create("input","backpane-input",e,"Position"),this._inputUser._phoneNo=Wu.DomUtil.create("input","backpane-input",e,"Phone Number"),this._inputUser._email=Wu.DomUtil.create("input","backpane-input",e,"Email")),g=this._inputUser._email2=Wu.DomUtil.create("input","backpane-input",e,"Confirm Email"),h=(this._inputUser._message=Wu.DomUtil.create("div","backpane-message",e,c),this._inputUser._cancel=Wu.DomUtil.create("div","backpane-cancel smap-button-gray",e,"Cancel")),i=this._inputUser._confirm=Wu.DomUtil.create("div","backpane-confirm smap-button-gray",e,"Confirm");
Wu.DomEvent.on(f,"keyup",this.checkUniqueEmail,this),Wu.DomEvent.on(g,"keyup",this.checkSameEmail,this),Wu.DomEvent.on(h,"mousedown",this.cancelInput,this),Wu.DomEvent.on(i,"mousedown",this.confirmInput,this),this._container.style.display="none"},checkUniqueEmail:function(){clearTimeout(this._checkUniqeEmailTimer);var a=this;this._checkUniqeEmailTimer=setTimeout(function(){var b=a._inputUser._email.value,c=JSON.stringify({email:b});Wu.Util.postcb("/api/user/unique",c,a.checkedUniqueEmail,a)},250)},checkedUniqueEmail:function(a,b){var c=JSON.parse(b),d=a._inputUser._email;c.unique?(Wu.DomUtil.addClass(d,"valid"),Wu.DomUtil.removeClass(d,"invalid"),a._inputUser.validEmail=!0):(Wu.DomUtil.addClass(d,"invalid"),Wu.DomUtil.removeClass(d,"valid"),a._inputUser.validEmail=!1)},checkSameEmail:function(){var a=this._inputUser._email,b=this._inputUser._email2;a.value==b.value?(Wu.DomUtil.addClass(b,"valid"),Wu.DomUtil.removeClass(b,"invalid"),this._inputUser.validEmail2=!0):(Wu.DomUtil.addClass(b,"invalid"),Wu.DomUtil.removeClass(b,"valid"),this._inputUser.validEmail2=!1)},cancelInput:function(){Wu.DomUtil.remove(this._inputUser._container),this._container.style.display="block",Wu.DomUtil.removeClass(this._content,"hide-top",this)},confirmInput:function(){var a=this._inputUser._firstName.value,b=this._inputUser._lastName.value,c=this._inputUser._email.value,d=this._inputUser._companyName.value,e=this._inputUser._position.value,f=this._inputUser._phoneNo.value;if(a&&b&&c&&this._inputUser.validEmail2&&this._inputUser.validEmail){var g={lastName:b,firstName:a,email:c,company:d,position:e,phone:f};this.createUser(g),this.cancelInput(),this._container.style.display="block",Wu.DomUtil.removeClass(this._content,"hide-top",this)}},createUser:function(a){var b=JSON.stringify(a);b&&Wu.post("/api/user/new",b,this.createdUser,this)},createdUser:function(a,b){var c=JSON.parse(b),d=new Wu.User(c);d.attachToApp(),a.addTableItem(d)},deleteUser:function(){var a=this.getSelected(),b=Wu.app.Account.store.uuid,c=!1;return a.forEach(function(a){a.uuid==b&&(c=!0)}),c?void 0:void a.forEach(function(a){var b=a.store.firstName+" "+a.store.lastName;confirm("Are you sure you want to delete user "+b+"?")&&confirm("Are you REALLY SURE you want to delete user "+b+"?")&&this.confirmDelete(a)},this)},confirmDelete:function(a){a.deleteUser(this,"deletedUser")},deletedUser:function(a){a.reset(),a.refreshTable()},checkAll:function(){},getSelected:function(){var a=[];for(u in this.users){var b=this.users[u],c=Wu.DomUtil.get("users-checkbox-"+b.store.uuid);if(c)var d=c.checked;d&&a.push(b)}return a},refreshTable:function(){this.users=app.Users;for(u in this.users){var a=this.users[u];this.addTableItem(a)}this.list.sort("name",{order:"asc"})},reset:function(){this.list.clear()},addTableItem:function(a){var b={},c={firstName:a.getFirstName()||"First name",lastName:a.getLastName()||"Last name",lastNameUuid:"lastName-"+a.getUuid(),firstNameUuid:"firstName-"+a.getUuid()},d='<input value="'+c.lastName+'" id="'+c.lastNameUuid+'" class="dln" readonly="readonly">',e='<input value="'+c.firstName+'" id="'+c.firstNameUuid+'" class="dln smallerText" readonly="readonly">';b.name=d+e,b.email=a.getEmail(),b.position=a.getPosition(),b.company=a.getCompany(),b.mobile=a.getMobile(),b.phone=a.getPhone(),b.access=this.getAccessTemplate(a);for(var f=this.list.add(b),g=f[0].elm.children,h=0;h<g.length;h++){var i=g[h];0==h&&(i.children[0].children[0].id="users-checkbox-"+a.getUuid(),i.children[0].children[1].setAttribute("for","users-checkbox-"+a.getUuid())),""==!i.id&&(i.id=i.id+a.getUuid(),i.setAttribute("uuid",a.getUuid()))}this.setEditHooks(a.getUuid())},getAccessTemplate:function(a){var b='<div class="user-projects-button">',c="</div>",d=a.getProjects();return d.length>1?b+d.length+" projects"+c:b+d.length+" project"+c},getProjectsTemplate:function(a){var b="";if(a.isSuperuser()){for(p in app.Projects){var c=app.Projects[p];if(!c)return;content={name:c.store.name,description:c.store.description,uuid:c.store.uuid},b+='<div class="users-table-project-item" title="'+content.description+'" >'+content.name+"</div>"}return b}var d=a.getProjects();return d&&0!=d.length?(d.forEach(function(a){var c=app.Projects[a];c&&(content={name:c.store.name,description:c.store.description,uuid:c.store.uuid},b+='<div class="users-table-project-item" title="'+content.description+'" >'+content.name+"</div>")},this),b):b},checkEscape:function(a){27==a.keyCode&&this._popupCancel()},setEditHooks:function(a,b){var b=b||"on",c=Wu.DomUtil.get("lastName-"+a),d=Wu.DomUtil.get("firstName-"+a),e=Wu.DomUtil.get("company-"+a),f=Wu.DomUtil.get("position-"+a),g=Wu.DomUtil.get("phone-"+a),h=Wu.DomUtil.get("email-"+a),i=Wu.DomUtil.get("access-"+a);Wu.DomEvent[b](c,"mousedown mouseup click",this.stop,this)[b](c,"dblclick",this.rename,this)[b](d,"mousedown mouseup click",this.stop,this)[b](d,"dblclick",this.rename,this)[b](e,"mousedown mouseup click",this.stop,this)[b](e,"dblclick",this._rename,this)[b](f,"mousedown mouseup click",this.stop,this)[b](f,"dblclick",this._rename,this)[b](g,"mousedown mouseup click",this.stop,this)[b](g,"dblclick",this._rename,this)[b](h,"mousedown mouseup click",this.stop,this)[b](i,"click",function(){this.editAccess(a)},this)},editAccess:function(a){var b=app.Users[a];this.manageAccess(b),Wu.DomUtil.addClass(this._content,"hide-top",this)},manageAccess:function(a){var b="Manage access for "+a.getName(),c="Manage read, write and manage access for this user.",d=a.isSuperadmin()?"green":"red",e=a.isAdmin()?"green":"red";this._inputAccess={};var f=this._inputAccess._container=Wu.DomUtil.create("div","backpane-access-container",this._content),g=this._inputAccess._wrapper=Wu.DomUtil.create("div","backpane-access-wrapper",f),h=(this._inputAccess._title=Wu.DomUtil.create("div","backpane-title",g,b),this._inputAccess._subtitle=Wu.DomUtil.create("div","backpane-subtitle",g,c),this._inputAccess._superadmin=Wu.DomUtil.create("div","backpane-superadmin-box "+d,g,"Superadmin"),this._inputAccess._admin=Wu.DomUtil.create("div","backpane-admin-box "+e,g,"Admin"),this._inputAccess._projectTitle=Wu.DomUtil.create("div","backpane-projectTitle",g,"Projects:"),this._inputAccess._projectsWrap=this.insertProjectWrap(a),this._inputAccess._confirm=Wu.DomUtil.create("div","backpane-confirm smap-button-gray",g,"Done"));Wu.DomEvent.on(h,"mousedown",this.closeManageAccess,this),this._container.style.display="none"},closeManageAccess:function(){Wu.DomUtil.remove(this._inputAccess._container),this._container.style.display="block",this.update(),Wu.DomUtil.removeClass(this._content,"hide-top",this)},insertProjectWrap:function(a){var b=Wu.DomUtil.create("div","backpane-projects-wrap",this._inputAccess._wrapper),c=this._getProjectAccessSchema();return 0!=c.length?(c.forEach(function(c){c&&this._createManageEntry(a,c,b)},this),b):void 0},_createManageEntry:function(a,b,c){var d,e,f=app.Account.isAdmin()||app.Account.isSuperadmin(),g=app.Account.isSuperadmin(),h=b.getName(),i=b.getClient(),j=i?i.getName():"DELETED CLIENT!",k=a.canReadProject(b.getUuid())?"gotAccess":"",l=a.canUpdateProject(b.getUuid())?"gotAccess":"",m=a.canManageProject(b.getUuid())?"gotAccess":"",n=h+" ("+j+")",o=Wu.DomUtil.create("div","access-projects-wrap",c),p=Wu.DomUtil.create("div","access-projects-details-wrap",o),q=(Wu.DomUtil.create("div","access-projects-title",p,n),Wu.DomUtil.create("div","access-projects-description",p,b.getDescription()),Wu.DomUtil.create("div","access-projects-read "+k,o,"Read"));g&&(d=Wu.DomUtil.create("div","access-projects-write "+l,o,"Edit")),f&&(e=Wu.DomUtil.create("div","access-projects-manage "+m,o,"Manage"));var r={user:a,project:b,read:q,edit:d,manage:e};Wu.DomEvent.on(q,"mousedown",function(){this.toggleReadAccess(r)},this),g&&Wu.DomEvent.on(d,"mousedown",function(){this.toggleUpdateAccess(r)},this),f&&Wu.DomEvent.on(e,"mousedown",function(){this.toggleManageAccess(r)},this)},toggleReadAccess:function(a){var b=a.user,c=b.store.role.reader.projects.indexOf(a.project.getUuid())>=0?!0:!1;c?this._removeRead(a):this._addRead(a)},_removeRead:function(a){a.user.removeReadProject(a.project),Wu.DomUtil.removeClass(a.read,"gotAccess"),this._removeUpdate(a),this._removeManage(a)},_addRead:function(a){a.user.addReadProject(a.project),Wu.DomUtil.addClass(a.read,"gotAccess")},_removeUpdate:function(a){a.user.removeUpdateProject(a.project),Wu.DomUtil.removeClass(a.edit,"gotAccess")},_addUpdate:function(a){a.user.addUpdateProject(a.project),Wu.DomUtil.addClass(a.edit,"gotAccess"),this._addRead(a)},_removeManage:function(a){a.user.removeManageProject(a.project),Wu.DomUtil.removeClass(a.manage,"gotAccess")},_addManage:function(a){a.user.addManageProject(a.project),Wu.DomUtil.addClass(a.manage,"gotAccess"),this._addRead(a)},toggleUpdateAccess:function(a){var b=a.user,c=b.store.role.editor.projects.indexOf(a.project.getUuid())>=0?!0:!1;c?this._removeUpdate(a):this._addUpdate(a)},toggleManageAccess:function(a){var b=a.user,c=b.store.role.manager.projects.indexOf(a.project.getUuid())>=0?!0:!1;c?this._removeManage(a):this._addManage(a)},_getProjectAccessSchema:function(){var a=[];return app.Account.store.role.manager.projects.forEach(function(b){a.push(app.Projects[b])},this),_.toArray(a)},stop:function(a){a.preventDefault(),a.stopPropagation()},rename:function(a){a.target.removeAttribute("readonly"),a.target.focus(),a.target.selectionStart=a.target.selectionEnd,a.target.fieldKey=a.target.id.split("-")[0],Wu.DomEvent.on(a.target,"blur",this.editBlur,this),Wu.DomEvent.on(a.target,"keydown",this.editKey,this)},editKey:function(a){(13==event.which||13==event.keyCode)&&a.target.blur()},editBlur:function(a){var b=a.target.fieldKey;a.target.setAttribute("readonly","readonly");var c=a.target.id.replace(b+"-",""),d=a.target.value||a.target.innerHTML;this.save(b,d,c)},_rename:function(a){var b=a.target,c=a.target.innerHTML,d=a.target.getAttribute("key"),e=a.target.getAttribute("uuid"),f={value:c,key:d,uuid:e};b.innerHTML="";var g=Wu.DomUtil.create("input","inject-input",b);g.setAttribute("key",f.key),g.setAttribute("value",f.value),g.setAttribute("uuid",f.uuid);var h=b.firstChild;h.focus(),h.selectionStart=h.selectionEnd,Wu.DomEvent.on(h,"blur",this._editBlur,this),Wu.DomEvent.on(h,"keydown",this._editKey,this)},_editKey:function(a){(13==event.which||13==event.keyCode)&&a.target.blur()},_editBlur:function(a){var b=a.target.value,c=a.target.getAttribute("key"),d=a.target.getAttribute("uuid"),e=a.target.parentNode;e.innerHTML=b,this.list.update(),this.save(c,b,d)},save:function(a,b,c){var d=app.Users[c];d.setKey(a,b)}}),Wu.SidePane.Map=Wu.SidePane.Item.extend({_:"sidepane.map",type:"map",title:"Options",initContent:function(){this.app=Wu.app,this.buildHTML(),this._settingsContainer=Wu.DomUtil.get("mapsettings-container"),this._panes={},this.mapSettings={},this.mapSettings.baselayer=new Wu.SidePane.Map.BaseLayers,this.mapSettings.layermenu=new Wu.SidePane.Map.LayerMenu,this.mapSettings.position=new Wu.SidePane.Map.Position,this.mapSettings.bounds=new Wu.SidePane.Map.Bounds,this.mapSettings.controls=new Wu.SidePane.Map.Controls,this.mapSettings.connect=new Wu.SidePane.Map.Connect(this._settingsContainer),this.mapSettings.settings=new Wu.SidePane.Map.Settings(this._settingsContainer),app.Tooltip.add(this._menu,"(Editors only) In this section you will find all the options for setting up a map.")},buildHTML:function(){this._HTML={};var a=this._HTML;a._mapSettingsContainer=Wu.DomUtil.makeit({type:"div",id:"mapsettings-container",appendto:this._container}),a._baseLayerWrap=Wu.DomUtil.makeit({type:"div",id:"editor-map-baselayer-wrap",cname:"editor-inner-wrapper editor-map-item-wrap",appendto:a._mapSettingsContainer}),a._baseLayerH4=Wu.DomUtil.makeit({type:"h4",inner:"Base Layers",appendto:a._baseLayerWrap}),a._layerMenuWrap=Wu.DomUtil.makeit({type:"div",id:"editor-map-layermenu-wrap",cname:"editor-inner-wrapper editor-map-item-wrap",appendto:a._mapSettingsContainer}),a._layerMenuH4=Wu.DomUtil.makeit({type:"h4",inner:"Layermenu",appendto:a._layerMenuWrap}),a._layerMenu=Wu.DomUtil.makeit({type:"div",id:"editor-map-layermenu",appendto:a._layerMenuWrap}),a._layerMenuInner=Wu.DomUtil.makeit({type:"div",id:"map-layermenu-inner",cname:"initheight",appendto:a._layerMenu}),a._mapPositionWrap=Wu.DomUtil.makeit({type:"div",id:"editor-map-position-wrap",cname:"editor-inner-wrapper editor-map-item-wrap",appendto:a._mapSettingsContainer}),a._mapPositionH4=Wu.DomUtil.makeit({type:"h4",inner:"Position",appendto:a._mapPositionWrap}),a._initPosCoord=Wu.DomUtil.makeit({type:"div",id:"editor-map-initpos-coordinates",appendto:a._mapPositionWrap}),a._initPosInner=Wu.DomUtil.makeit({type:"div",id:"map-initpos-inner",cname:"initheight",appendto:a._initPosCoord}),a._setCurrentPost=Wu.DomUtil.makeit({type:"button",id:"editor-map-initpos-button",cname:"smap-button-white",inner:"Set current position",appendto:a._initPosInner,attr:[["type","button"]]}),a._latLabel=Wu.DomUtil.makeit({type:"label",inner:"Latitude:",appendto:a._initPosInner,attr:[["for","editor-map-initpos-lat-value"]]}),a._latInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-initpos-lat-value",appendto:a._initPosInner}),a._lngLabel=Wu.DomUtil.makeit({type:"label",inner:"Longitude:",appendto:a._initPosInner,attr:[["for","editor-map-initpos-lng-value"]]}),a._lngInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-initpos-lng-value",appendto:a._initPosInner}),a._zoomLabel=Wu.DomUtil.makeit({type:"label",inner:"Zoom-level:",appendto:a._initPosInner,attr:[["for","editor-map-initpos-zoom-value"]]}),a._zoomInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-initpos-zoom-value",appendto:a._initPosInner}),a._boundsWrapper=Wu.DomUtil.makeit({type:"div",id:"editor-map-bounds-wrap",cname:"editor-inner-wrapper editor-map-item-wrap",appendto:a._mapSettingsContainer}),a._boundsH4=Wu.DomUtil.makeit({type:"h4",inner:"Bounds",appendto:a._boundsWrapper}),a._boundsCoords=Wu.DomUtil.makeit({type:"div",id:"editor-map-bounds-coordinates",appendto:a._boundsWrapper}),a._boundsInner=Wu.DomUtil.makeit({type:"div",id:"map-bounds-inner",cname:"initheight",appendto:a._boundsCoords}),a._setBoundsButton=Wu.DomUtil.makeit({type:"button",id:"editor-map-bounds",cname:"smap-button-white",inner:"Set all bounds",appendto:a._boundsInner,attr:[["type","button"]]}),a._clearBoundsButton=Wu.DomUtil.makeit({type:"button",id:"editor-map-bounds-clear",cname:"smap-button-white",inner:"Clear",appendto:a._boundsInner,attr:[["type","button"]]}),a._NEwrapper=Wu.DomUtil.makeit({type:"div",cname:"bounds-wrapper",appendto:a._boundsInner}),a._NEbutton=Wu.DomUtil.makeit({type:"button",id:"editor-map-bounds-NE",cname:"smap-button-white",inner:"Set North-East bounds",appendto:a._NEwrapper,attr:[["type","button"]]}),a._NElatInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-bounds-NE-lat-value",appendto:a._NEwrapper}),a._NElngInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-bounds-NE-lng-value",appendto:a._NEwrapper}),a._SWwrapper=Wu.DomUtil.makeit({type:"div",cname:"bounds-wrapper",appendto:a._boundsInner}),a._SWbutton=Wu.DomUtil.makeit({type:"button",id:"editor-map-bounds-SW",cname:"smap-button-white",inner:"Set South-West bounds",appendto:a._SWwrapper,attr:[["type","button"]]}),a._SWlatInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-bounds-SW-lat-value",appendto:a._SWwrapper}),a._SWlngInput=Wu.DomUtil.makeit({type:"input",cname:"form-control margined eightyWidth",id:"editor-map-bounds-SW-lng-value",appendto:a._SWwrapper}),a._zoomBounds=Wu.DomUtil.makeit({type:"div",cname:"bounds-wrapper zoom",appendto:a._boundsInner}),a._zoomBoundsLeft=Wu.DomUtil.makeit({type:"div",cname:"bounds-zoom-half left",appendto:a._zoomBounds}),a._zoomBoundsLeftHeader=Wu.DomUtil.makeit({type:"div",cname:"bounds-zoom-h2",inner:"Max Zoom",appendto:a._zoomBoundsLeft}),a._zoomBoundsLeftBtn=Wu.DomUtil.makeit({type:"button",id:"editor-map-bounds-set-maxZoom",cname:"smap-button-white",inner:"Set",appendto:a._zoomBoundsLeft,attr:[["type","button"]]}),a._zoomBoundsLeftInput=Wu.DomUtil.makeit({type:"input",id:"editor-map-bounds-max-zoom-value",cname:"form-control margined eightyWidth",appendto:a._zoomBoundsLeft}),a._zoomBoundsRight=Wu.DomUtil.makeit({type:"div",cname:"bounds-zoom-half left",appendto:a._zoomBounds}),a._zoomBoundsRightHeader=Wu.DomUtil.makeit({type:"div",cname:"bounds-zoom-h2",inner:"Min Zoom",appendto:a._zoomBoundsRight}),a._zoomBoundsRightBtn=Wu.DomUtil.makeit({type:"button",id:"editor-map-bounds-set-minZoom",cname:"smap-button-white",inner:"Set",appendto:a._zoomBoundsRight,attr:[["type","button"]]}),a._zoomBoundsRightInput=Wu.DomUtil.makeit({type:"input",id:"editor-map-bounds-min-zoom-value",cname:"form-control margined eightyWidth",appendto:a._zoomBoundsRight}),a._mapControlsWrap=Wu.DomUtil.makeit({type:"div",id:"editor-map-controls-wrap",cname:"editor-inner-wrapper editor-map-item-wrap",appendto:a._mapSettingsContainer}),a._controlsH4=Wu.DomUtil.makeit({type:"h4",inner:"Controls",appendto:a._mapControlsWrap}),a._controlsInner=Wu.DomUtil.makeit({type:"div",id:"editor-map-controls-inner-wrap",appendto:a._mapControlsWrap}),a._controlZoomWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlZoomTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-zoom",inner:"Zoom",appendto:a._controlZoomWrapper,attr:[["which","zoom"]]}),a._controlZoomSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlZoomWrapper}),a._controlZoomSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-zoom",appendto:a._controlZoomSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlZoomSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlZoomSwitch,attr:[["for","map-controls-zoom"]]}),a._controlDrawWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlDrawTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-draw",inner:"Draw",appendto:a._controlDrawWrapper,attr:[["which","draw"]]}),a._controlDrawSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlDrawWrapper}),a._controlDrawSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-draw",appendto:a._controlDrawSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlDrawSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlDrawSwitch,attr:[["for","map-controls-draw"]]}),a._controlInspectWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlInspectTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-inspect",inner:"Inspect layers",appendto:a._controlInspectWrapper,attr:[["which","inspect"]]}),a._controlInspectSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlInspectWrapper}),a._controlInspectSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-inspect",appendto:a._controlInspectSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlInspectSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlInspectSwitch,attr:[["for","map-controls-inspect"]]}),a._controlDescriptionWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlDescriptionTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-description",inner:"Description",appendto:a._controlDescriptionWrapper,attr:[["which","description"]]}),a._controlDescriptionSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlDescriptionWrapper}),a._controlDescriptionSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-description",appendto:a._controlDescriptionSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlDescriptionSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlDescriptionSwitch,attr:[["for","map-controls-description"]]}),a._controlLayermenuWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlLayermenuTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-layermenu",inner:"Layer menu",appendto:a._controlLayermenuWrapper,attr:[["which","layermenu"]]}),a._controlLayermenuSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlLayermenuWrapper}),a._controlLayermenuSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-layermenu",appendto:a._controlLayermenuSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlLayermenuSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlLayermenuSwitch,attr:[["for","map-controls-layermenu"]]}),a._controlLegendsWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlLegendsTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-legends",inner:"Legends",appendto:a._controlLegendsWrapper,attr:[["which","legends"]]}),a._controlLegendsSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlLegendsWrapper}),a._controlLegendsSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-legends",appendto:a._controlLegendsSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlLegendsSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlLegendsSwitch,attr:[["for","map-controls-legends"]]}),a._controlMeasureWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlMeasureTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-measure",inner:"Scale",appendto:a._controlMeasureWrapper,attr:[["which","measure"]]}),a._controlMeasureSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlMeasureWrapper}),a._controlMeasureSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-measure",appendto:a._controlMeasureSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlMeasureSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlMeasureSwitch,attr:[["for","map-controls-measure"]]}),a._controlGeoWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlGeoTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-geolocation",inner:"Geolocation",appendto:a._controlGeoWrapper,attr:[["which","geolocation"]]}),a._controlGeoSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlGeoWrapper}),a._controlGeoSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-geolocation",appendto:a._controlGeoSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlGeoSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlGeoSwitch,attr:[["for","map-controls-geolocation"]]}),a._controlBaselayerToggleWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlBaselayerToggleTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-baselayertoggle",inner:"Baselayer toggle",appendto:a._controlBaselayerToggleWrapper,attr:[["which","baselayertoggle"]]}),a._controlBaselayerToggleSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlBaselayerToggleWrapper}),a._controlBaselayerToggleSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-baselayertoggle",appendto:a._controlBaselayerToggleSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlBaselayerToggleSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlBaselayerToggleSwitch,attr:[["for","map-controls-baselayertoggle"]]}),a._controlCartoCSSWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlCartoCSSTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-cartocss",inner:"CartoCSS Editor",appendto:a._controlCartoCSSWrapper,attr:[["which","cartocss"]]}),a._controlCartoCSSSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlCartoCSSWrapper}),a._controlCartoCSSSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-cartocss",appendto:a._controlCartoCSSSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlCartoCSSSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlCartoCSSSwitch,attr:[["for","map-controls-cartocss"]]}),a._controlMousePosWrapper=Wu.DomUtil.makeit({type:"div",cname:"item-list controls-item",appendto:a._controlsInner}),a._controlMousePosTitle=Wu.DomUtil.makeit({type:"div",cname:"controls-title",id:"map-controls-title-mouseposition",inner:"Mouse position",appendto:a._controlMousePosWrapper,attr:[["which","mouseposition"]]}),a._controlMousePosSwitch=Wu.DomUtil.makeit({type:"div",cname:"switch controls-switch",appendto:a._controlMousePosWrapper}),a._controlMousePosSwitchInput=Wu.DomUtil.makeit({type:"input",cname:"cmn-toggle cmn-toggle-round-flat",id:"map-controls-mouseposition",appendto:a._controlMousePosSwitch,attr:[["type","checkbox"],["checked","checked"]]}),a._controlMousePosSwitchLabel=Wu.DomUtil.makeit({type:"label",appendto:a._controlMousePosSwitch,attr:[["for","map-controls-mouseposition"]]})},addHooks:function(){},_activate:function(){},_deactivate:function(){},updateContent:function(){this._update()},_resetView:function(){},update:function(){this._update()},_update:function(){this.project=app.activeProject;for(s in this.mapSettings){var a=this.mapSettings[s];a.update()}this.setContentHeight()},closeAll:function(){var a=app.SidePane.Map.mapSettings;for(o in a){var b=a[o];b._isOpen&&b.close()}}}),Wu.SidePane.Map.MapSetting=Wu.SidePane.Map.extend({_:"sidepane.map.mapsetting",type:"mapSetting",initialize:function(a){this.panes={},this.mapsettingsContainer=Wu.DomUtil.get("mapsettings-container"),this.getPanes(),this.initLayout(a),this.addHooks()},buttonDown:function(a){Wu.DomUtil.addClass(a.target,"btn-info")},buttonUp:function(a){Wu.DomUtil.removeClass(a.target,"btn-info")},update:function(){this.project=Wu.app.activeProject},addHooks:function(){Wu.DomEvent.on(this._container,"mousedown",this.toggleOpen,this)},removeHooks:function(){},calculateHeight:function(){this.maxHeight=this._inner.offsetHeight+15,this.minHeight=0},pendingOpen:function(){if(app._timerOpen&&clearTimeout(app._timerOpen),!this._isOpen){var a=this;app._timerOpen=setTimeout(function(){a.open(),app._pendingClose&&app._pendingClose.close(),app._pendingClose=a},200)}},toggleOpen:function(){this._isOpen?this.close():this.open()},open:function(){this.calculateHeight(),this._outer.style.height=this.maxHeight+20+"px",this._open(),this._isOpen=!0,app._pendingClose&&app._pendingClose!=this&&app._pendingClose.close(),app._pendingClose=this},close:function(){this.calculateHeight(),this._outer.style.height=this.minHeight+"px",this._close(),this._isOpen=!1,app._pendingClose=!1,app._timerOpen&&clearTimeout(app._timerOpen)},_open:function(){app.SidePane.Map.mapSettings.layermenu.disableEdit()},_close:function(){},initLayout:function(){},getPanes:function(){},sortLayers:function(a){var b=["geojson","mapbox","osm"],c=[];return b.forEach(function(b){var d={key:b,layers:[]};for(l in a){var e=a[l];e.store.data.hasOwnProperty(b)&&d.layers.push(e)}c.push(d)},this),this.numberOfProviders=c.length,c},addProvider:function(a){var b="";"geojson"==a&&(b="Data Library"),"mapbox"==a&&(b="Mapbox"),"osm"==a&&(b="Open Street Map");Wu.DomUtil.create("div","item-list-header",this._outer,b)},fillLayers:function(){if(this._layers={},!_.isEmpty(this.project.layers)){var a=this.sortLayers(this.project.layers);a.forEach(function(a){this.addProvider(a.key),a.layers.forEach(function(a){this.addLayer(a)},this)},this),this.calculateHeight()}}}),Wu.SidePane.Map.BaseLayers=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.baselayers",type:"baseLayers",getPanes:function(){this._container=Wu.DomUtil.get("editor-map-baselayer-wrap")},initLayout:function(){this._container.innerHTML='<h4 id="h4-base">Base Layers</h4>';var a=Wu.DomUtil.createId("div","select-baselayer-wrap",this._container);this._outer=Wu.DomUtil.create("div","select-elems",a),Wu.DomUtil.addClass(a,"select-wrap");var b=Wu.DomUtil.get("h4-base");app.Tooltip.add(b,'Sets the base layers of the map. These layers will not appear in the "Layers" menu to the right of the screen. Users may still toggle these layers if the "Base Layer Toggle" option has been set to active in the "Controls" section.')},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this),this.editMode=!1,this.initLayout(),this.fillLayers(),this.markOccupied()},removeHooks:function(){},addLayer:function(a){var b=Wu.DomUtil.create("div","item-list select-elem ct0 baselayer",this._outer),c=Wu.DomUtil.create("div","item-list-inner-text",b);c.innerHTML=a.store.title,a.store.title&&a.store.title.length<32&&(c.style.maxHeight="12px");var d=Wu.DomUtil.create("input","baselayer-range-slider-opacity",b),e=Wu.DomUtil.create("input","baselayer-range-slider-zindex",b),f={layer:a,container:b,active:!1,rangeOpacity:d,rangeZindex:e};this.project.store.baseLayers.forEach(function(b){a.store.uuid==b.uuid&&this.on(f)},this),Wu.DomEvent.on(b,"mousedown",function(a){Wu.DomEvent.stop(a),this.toggle(f)},this),this._layers=this._layers||{},this._layers[f.layer.store.uuid]=f},toggleEdit:function(a){var b=a.layer.store.uuid;this.editMode[b]?this.editOff(a):this.editOn(a)},setOpacity:function(){if(this.context.rangeOpacity){var a=parseFloat(this.context.rangeOpacity.element.value/100);this.layer.setOpacity(a);{var b=this.layer.store.uuid,c=_.find(this.context.project.store.baseLayers,function(a){return a.uuid==b});this.context.project}c.opacity=a,this.context.save()}},setZIndex:function(){if(this.context.rangeZindex){var a=parseFloat(this.context.rangeZindex.element.value);this.layer.setZIndex(a);{var b=this.layer.store.uuid,c=_.find(this.context.project.store.baseLayers,function(a){return a.uuid==b});this.context.project}c.zIndex=a,this.context.save()}},save:function(){var a=this;this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(function(){a.project._update("baseLayers")},1e3)},editOn:function(a){var b=a.layer.store.uuid,c=_.find(this.project.store.baseLayers,function(a){return a.uuid==b});if(c)var d=parseInt(100*c.opacity);else var d=1;this.rangeOpacity=new Powerange(a.rangeOpacity,{callback:this.setOpacity,decimal:!1,disable:!1,disableOpacity:.5,hideRange:!1,klass:"powerange-opacity",min:0,max:100,start:d,step:null,vertical:!1,context:this,layer:a.layer}),this.rangeZindex=new Powerange(a.rangeZindex,{callback:this.setZIndex,decimal:!1,disable:!1,disableOpacity:.5,hideRange:!1,klass:"powerange-zindex",min:1,max:10,start:null,step:1,vertical:!1,context:this,layer:a.layer}),a.container.style.height="132px";var e=this.rangeZindex.handle,f=this.rangeZindex.slider;Wu.DomEvent.on(e,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(f,"mousedown",Wu.DomEvent.stop,this);var e=this.rangeOpacity.handle,f=this.rangeOpacity.slider;Wu.DomEvent.on(e,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(f,"mousedown",Wu.DomEvent.stop,this),this.calculateHeight(),this.open(),this.editMode=this.editMode||{},this._editsOff();var b=a.layer.store.uuid;this.editMode[b]=a},_editsOff:function(){var a=this.editMode;
for(b in a){var c=a[b];this.editOff(c)}},editOff:function(a){a.layer.store.uuid;a.container.style.height="32px";var b=this.rangeZindex.handle,c=this.rangeZindex.slider;Wu.DomEvent.on(b,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(c,"mousedown",Wu.DomEvent.stop,this),Wu.DomUtil.remove(this.rangeZindex.slider),Wu.DomUtil.remove(this.rangeOpacity.slider),Wu.DomUtil.remove(this.rangeZindex.handle),Wu.DomUtil.remove(this.rangeOpacity.handle),delete this.rangeZindex,delete this.rangeOpacity,this.calculateHeight(),this.open()},toggle:function(a){a.active?(this.off(a),this.disableLayer(a)):(this.on(a),this.enableLayer(a));var b=app.activeProject,c=b.getThumbCreated();c||b.createProjectThumb()},on:function(a){Wu.DomUtil.addClass(a.container,"active"),a.active=!0},off:function(a){Wu.DomUtil.removeClass(a.container,"active"),a.active=!1},setDefaultLayer:function(){var a=_.sample(this._layers,1)[0];a&&(this.on(a),this.enableLayer(a))},enableLayer:function(a){var b=a.layer;b._addTo("baselayer"),this.project.addBaseLayer({uuid:b.getUuid(),zIndex:1,opacity:b.getOpacity()}),this._refreshControls()},disableLayer:function(a){if(a){var b=a.layer;b&&b.disable(),this.project.removeBaseLayer(b),this._refreshControls()}},_refreshControls:function(){var a=app.MapPane.baselayerToggle;a&&a.update();var b=app.SidePane.Map.mapSettings.layermenu;b.markOccupied();var c=app.MapPane.cartoCss;c&&c.update()},calculateHeight:function(){var a=_.size(this.project.getLayermenuLayers()),b=35*this.numberOfProviders;this.maxHeight=33*(_.size(this.project.layers)-a)+b,this.minHeight=0,this.editMode&&(this.maxHeight+=100)},markOccupied:function(){var a=this.project.getLayermenuLayers(),b=this.project.getLayers();b.forEach(function(a){this.activate(a.store.uuid)},this),a.forEach(function(a){var c=_.find(b,function(b){return b.store.uuid==a.layer});c&&this.deactivate(c.store.uuid)},this)},activate:function(a){var b=this._layers[a];Wu.DomUtil.removeClass(b.container,"deactivated")},deactivate:function(a){var b=this._layers[a];Wu.DomUtil.addClass(b.container,"deactivated")}}),Wu.SidePane.Map.LayerMenu=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.layermenu",type:"layerMenu",getPanes:function(){this._container=Wu.DomUtil.get("editor-map-layermenu-wrap")},initLayout:function(){this._container.innerHTML='<h4 id="h4-layer">Layer Menu</h4>',this._inner=Wu.DomUtil.create("div","map-layermenu-inner",this._container),this._outer=Wu.DomUtil.create("div","map-layermenu-outer",this._inner);var a=Wu.DomUtil.get("h4-layer");app.Tooltip.add(a,"Sets layers that will appear in the layer menu. Selected base layers will be excluded from the Layer Menu list, and vice versa, to avoid duplicates.")},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this),this.layerMenu=Wu.app.MapPane.layerMenu,this.editMode=!1,this.initLayout(),this.fillLayers(),this.markOccupied()},addLayer:function(a){var b=Wu.DomUtil.create("div","item-list select-elem ct0",this._outer),c=Wu.DomUtil.create("div","item-list-inner-text",b);c.innerHTML=a.store.title,a.store.title&&a.store.title.length<32&&(c.style.maxHeight="12px");var d=Wu.DomUtil.create("div","edit-layermenu-layer",b),e=Wu.DomUtil.create("input","layermenu-range-slider-opacity",b),f=Wu.DomUtil.create("input","layermenu-range-slider-zindex",b),g={layer:a,container:b,active:!1,rangeOpacity:e,rangeZindex:f};this._layers[a.store.uuid]=g,this.project.store.layermenu.forEach(function(b){a.store.uuid==b.layer&&this.on(g)},this),Wu.DomEvent.on(b,"mousedown",function(a){Wu.DomEvent.stop(a),this.toggle(g)},this),Wu.DomEvent.on(d,"mousedown",function(a){Wu.DomEvent.stop(a)},this)},getLayerByUuid:function(a){var b=_.find(this._layers,function(b){return b.layer.store.uuid==a});return b},enableLayerByUuid:function(a){var b=this.getLayerByUuid(a);return b?(this.toggle(b),b):!1},calculateHeight:function(){var a=_.size(this.project.getBaselayers()),b=35*this.numberOfProviders;this.maxHeight=33*(_.size(this.project.layers)-a)+b,this.minHeight=0,this.editMode&&(this.maxHeight+=100)},enableLayermenu:function(){var a=app.MapPane.enableLayermenu();return app.SidePane.Map.mapSettings.controls.enableControl("layermenu"),this.project.store.controls.layermenu=!0,this.project._update("controls"),a},toggle:function(a){if(this.layerMenu=Wu.app.MapPane.layerMenu,this.layerMenu||(this.layerMenu=this.enableLayermenu()),this.layerMenu.enableEdit(),a.active){var b=a.layer.store.uuid;this.layerMenu._remove(b),this.off(a)}else this.layerMenu.add(a.layer),this.on(a);var c=app.SidePane.Map.mapSettings.baselayer;c.markOccupied();var d=app.MapPane.cartoCss;d&&d.update()},toggleEdit:function(){},on:function(a){Wu.DomUtil.addClass(a.container,"active"),a.active=!0},off:function(a){Wu.DomUtil.removeClass(a.container,"active"),a.active=!1},_off:function(a){var b=a.store.uuid,c=this._layers[b];this.off(c)},_open:function(){this.enableEdit(),clearTimeout(this.closeEditTimer)},_close:function(){this.disableEdit()},enableEdit:function(){var a=Wu.app.MapPane.layerMenu;a&&a.enableEdit()},disableEdit:function(){var a=Wu.app.MapPane.layerMenu;a&&a.disableEdit()},markOccupied:function(){var a=this.project.getBaselayers(),b=this.project.getLayers();b.forEach(function(a){this.activate(a.store.uuid)},this),a.forEach(function(a){this.deactivate(a.uuid)},this)},activate:function(a){var b=this._layers[a];b&&Wu.DomUtil.removeClass(b.container,"deactivated")},deactivate:function(a){var b=this._layers[a];b&&Wu.DomUtil.addClass(b.container,"deactivated")}}),Wu.SidePane.Map.Position=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.position",type:"position",getPanes:function(){this._container=Wu.DomUtil.get("editor-map-position-wrap"),this._outer=Wu.DomUtil.get("editor-map-initpos-coordinates"),this._inner=Wu.DomUtil.get("map-initpos-inner"),this.panes.initPos=Wu.DomUtil.get("editor-map-initpos-button"),this.panes.initPosLatValue=Wu.DomUtil.get("editor-map-initpos-lat-value"),this.panes.initPosLngValue=Wu.DomUtil.get("editor-map-initpos-lng-value"),this.panes.initPosZoomValue=Wu.DomUtil.get("editor-map-initpos-zoom-value"),this.toggled=!1;var a=this._container.getElementsByTagName("h4")[0];app.Tooltip.add(a,"Sets the starting position of the map.")},addHooks:function(){Wu.SidePane.Map.MapSetting.prototype.addHooks.call(this),Wu.DomEvent.on(this.panes.initPos,"click",this.setPosition,this),Wu.DomEvent.on(this.panes.initPos,"mousedown",this.buttonDown,this),Wu.DomEvent.on(this.panes.initPos,"mouseup",this.buttonUp,this),Wu.DomEvent.on(this.panes.initPos,"mouseleave",this.buttonUp,this),Wu.DomEvent.on(this.panes.initPos,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.initPosLatValue,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.initPosLngValue,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.initPosZoomValue,"mousedown",Wu.DomEvent.stopPropagation,this)},removeHooks:function(){},toggleDropdown:function(){this.toggled?(this.toggled=!1,this.close()):(this.toggled=!0,this.open())},setPosition:function(){var a=app.activeProject;if(a){var b=Wu.app._map.getCenter(),c=Wu.app._map.getZoom(),d={lat:b.lat,lng:b.lng,zoom:c};a.setPosition(d);var e=a.getThumbCreated();e||a.createProjectThumb(),this.update()}},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this);var a=this.project.getLatLngZoom();this.panes.initPosLatValue.value=a.lat,this.panes.initPosLngValue.value=a.lng,this.panes.initPosZoomValue.value=a.zoom},save:function(){var a=this;this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(function(){a.project._update("position")},1e3)}}),Wu.SidePane.Map.Bounds=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.bounds",type:"bounds",getPanes:function(){this._container=Wu.DomUtil.get("editor-map-bounds-wrap"),this._outer=Wu.DomUtil.get("editor-map-bounds-coordinates"),this._inner=Wu.DomUtil.get("map-bounds-inner"),this.panes.clear=Wu.DomUtil.get("editor-map-bounds-clear"),this.panes.bounds=Wu.DomUtil.get("editor-map-bounds"),this.panes.boundsNELatValue=Wu.DomUtil.get("editor-map-bounds-NE-lat-value"),this.panes.boundsNELngValue=Wu.DomUtil.get("editor-map-bounds-NE-lng-value"),this.panes.boundsSWLatValue=Wu.DomUtil.get("editor-map-bounds-SW-lat-value"),this.panes.boundsSWLngValue=Wu.DomUtil.get("editor-map-bounds-SW-lng-value"),this.panes.boundsNE=Wu.DomUtil.get("editor-map-bounds-NE"),this.panes.boundsSW=Wu.DomUtil.get("editor-map-bounds-SW"),this.panes.minZoom=Wu.DomUtil.get("editor-map-bounds-min-zoom-value"),this.panes.maxZoom=Wu.DomUtil.get("editor-map-bounds-max-zoom-value"),this.panes.setMinZoom=Wu.DomUtil.get("editor-map-bounds-set-minZoom"),this.panes.setMaxZoom=Wu.DomUtil.get("editor-map-bounds-set-maxZoom"),this.toggled=!1;var a=this._container.getElementsByTagName("h4")[0];app.Tooltip.add(a,'Decides the bounding area and the min/max zoom of the map. If a user moves outside of the bounding area, the map will "bounce" back to fit within the given bounding coordinates.')},addHooks:function(){Wu.SidePane.Map.MapSetting.prototype.addHooks.call(this),Wu.DomEvent.on(this.panes.bounds,"click",this.setBounds,this),Wu.DomEvent.on(this.panes.clear,"click",this.clearBounds,this),Wu.DomEvent.on(this.panes.boundsNE,"click",this.setBoundsNE,this),Wu.DomEvent.on(this.panes.boundsSW,"click",this.setBoundsSW,this),Wu.DomEvent.on(this.panes.setMinZoom,"click",this.setMinZoom,this),Wu.DomEvent.on(this.panes.setMaxZoom,"click",this.setMaxZoom,this),Wu.DomEvent.on(this.panes.bounds,"mousedown",this.buttonDown,this),Wu.DomEvent.on(this.panes.bounds,"mouseup",this.buttonUp,this),Wu.DomEvent.on(this.panes.bounds,"mouseleave",this.buttonUp,this),Wu.DomEvent.on(this.panes.clear,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.bounds,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.boundsNELatValue,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.boundsNELngValue,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.boundsSWLatValue,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.boundsSWLngValue,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.boundsNE,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.boundsSW,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.minZoom,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.maxZoom,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.setMinZoom,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this.panes.setMaxZoom,"mousedown",Wu.DomEvent.stopPropagation,this)},removeHooks:function(){},setBounds:function(){var a=app.activeProject;if(a){var b=Wu.app._map.getBounds(),c=Wu.app._map.getZoom();a.setBounds({northEast:{lat:b._northEast.lat,lng:b._northEast.lng},southWest:{lat:b._southWest.lat,lng:b._southWest.lng},minZoom:c,maxZoom:18}),this.update(),this.enforceBounds()}},setMinZoom:function(){var a=app._map,b=a.getZoom(),c=this.project.getBounds();c.minZoom=b,this.project.setBounds(c),this.update()},setMaxZoom:function(){var a=app._map,b=a.getZoom(),c=this.project.getBounds();c.maxZoom=parseInt(b),this.project.setBounds(c),this.update()},enforceBounds:function(){var a=app.activeProject,b=app._map,c=a.getBounds();if(c){var d=L.latLng(c.southWest.lat,c.southWest.lng),e=L.latLng(c.northEast.lat,c.northEast.lng),f=L.latLngBounds(d,e),g=c.minZoom,h=c.maxZoom;b.setMaxBounds(c==this._nullBounds?!1:f),b.options.minZoom=g,b.options.maxZoom=h}b.invalidateSize()},_nullBounds:{northEast:{lat:"90",lng:"180"},southWest:{lat:"-90",lng:"-180"},minZoom:"1",maxZoom:"20"},clearBounds:function(){var a=Wu.app.activeProject,b=Wu.app._map;a.setBounds(this._nullBounds),this.update(),this.enforceBounds(),b.setMaxBounds(!1)},setBoundsSW:function(){var a=Wu.app.activeProject,b=Wu.app._map;if(a){var c=b.getBounds(),d=b.getZoom();a.setBoundsSW({lat:c._southWest.lat,lng:c._southWest.lng}),a.setBoundsZoomMin(d),this.update(),b.setMaxBounds(c)}},setBoundsNE:function(){var a=app.activeProject;if(a){var b=app._map.getBounds();a.setBoundsNE({lat:b._northEast.lat,lng:b._northEast.lng}),this.update()}},toggleDropdown:function(){this.toggled?(this.toggled=!1,this.close()):(this.toggled=!0,this.open())},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this);var a=this.project.getBounds();a&&(this.panes.boundsNELatValue.value=a.northEast.lat,this.panes.boundsNELngValue.value=a.northEast.lng,this.panes.boundsSWLatValue.value=a.southWest.lat,this.panes.boundsSWLngValue.value=a.southWest.lng,this.panes.maxZoom.value=a.maxZoom,this.panes.minZoom.value=a.minZoom),this.enforceBounds()},save:function(){var a=this;this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(function(){a.project._update("bounds")},1e3)}}),Wu.SidePane.Map.Controls=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.controls",type:"controls",getPanes:function(){this._container=Wu.DomUtil.get("editor-map-controls-wrap"),this._outer=Wu.DomUtil.get("editor-map-controls-inner-wrap"),this.panes.controlZoom=Wu.DomUtil.get("map-controls-zoom").parentNode.parentNode,this.panes.controlDraw=Wu.DomUtil.get("map-controls-draw").parentNode.parentNode,this.panes.controlInspect=Wu.DomUtil.get("map-controls-inspect").parentNode.parentNode,this.panes.controlDescription=Wu.DomUtil.get("map-controls-description").parentNode.parentNode,this.panes.controlLayermenu=Wu.DomUtil.get("map-controls-layermenu").parentNode.parentNode,this.panes.controlLegends=Wu.DomUtil.get("map-controls-legends").parentNode.parentNode,this.panes.controlMeasure=Wu.DomUtil.get("map-controls-measure").parentNode.parentNode,this.panes.controlGeolocation=Wu.DomUtil.get("map-controls-geolocation").parentNode.parentNode,this.panes.controlMouseposition=Wu.DomUtil.get("map-controls-mouseposition").parentNode.parentNode,this.panes.controlBaselayertoggle=Wu.DomUtil.get("map-controls-baselayertoggle").parentNode.parentNode,this.panes.controlCartocss=Wu.DomUtil.get("map-controls-cartocss").parentNode.parentNode;var a=this._container.getElementsByTagName("h4")[0];app.Tooltip.add(a,"Enables the control options that goes on top of the map."),app.Tooltip.add(this.panes.controlZoom,"Enables zooming on the map. Puts [+] and [-] buttons on the map."),app.Tooltip.add(this.panes.controlDraw,"Enables drawing on the map."),app.Tooltip.add(this.panes.controlInspect,"The layer inspector enables users to change the order or selected layers, to isolate layers, and to zoom to layer bounds."),app.Tooltip.add(this.panes.controlDescription,"Enables layer description boxes."),app.Tooltip.add(this.panes.controlLayermenu,"Enables the layer menu."),app.Tooltip.add(this.panes.controlLegends,"Enable layer legends."),app.Tooltip.add(this.panes.controlMeasure,"Enables scaling tool on the map."),app.Tooltip.add(this.panes.controlGeolocation,"Enables users to search for address or locations in the world."),app.Tooltip.add(this.panes.controlMouseposition,"Shows the geolocation of mouse pointer."),app.Tooltip.add(this.panes.controlBaselayertoggle,"Enables toggelig base layers on and off."),app.Tooltip.add(this.panes.controlCartocss,"Enables the CartoCSS editor, the tooltip styler, and auto generated layer legends.")},addHooks:function(){Wu.SidePane.Map.MapSetting.prototype.addHooks.call(this),Wu.DomEvent.on(this.panes.controlZoom,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlDraw,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlInspect,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlDescription,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlLayermenu,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlLegends,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlMeasure,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlGeolocation,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlMouseposition,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlBaselayertoggle,"mousedown click",this.toggleControl,this),Wu.DomEvent.on(this.panes.controlCartocss,"mousedown click",this.toggleControl,this)},removeHooks:function(){},calculateHeight:function(){var a=_.size(this.controls);this.maxHeight=30*a+30,this.minHeight=0},toggleControl:function(a){if("click"==a.type)return Wu.DomEvent.stop(a);Wu.DomEvent.stop(a);var b=a.target.getAttribute("which"),c=Wu.DomUtil.get("map-controls-"+b),d=!c.checked,e="enable"+b.camelize(),f="disable"+b.camelize(),g=app.MapPane;d?(g[e](),this.enableControl(b)):(g[f](),this.disableControl(b)),this.project.store.controls[b]=d,this.project._update("controls"),g.updateControlCss()},disableControl:function(a){{var b=Wu.DomUtil.get("map-controls-"+a),c=Wu.DomUtil.get("map-controls-title-"+a).parentNode;Wu.app._map}Wu.DomUtil.removeClass(c,"active"),b.checked=!1},enableControl:function(a){{var b=Wu.DomUtil.get("map-controls-"+a),c=Wu.DomUtil.get("map-controls-title-"+a).parentNode;Wu.app._map}Wu.DomUtil.addClass(c,"active"),b.checked=!0},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this),this.controls=this.project.getControls(),delete this.controls.vectorstyle;for(c in this.controls){var a=this.controls[c],b="enable"+c.camelize(),d="disable"+c.camelize();a?(Wu.app.MapPane[b](),this.enableControl(c)):(Wu.app.MapPane[d](),this.disableControl(c))}}}),Wu.SidePane.Map.Connect=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.connect",type:"connect",initLayout:function(a){this._container=Wu.DomUtil.create("div","editor-inner-wrapper editor-map-item-wrap ct12 ct17 ct23",a);var b=Wu.DomUtil.create("h4","",this._container,"Connected Sources");this._outer=Wu.DomUtil.create("div","connect-outer",this._container);{var c=Wu.DomUtil.create("div","connect-osm",this._outer);Wu.DomUtil.create("div","connect-title",c,"Open Street Map")}this._osmwrap=Wu.DomUtil.create("div","osm-connect-wrap",this._outer),this._osmbox=Wu.DomUtil.create("div","osm-add-box",this._osmwrap,"Add OSM layer");{var d=Wu.DomUtil.create("div","connect-mapbox",this._outer);Wu.DomUtil.create("div","connect-title",d,"Mapbox")}this._mapboxWrap=Wu.DomUtil.create("div","mapbox-connect-wrap ct11",this._outer),this._mapboxInput=Wu.DomUtil.create("input","input-box search import-mapbox-layers",this._mapboxWrap),this._mapboxConnect=Wu.DomUtil.create("div","smap-button-gray ct0 ct11 import-mapbox-layers-button",this._mapboxWrap,"Add"),this._mapboxAccounts=Wu.DomUtil.create("div","mapbox-accounts",this._mapboxWrap),this.resetInput(),app.Tooltip.add(b,"Imports layers from MapBox accounts.")},addHooks:function(){Wu.SidePane.Map.MapSetting.prototype.addHooks.call(this),Wu.DomEvent.on(this._mapboxConnect,"click",this.importMapbox,this),Wu.DomEvent.on(this._osmbox,"click",this.addOSMLayer,this),Wu.DomEvent.on(this._mapboxConnect,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(this._mapboxInput,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._osmwrap,"mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._osmbox,"mousedown",Wu.DomEvent.stopPropagation,this)},removeHooks:function(){},calculateHeight:function(){var a=this.project.getMapboxAccounts().length;this.maxHeight=150+30*a,this.minHeight=0},tokenMode:function(){this._username=this._mapboxInput.value,this._mapboxInput.value="",this._askedToken=!0,this._mapboxConnect.innerHTML="OK",this._mapboxInput.setAttribute("placeholder","Enter access token")},resetInput:function(){this._username=null,delete this._username,this._askedToken=!1,this._mapboxConnect.innerHTML="Add",this._mapboxInput.setAttribute("placeholder","Mapbox username"),this._mapboxInput.value=""},addOSMLayer:function(){this.project.createOSMLayer(function(){this._updateLayerOptions()}.bind(this))},_updateLayerOptions:function(){app.SidePane.Map.mapSettings.baselayer.update(),app.SidePane.Map.mapSettings.layermenu.update()},importMapbox:function(){if(!this._askedToken)return this.tokenMode();var a=this._username,b=this._mapboxInput.value;this.resetInput(),this._importMapbox(a,b,this.importedMapbox)},_importMapbox:function(a,b,c){var d={username:a,accessToken:b,projectId:this.project.store.uuid};Wu.post("/api/util/getmapboxaccount",JSON.stringify(d),c,this)},importedMapbox:function(a,b){var c=JSON.parse(b),d=c.error,e=c.project;d||a.project.setStore(e)},fillMapbox:function(){var a=this.project.getMapboxAccounts();a&&(this._mapboxAccounts.innerHTML="",a.forEach(function(a){this._insertMapboxAccount(a)},this))},_insertMapboxAccount:function(a){{var b=Wu.DomUtil.create("div","mapbox-listed-account",this._mapboxAccounts);Wu.DomUtil.create("div","mapbox-listed-account-title",b,a.username.camelize())}if(this.project.editMode){var c=Wu.DomUtil.create("div","mapbox-listed-account-refresh",b),d=Wu.DomUtil.create("div","mapbox-listed-account-delete",b);Wu.DomEvent.on(c,"mousedown",function(c){Wu.DomEvent.stop(c);var d="Are you sure you want to refresh the account? This will DELETE old layers and re-import them.";confirm(d)&&this._refreshMapboxAccount(b,a)},this),Wu.DomEvent.on(d,"mousedown",function(c){Wu.DomEvent.stop(c);var d="Are you sure you want to delete the account? This will DELETE all layers from account in this project.";confirm(d)&&this._removeMapboxAccount(b,a)},this)}},_removeMapboxAccount:function(a,b){Wu.DomUtil.remove(a),this.project.removeMapboxAccount(b)},_refreshMapboxAccount:function(a,b){this._removeMapboxAccount(a,b);var c=this;setTimeout(function(){c._importMapbox(b.username,b.accessToken,c.importedMapbox)},1e3)},fillOSM:function(){},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this),this.fillOSM(),this.fillMapbox()}}),Wu.SidePane.Map.Settings=Wu.SidePane.Map.MapSetting.extend({_:"sidepane.map.settings",type:"settings",options:{socialSharing:!0,documentsPane:!0,dataLibrary:!0,mediaLibrary:!1,darkTheme:!0,tooltips:!0,mapboxGL:!1},initLayout:function(a){this._container=Wu.DomUtil.create("div","editor-inner-wrapper editor-map-item-wrap ct12 ct17 ct23",a);var b=Wu.DomUtil.create("h4","",this._container,"Settings");this._outer=Wu.DomUtil.create("div","settings-outer",this._container),app.Tooltip.add(b,"Enable additional map settings.")},addHooks:function(){Wu.SidePane.Map.MapSetting.prototype.addHooks.call(this),Wu.DomEvent.on(this._outer,"mousedown",Wu.DomEvent.stopPropagation,this)},removeHooks:function(){Wu.DomEvent.off(this._outer,"mousedown",Wu.DomEvent.stopPropagation,this)},calculateHeight:function(){var a=_.filter(this.options,function(a){return a}).length;this.maxHeight=30*a,this.minHeight=0},contentLayout:function(){var a=Wu.DomUtil.create("div","settings-wrapper");if(this.options.screenshot){var b=this._contentItem("screenshot","Screenshots");a.appendChild(b),app.Tooltip.add(b,"Enable users to make screenshots of map")}if(this.options.socialSharing){var c=this._contentItem("socialSharing","Sharing");a.appendChild(c),app.Tooltip.add(c,"Enable social sharing for this map")}if(this.options.documentsPane){var d=this._contentItem("documentsPane","Documents Pane");a.appendChild(d),app.Tooltip.add(d,"Enable documents pane for this map")}if(this.options.dataLibrary){var e=this._contentItem("dataLibrary","Data Library");a.appendChild(e),app.Tooltip.add(e,"Enable public data library for this map")}if(this.options.mediaLibrary){var f=this._contentItem("mediaLibrary","Media Library");a.appendChild(f),app.Tooltip.add(f,"Enable media library for this map")}if(this.options.autoHelp){var g=this._contentItem("autoHelp","Add Help");a.appendChild(g),app.Tooltip.add(g,"Add help section to documents")}if(this.options.autoAbout){var h=this._contentItem("autoAbout","Add About");a.appendChild(h),app.Tooltip.add(h,"Add about section to documents")}if(this.options.darkTheme){var i=this._contentItem("darkTheme","Dark Theme");a.appendChild(i),app.Tooltip.add(i,"Toggle between dark- and light theme")}if(this.options.tooltips){var j=this._contentItem("tooltips","Tooltips");a.appendChild(j),app.Tooltip.add(j,"Enable this tooltip for the portal")}if(this.options.mapboxGL){var k=this._contentItem("mapboxGL","MapboxGL");a.appendChild(k),app.Tooltip.add(k,"Render map with GL")}return a},_contentItem:function(a,b){var c="settings-item settings-item-"+a,d=Wu.DomUtil.create("div",c),e=Wu.DomUtil.create("div","settings-item-title",d),f=Wu.DomUtil.create("div","switch",d),g=Wu.DomUtil.create("input","cmn-toggle cmn-toggle-round-flat",f),h=Wu.DomUtil.create("label","",f),i=Wu.Util.guid();return e.innerHTML=b,g.setAttribute("type","checkbox"),this._settings[a]&&g.setAttribute("checked","checked"),g.id=i,h.setAttribute("for",i),Wu.DomEvent.on(d,"click",function(b){Wu.DomEvent.stop(b),this.project.toggleSetting(a),this._settings=this.project.getSettings(),this._settings[a]?g.setAttribute("checked","checked"):g.removeAttribute("checked")},this),d},save:function(){this.project.setSettings(this._settings)},update:function(){Wu.SidePane.Map.MapSetting.prototype.update.call(this),this._settings=this.project.getSettings();var a=this.contentLayout();this._outer.innerHTML="",this._outer.appendChild(a)}}),Wu.SidePane.Documents=Wu.SidePane.Item.extend({type:"documents",title:"Docs",initContent:function(){this._content=Wu.DomUtil.create("div","fullpage-documents",Wu.app._appPane),this._container=Wu.DomUtil.create("div","editor-wrapper",this._content),this._leftpane=Wu.DomUtil.create("div","documents-container-leftpane",this._container),this._documentsFolders=Wu.DomUtil.create("div","documents-folders",this._leftpane),this._folderpane=Wu.DomUtil.create("div","documents-folder-list",this._documentsFolders),this._newfolder=Wu.DomUtil.create("div","documents-new-folder",this._documentsFolders,"(+)"),this._rightpane=Wu.DomUtil.create("div","documents-container-rightpane",this._container),this._textarea=Wu.DomUtil.create("article","documents-container-textarea",this._rightpane),app.Tooltip.add(this._menu,"This is the projects document section.")},initFolders:function(){this.folders={};var a=this.project.store.folders;a.forEach(function(a){this.folders[a.uuid]=a},this)},addHooks:function(){},addEditHooks:function(){Wu.DomEvent.on(this._newfolder,"mousedown",this.newFolder,this),this.addGrande(),Wu.DomUtil.removeClass(this._newfolder,"displayNone")},addGrande:function(){var a=this._textarea,b=this.project.getFiles(),c=this.project.getGrandeFiles(b),d=this.project.getGrandeImages(b),e={plugins:{attachments:new G.Attachments(c,{icon:[app.options.servers.portal+"images/image-c9471cb2-7e0e-417d-a048-2ac501e7e96f",app.options.servers.portal+"images/image-7b7cc7e4-404f-4e29-9d7d-11f0f24faf42"],className:"attachment"}),images:new G.Attachments(d,{icon:[app.options.servers.portal+"images/image-0359b349-6312-4fe5-b5d7-346a7a0d3c38",app.options.servers.portal+"images/image-087ef5f5-b838-48bb-901f-7e896de7c59e"],embedImage:!0,className:"image-attachment"})},events:{change:this.textChange}};this.grande=G.rande(a,e)},removeGrande:function(){this.grande&&(this.grande.destroy(),delete this.grande)},textChange:function(){},removeEditHooks:function(){Wu.DomEvent.off(this._newfolder,"mousedown",this.newFolder,this),this.removeGrande(),Wu.DomUtil.addClass(this._newfolder,"displayNone")},_activate:function(){this.adjustTop(),Wu.app.HeaderPane.disableResize();var a=this.project.store.folders;if(a.length>0){var b=a[0].uuid;this.selectFolder(b)}this.project.editMode&&(this.enableShift(),this.addEditHooks()),this._hideControls()},_hideControls:function(){var a=app.MapPane.layerMenu;a&&a.hide();var b=app.MapPane.inspectControl;b&&b.hide();var c=app.MapPane.legendsControl;c&&c.hide();var d=app.MapPane.descriptionControl;d&&d.hide()},_showControls:function(){var a=app.MapPane.layerMenu;a&&a.show();var b=app.MapPane.inspectControl;b&&b.show();var c=app.MapPane.legendsControl;c&&c.show();var d=app.MapPane.descriptionControl;d&&d.show()},_deactivate:function(){Wu.app.HeaderPane.enableResize(),this.disableShift(),this.removeEditHooks(),this._showControls()},enableShift:function(){Wu.DomEvent.on(window,"keydown",this.shiftMode,this),Wu.DomEvent.on(window,"keyup",this.unshiftMode,this)},disableShift:function(){Wu.DomEvent.off(window,"keydown",this.shiftMode,this),Wu.DomEvent.off(window,"keyup",this.unshiftMode,this)},shiftMode:function(a){var c=a||window.event;if(16==c.which)for(b in this._deleteButtons){var d=this._deleteButtons[b];d.style.visibility="visible"}},unshiftMode:function(a){var c=a||window.event;if(16==c.which)for(b in this._deleteButtons){var d=this._deleteButtons[b];d.style.visibility="hidden"}},adjustTop:function(){return},update:function(){this.project=app.activeProject,this.reset(),this.createFolders(),this.project.editMode?Wu.DomUtil.removeClass(this._newfolder,"displayNone"):Wu.DomUtil.addClass(this._newfolder,"displayNone")},updateContent:function(){this._textarea.innerHTML="",this.update()},newFolder:function(){var a={title:"Title",uuid:Wu.Util.guid("folder"),content:"Text content"};this.project.store.folders.push(a),this.update()},createFolders:function(){var a=this.project.store.folders;a&&(this._deleteButtons={},a.forEach(function(a){this._createFolder(a)},this))},_createFolder:function(a){if(this.project.editMode){var b=Wu.DomUtil.create("div","documents-folder-delete",this._folderpane,"x");Wu.DomEvent.on(b,"click",function(){this.deleteFolder(a.uuid)},this),this._deleteButtons[a.uuid]=b}var c=a;c.el=Wu.DomUtil.create("div","documents-folder-item ct23 ct28",this._folderpane),c.el.innerHTML=c.title,Wu.DomEvent.on(c.el,"mousedown",function(){this.selectFolder(c.uuid)},this),this.project.editMode&&Wu.DomEvent.on(c.el,"dblclick",function(a){this._renameFolder(a,c.uuid)},this),this.folders[c.uuid]=c},deleteFolder:function(a){confirm("Are you sure you want to delete folder "+this.folders[a].title+"?")&&(delete this.folders[a],this.save())},_renameFolder:function(a,b){this._editing=!0,this.disableShift();var c=a.target,d=a.target.innerHTML;c.innerHTML="";var e=Wu.DomUtil.create("input","documents-folder-item",c);e.setAttribute("key",""),e.setAttribute("value",d);var f=e;f.focus(),f.selectionStart=f.selectionEnd,Wu.DomEvent.on(f,"blur",function(a){this._titleBlur(a,b)},this),Wu.DomEvent.on(f,"keydown",function(a){this._titleKey(a,b)},this)},_titleKey:function(a,b){(13==event.which||13==event.keyCode)&&this._titleBlur(a,b)},_titleBlur:function(a,b){if(this._editing){this._editing=!1;var c=a.target.value,d=a.target.parentNode;d.innerHTML=c,this.folders[b].title=c,this.save(),this.enableShift()}},selectFolder:function(a){var b=this.folders[a];Wu.DomEvent.off(this._textarea,"keydown mousedown",this.autosave,this),this._textarea.innerHTML="",this._textarea.innerHTML=b.content,this._textarea.fuuid=a,this._textarea.blur(),this.underline(a),Wu.DomEvent.on(this._textarea,"keydown mousedown",this.autosave,this)},underline:function(a){for(f in this.folders){var b=this.folders[f].el,c=this.folders[f].uuid;a==c?Wu.DomUtil.addClass(b,"underline"):Wu.DomUtil.removeClass(b,"underline")}},autosave:function(){var a=this;clearTimeout(this._saving),this._saving=setTimeout(function(){a.saveText()},500)},saveText:function(){var a=this.folders[this._textarea.fuuid].content,b=this._textarea.innerHTML;a!=b&&(this.folders[this._textarea.fuuid].content=b,this.save())},save:function(){var a=this.folders;this.project.store.folders=[];for(f in a){var b=Wu.extend({},a[f]);delete b.el,this.project.store.folders.push(b)}this.project._update("folders"),app.setSaveStatus(),this.update()},reset:function(){this._folderpane.innerHTML="",this.folders={}}}),Wu.SidePane.DataLibrary=Wu.SidePane.Item.extend({_:"sidepane.datalibrary",type:"dataLibrary",title:"Data <br> Library",initContent:function(){this._content=Wu.DomUtil.create("div","data-library ct1",Wu.app._appPane),this._controlContainer=Wu.DomUtil.create("div","datalibrary-controls",this._content),this._controlInner=Wu.DomUtil.create("div","datalibrary-controls-inner",this._controlContainer),this._uploadContainer=Wu.DomUtil.create("div","smap-button-gray",this._controlInner,"Upload"),this._uploadContainer.id="upload-container",this._search=Wu.DomUtil.create("input","search",this._controlInner),this._search.id="datalibrary-search",this._search.setAttribute("type","text"),this._search.setAttribute("placeholder","Search files"),this._delete=Wu.DomUtil.create("div","smap-button-gray",this._controlInner,"Delete"),this._delete.id="datalibrary-delete-file",this._download=Wu.DomUtil.create("div","smap-button-gray",this._controlInner,"Download"),this._download.id="datalibrary-download-files",this._errors=Wu.DomUtil.createId("div","datalibrary-errors",this._controlInner),this._container=Wu.DomUtil.create("div","editor-wrapper ct1",this._content),this._downloadList=Wu.DomUtil.createId("div","datalibrary-download-dialogue",this._content),this.progress=Wu.DomUtil.create("div","progress-bar",this._content),this._dataLibraryContainer=Wu.DomUtil.create("div","datalibrary-container",this._container),this._tableContainer=Wu.DomUtil.create("div","datalibrary-table-container",this._dataLibraryContainer),this.fulldrop=Wu.DomUtil.create("div","fullscreen-drop",this._content),this.filecount=0,this._errors=Wu.DomUtil.get("datalibrary-errors"),this._uploader=Wu.DomUtil.get("upload-container"),this._deleter=Wu.DomUtil.get("datalibrary-delete-file"),this._downloader=Wu.DomUtil.get("datalibrary-download-files"),this._fileList=Wu.DomUtil.createId("div","filelist",this._tableContainer),this._tableFrame=Wu.DomUtil.create("table","datalibrary-table",this._fileList),this._tableHead=Wu.DomUtil.create("thead","",this._tableFrame),this._tableHeadRow=Wu.DomUtil.create("tr","",this._tableHead),this._th1=Wu.DomUtil.create("th","fivep",this._tableHeadRow),this._th1.setAttribute("data-sort","checkbox"),this._th1checkBox=Wu.DomUtil.createId("div","squaredThree-checkbox-all"),this._th1checkBox.className="squaredThree",this._checkall=Wu.DomUtil.createId("input","checkbox-all",this._th1checkBox),this._checkall.setAttribute("type","checkbox"),this._checkall.setAttribute("name","check"),this._checkall.setAttribute("value","None"),this._checkallLabel=Wu.DomUtil.createId("label","label-checkbox-all",this._th1checkBox),this._checkallLabel.setAttribute("for","checkbox-all"),this._th2=Wu.DomUtil.create("th","sort thirtyp",this._tableHeadRow,"Name"),this._th2.setAttribute("data-sort","name"),this._th2.setAttribute("data-insensitive","true"),this._th3=Wu.DomUtil.create("th","sort type",this._tableHeadRow,"Type"),this._th3.setAttribute("data-sort","type"),this._th3.setAttribute("data-insensitive","true"),this._th4=Wu.DomUtil.create("th","sort files",this._tableHeadRow,"Files"),this._th4.setAttribute("data-sort","files"),this._th4.setAttribute("data-insensitive","true"),this._th5=Wu.DomUtil.create("th","sort category",this._tableHeadRow,"Category"),this._th5.setAttribute("data-sort","category"),this._th5.setAttribute("data-insensitive","true"),this._th6=Wu.DomUtil.create("th","sort keywords",this._tableHeadRow,"Keywords"),this._th6.setAttribute("data-sort","keywords"),this._th6.setAttribute("data-insensitive","true"),this._th7=Wu.DomUtil.create("th","sort createdDate",this._tableHeadRow,"Date"),this._th7.setAttribute("data-sort","createdDate"),this._th7.setAttribute("data-insensitive","true"),this._th8=Wu.DomUtil.create("th","sort status",this._tableHeadRow,"Status"),this._th8.setAttribute("data-sort","status"),this._th8.setAttribute("data-insensitive","true"),this._table=Wu.DomUtil.create("tbody","list datalibrary-insertrows",this._tableFrame),this.initList(),this.initDZ(),this.initDownloadTable(),app.Tooltip.add(this._menu,"The data library contains all files uploaded to the project.")
},addHooks:function(){Wu.DomEvent.on(this._download,"mousedown",this.downloadFiles,this),Wu.DomEvent.on(this._checkallLabel,"mousedown",this.checkAll,this),Wu.DomEvent.on(this._search,"keyup",this.searchList,this)},addEditHooks:function(){Wu.DomEvent.on(this._deleter,"mousedown",this.deleteConfirm,this),Wu.DomUtil.removeClass(this._deleter,"displayNone")},removeEditHooks:function(){Wu.DomEvent.off(this._deleter,"mousedown",this.deleteConfirm,this),Wu.DomUtil.addClass(this._deleter,"displayNone")},searchList:function(a){if(27==a.keyCode)return this.resetSearch();var b=this._search.value;this.list.search(b)},resetSearch:function(){this.list.search(),this._search.value=""},_activate:function(){this.dz&&this.dz.enable(),this._hideControls()},_hideControls:function(){var a=app.MapPane.layerMenu;a&&a.hide();var b=app.MapPane.inspectControl;b&&b.hide();var c=app.MapPane.legendsControl;c&&c.hide();var d=app.MapPane.descriptionControl;d&&d.hide()},_showControls:function(){var a=app.MapPane.layerMenu;a&&a.show();var b=app.MapPane.inspectControl;b&&b.show();var c=app.MapPane.legendsControl;c&&c.show();var d=app.MapPane.descriptionControl;d&&d.show()},_deactivate:function(){this.dz&&this.dz.disable(),this._showControls()},initDownloadTable:function(){{var a=Wu.DomUtil.create("table","datalibrary-download-table",this._downloadList),b=Wu.DomUtil.create("thead","",a),c=Wu.DomUtil.create("tr","",b);Wu.DomUtil.create("div","download-name",c,"Name"),Wu.DomUtil.create("div","download-category",c,"Category"),Wu.DomUtil.create("div","download-version",c,"Version"),Wu.DomUtil.create("div","download-status",c,"Status"),Wu.DomUtil.create("div","download-format",c,"Format"),Wu.DomUtil.create("div","download-size",c,"Size"),Wu.DomUtil.create("div","download-remove",c,"Remove")}this.tBody=Wu.DomUtil.create("tbody","datalibrary-download-insertrows",a),this._downloadCancel=Wu.DomUtil.create("div","smap-button-gray download-cancel-button",this._downloadList,"Cancel"),this._downloadOK=Wu.DomUtil.create("div","smap-button-gray download-ok-button",this._downloadList,"Download"),Wu.DomEvent.on(this._downloadOK,"mousedown",this.downloadFiles,this),Wu.DomEvent.on(this._downloadCancel,"mousedown",this.downloadCancel,this)},checkAll:function(){if(this._checkall.checked){var a=this.list.visibleItems;a.forEach(function(a){var b=a.elm.children[0].childNodes[1].children[0];b.checked&&(b.checked=!1)},this)}else{var a=this.list.visibleItems;a.forEach(function(a){var b=a.elm.children[0].childNodes[1].children[0];b.checked||(b.checked=!0)},this)}},downloadFiles:function(){if(this._downloadFileList=this.getSelected(),this._downloadFileList.length){var a=[];this._downloadFileList.forEach(function(b){a.push(b.uuid)},this);var b={files:this._downloadFileList,puuid:this.project.store.uuid,pslug:this.project.store.slug},b=JSON.stringify(b);Wu.post("/api/file/download",b,this.receivedDownload,this),this.createDownloadDialog()}},receivedDownload:function(a,b){var c="/api/file/download?file="+b+"&type=zip";a.updateDownloadDialog(c)},createDownloadDialog:function(){var a=this._downloadDialog=Wu.DomUtil.create("div","download-dialog",this._content),b=Wu.DomUtil.create("div","download-dialog-inner",a),c=this._downloadDialogBtn=Wu.DomUtil.create("div","download-dialog-button",b,"Processing..."),d=Wu.DomUtil.create("div","download-dialog-cancel",b,"Cancel");Wu.DomEvent.on(d,"mousedown",this.removeDownloadDialog,this),Wu.DomEvent.on(c,"mousedown",this._removeDownloadDialog,this)},updateDownloadDialog:function(a){this._downloadDialogBtn.innerHTML="";var b=Wu.DomUtil.create("a","download-dialog-link",this._downloadDialogBtn,"Download");b.setAttribute("href",a)},removeDownloadDialog:function(){Wu.DomUtil.remove(this._downloadDialog)},_removeDownloadDialog:function(){this._downloadDialog.style.opacity=0,setTimeout(this.removeDownloadDialog.bind(this),3e3)},downloadCancel:function(){this._downloadFileList=[],this._downloadList&&(this._downloadList.style.display="none"),this._container&&(this._container.style.display="block"),Wu.DomUtil.removeClass(this._content,"hide-top",this)},downloadDone:function(){var a=this;setTimeout(function(){a.downloadCancel(),a.initDownloadTable()},1e3)},downloadConfirm:function(){var a=this.getSelected();if(this._downloadFileList=a,0!=a.length){var b="";a.forEach(function(a){var c=Wu.extend({},a);b+=ich.datalibraryDownloadRow(c)},this);var c=this.tBody;c.innerHTML=b,this._downloadList.style.display="block",this._container.style.display="none",Wu.DomUtil.addClass(this._content,"hide-top",this)}},getSelected:function(){var a=[];return this.project.store.files.forEach(function(b){var c=Wu.DomUtil.get("checkbox-"+b.uuid);if(c)var d=c.checked;d&&a.push(b)},this),a},deleteConfirm:function(){var a=this.getSelected();0!=a.length&&confirm("Are you sure you want to delete these "+a.length+" files?")&&this.deleteFiles(a)},deleteFiles:function(a){app.setStatus("Deleting"),this.project.removeFiles(a),app.setStatus("Deleted!"),this.project.refreshSidepane()},initList:function(){var a=Wu.DomUtil.createId("tr","dummy-table-entry",this._table);a.innerHTML="";var b=Wu.DomUtil.create("td","checkbox",a),c=Wu.DomUtil.create("div","squaredThree",b),d=Wu.DomUtil.createId("input","",c);d.setAttribute("type","checkbox"),d.setAttribute("value","None"),d.setAttribute("name","check");var e=(Wu.DomUtil.create("label","",c),Wu.DomUtil.create("td","name",a),Wu.DomUtil.create("td","tdcont type",a),Wu.DomUtil.create("td","tdcont files",a),Wu.DomUtil.create("td","tdcont category",a),Wu.DomUtil.create("td","tdcont keywords",a),Wu.DomUtil.create("td","tdcont createdDate",a),Wu.DomUtil.create("td","tdcont status",a),Wu.DomUtil.create("td","tdcont uuid",a));Wu.DomUtil.addClass(e,"displayNone");var f={valueNames:["name","file","category","keywords","date","status","type"]};this.list=new List("filelist",f),this.list.clear()},initDZ:function(){app.Dropzone&&app.Dropzone.initDropzone({uploaded:this.uploaded.bind(this),clickable:this._uploader})},refreshDZ:function(){var a=app.Dropzone;a.refresh()},handleError:function(a){app.ErrorPane.setError("Upload error:",a.error,3)},uploaded:function(a,b){if(a.errors&&this.handleError(a.errors),a.files){a.files&&a.files.forEach(function(a){this.project.setFile(a)},this),a.layers&&a.layers.forEach(function(a){this.project.addLayer(a)},this),this.project.refreshSidepane();var c=app.MapPane.cartoCss;c&&c.update(),this.reset(),this.refreshTable()}},addFile:function(a){var b=Wu.extend({},a.getStore()),c={name:b.name||"Title",description:b.description||"Description",nameUuid:"name-"+b.uuid,descUuid:"description-"+b.uuid},d='<input value="'+c.name+'" id="'+c.nameUuid+'" class="dln" readonly="readonly">';d+='<textarea  id="'+c.descUuid+'" class="dld" readonly="readonly">'+c.description+"</textarea>",b.name=d,b.type=b.type.camelize(),b.files=this._createFilePopup(b.files),b.keywords=b.keywords.join(", "),b.createdDate=new Date(b.created).toDateString();var e=this.list.add(b);e[0].elm.id=b.uuid;var f=e[0].elm.children[0].children[0].children;f[0].id="checkbox-"+b.uuid,f[1].setAttribute("for","checkbox-"+b.uuid),this.project.editMode&&this._addFileEditHooks(b.uuid)},_createFilePopup:function(a){var b=a.length,c='<div class="dataLibrary-file-popup-wrap">';return c+='<div class="dataLibrary-file-popup-trigger">'+b+"</div>",c+='<div class="dataLibrary-file-popup-list">Files:<br>',a.forEach(function(a){c+='<div class="dataLibrary-file-popup-item">',c+="• "+a,c+="</div>"},this),c+="</div></div>"},_addFileEditHooks:function(a){var b=Wu.DomUtil.get("name-"+a),c=Wu.DomUtil.get("description-"+a),d=Wu.DomUtil.get(a),e=d.children[4],f=d.children[5];Wu.DomEvent.on(b,"mousedown mouseup click",this.stop,this),Wu.DomEvent.on(b,"dblclick",this.rename,this),Wu.DomEvent.on(c,"mousedown mouseup click",this.stop,this),Wu.DomEvent.on(c,"dblclick",this.rename,this),Wu.DomEvent.on(e,"mousedown mouseup click",this.stop,this),Wu.DomEvent.on(e,"dblclick",this.injectCategory,this),Wu.DomEvent.on(f,"mousedown mouseup click",this.stop,this),Wu.DomEvent.on(f,"dblclick",this.injectKeywords,this)},stop:function(a){a.preventDefault(),a.stopPropagation(),this.closeCategories()},injectCategory:function(a){this.closeCategories(),this.resetSearch();var b=this._injectedUuid=a.target.parentNode.id,c=this.project.getFile(b),d=this._injected=Wu.DomUtil.create("div","datalibrary-category-wrapper"),e=this.project.getCategories();e.forEach(function(a){this.createCategoryLine(d,a,c)},this);var f=Wu.DomUtil.create("div","datalibrary-category-new-wrap",d),g=this._injectedNewline=Wu.DomUtil.create("input","datalibrary-category-new",f);g.setAttribute("placeholder","Add category..."),Wu.DomEvent.on(g,"keydown",this.categoryKeydown,this),Wu.DomEvent.on(g,"mousedown",Wu.DomEvent.stopPropagation,this),d.style.position="absolute",d.style.left=a.x-50+"px",d.style.top=a.y+"px",document.body.appendChild(d),Wu.DomEvent.on(window,"mousedown",this._closeCategories,this)},createCategoryLine:function(a,b,c){var d=Wu.DomUtil.create("div","datalibrary-category-line-wrap",a),e=Wu.DomUtil.create("div","datalibrary-category-line",d,b.camelize()),f=Wu.DomUtil.create("div","datalibrary-category-line-del",d,"X");Wu.DomEvent.on(e,"mousedown",function(a){Wu.DomEvent.stopPropagation(a);var d=b;c.setCategory(d),this.closeCategories(),this.reset(),this.refreshTable()},this),Wu.DomEvent.on(f,"mousedown",function(a){Wu.DomEvent.stopPropagation(a);var c="Are you sure you want to delete category "+b.camelize()+"? This will remove the category from all files.";confirm(c)&&this.removeCategory(b)},this)},removeCategory:function(a){this.project.removeCategory(a);var b=this.project.getFileObjects();for(f in b){var c=b[f];c.getCategory().toLowerCase()==a.toLowerCase()&&c.setCategory("")}this.closeCategories(),this.reset(),this.refreshTable()},closeCategories:function(){this._injected&&Wu.DomUtil.remove(this._injected),Wu.DomEvent.off(window,"mousedown",this._closeCategories,this)},_closeCategories:function(){this.closeCategories()},injectCategoryBlur:function(){this.project.store.files.forEach(function(){},this)},categoryKeydown:function(a){if(13==a.keyCode){var b=this._injectedNewline.value;this.project.addCategory(b);var c=this._injectedUuid,d=this.project.getFile(c);d.setCategory(b),this.closeCategories(),this.reset(),this.refreshTable()}27==a.keyCode&&this.closeCategories()},injectKeywords:function(a){var b=a.target.parentNode.id;this._injectedUuid=b;var c=Wu.DomUtil.create("input","datalibrary-edit-field");c.value=a.target.innerHTML,c.setAttribute("placeholder","Enter value"),c.removeAttribute("readonly"),a.target.innerHTML="",a.target.appendChild(c),c.focus(),Wu.DomEvent.on(c,"blur",this.injectKeywordsBlur,this),Wu.DomEvent.on(c,"keydown",this.editKey,this)},injectKeywordsBlur:function(a){var b=a.target.value,c=a.target.parentNode;c.innerHTML=b;var d=b.split(",");d.forEach(function(a,b,c){c[b]=a.trim()},this);var e=this.project.getFile(this._injectedUuid);e.setKeywords(d)},rename:function(a){a.target.removeAttribute("readonly"),a.target.focus(),a.target.selectionStart=a.target.selectionEnd,a.target.fieldKey=a.target.id.split("-")[0],Wu.DomEvent.on(a.target,"blur",this.editBlur,this),Wu.DomEvent.on(a.target,"keydown",this.editKey,this)},editKey:function(a){(13==event.which||13==event.keyCode)&&a.target.blur()},editBlur:function(a){var b=a.target.fieldKey;a.target.setAttribute("readonly","readonly");var c=a.target.id.replace(b+"-",""),d=a.target.value||a.target.innerHTML;this.project.store.files.forEach(function(a){a.uuid==c&&(a[b]=d)},this),this.list.update(),this._save(c,b),"name"==b&&this.updateLayerName(c,d)},updateLayerName:function(a,b){var c=this.project.getLayerFromFile(a);c&&c.setTitle(b)},_save:function(a,b){this.project.store.files.forEach(function(c){if(c.uuid==a){var d={};d[b]=c[b],d.uuid=c.uuid;var e=JSON.stringify(d);Wu.save("/api/file/update",e)}}),app.setSaveStatus()},updateContent:function(){this.update()},update:function(){this.project=Wu.app.activeProject,this.reset(),this.refreshDZ(),this.refreshTable(),this.project.editMode?this.addEditHooks():this.removeEditHooks();var a=app.MapPane.cartoCss;a&&a.update()},refreshTable:function(){if(this.project.files){for(f in this.project.files){var a=this.project.files[f];this.addFile(a)}this.list.sort("name",{order:"asc"})}},reset:function(){this.list.clear()}}),Wu.SidePane.MediaLibrary=Wu.SidePane.Item.extend({type:"mediaLibrary",title:"Media",initContent:function(){this._content=Wu.DomUtil.create("div","fullpage-mediaLibrary",Wu.app._appPane),this._container=Wu.DomUtil.create("div","editor-wrapper",this._content,ich.mediaLibrary({media:"this is media!"})),this._innerContent=Wu.DomUtil.get("mediaLibrary-inner-content"),this._leftImage={},this._leftImage.innerSlider=Wu.DomUtil.get("mediaLibrary-inner-slider-left"),this._leftImage.grabGrid=Wu.DomUtil.get("mediaLibrary-grabgrid-left"),this._leftImage.Image=Wu.DomUtil.get("mediaLibrary-image-container-left"),this._leftImage.Image.img=this._leftImage.Image.getElementsByTagName("img")[0],this._leftImage.nativeResolution=Wu.DomUtil.get("mediaLibrary-data-resolution-l"),this._leftImage.filename=Wu.DomUtil.get("mediaLibrary-data-filename-l"),this._leftImage.fileCaptured=Wu.DomUtil.get("mediaLibrary-data-captured-l"),this._leftImage.fileUploaded=Wu.DomUtil.get("mediaLibrary-data-uploaded-l"),this._leftImage.fileUploadedBy=Wu.DomUtil.get("mediaLibrary-data-uploaded-by-l"),this._leftImage.percent=Wu.DomUtil.get("mediaLibrary-percent-left-side"),this._leftImage.zoomIn=Wu.DomUtil.get("mediaLibrary-zoom-in-left"),this._leftImage.zoomOut=Wu.DomUtil.get("mediaLibrary-zoom-out-left"),this._rightImage={},this._rightImage.innerSlider=Wu.DomUtil.get("mediaLibrary-inner-slider-right"),this._rightImage.grabGrid=Wu.DomUtil.get("mediaLibrary-grabgrid-right"),this._rightImage.Image=Wu.DomUtil.get("mediaLibrary-image-container-right"),this._rightImage.Image.img=this._rightImage.Image.getElementsByTagName("img")[0],this._rightImage.nativeResolution=Wu.DomUtil.get("mediaLibrary-data-resolution-r"),this._rightImage.filename=Wu.DomUtil.get("mediaLibrary-data-filename-r"),this._rightImage.fileCaptured=Wu.DomUtil.get("mediaLibrary-data-captured-r"),this._rightImage.fileUploaded=Wu.DomUtil.get("mediaLibrary-data-uploaded-r"),this._rightImage.fileUploadedBy=Wu.DomUtil.get("mediaLibrary-data-uploaded-by-r"),this._rightImage.percent=Wu.DomUtil.get("mediaLibrary-percent-right-side"),this._rightImage.zoomIn=Wu.DomUtil.get("mediaLibrary-zoom-in-right"),this._rightImage.zoomOut=Wu.DomUtil.get("mediaLibrary-zoom-out-right")},_addHooks:function(){Wu.DomEvent.on(this._leftImage.zoomIn,"mousedown",function(){this.zoomImg("left","in")},this),Wu.DomEvent.on(this._leftImage.zoomIn,"mouseup",function(){this.zoomImg_stop("left")},this),Wu.DomEvent.on(this._leftImage.zoomOut,"mousedown",function(){this.zoomImg("left","out")},this),Wu.DomEvent.on(this._leftImage.zoomOut,"mouseup",function(){this.zoomImg_stop("left")},this),Wu.DomEvent.on(this._rightImage.zoomIn,"mousedown",function(){this.zoomImg("right","in")},this),Wu.DomEvent.on(this._rightImage.zoomIn,"mouseup",function(){this.zoomImg_stop("right")},this),Wu.DomEvent.on(this._rightImage.zoomOut,"mousedown",function(){this.zoomImg("right","out")},this),Wu.DomEvent.on(this._rightImage.zoomOut,"mouseup",function(){this.zoomImg_stop("right")},this)},zoomImg:function(a,b){var c;if("left"==a)var c=this._leftImage,d=this.images[this._currentActiveLeft].file.data.image.dimensions.width;if("right"==a)var c=this._rightImage,d=this.images[this._currentActiveRight].file.data.image.dimensions.width;var e=(c.Image.img,c.Image.img),f=e.offsetWidth,g=e.offsetHeight,h=e.offsetLeft,i=e.offsetTop,j=g/f,k=c.Image.offsetWidth,l=c.Image.offsetHeight;this.imgZooming=setInterval(function(){zoomIndex="in"==b?f/100:-f/100,f+=zoomIndex;var a=zoomIndex*j;g+=a,KOPercentLeft=(-h+k/2)/f,KOPercentTop=(-i+l/2)/g,leftZoomIndex=zoomIndex*KOPercentLeft,h-=leftZoomIndex,topZoomIndex=zoomIndex*j*KOPercentTop,i-=topZoomIndex;var m=Math.round(f/d*100);c.percent.innerHTML=m,e.style.width=f+"px",e.style.height=g+"px",e.style.left=h+"px",e.style.top=i+"px"},10)},zoomImg_stop:function(a){clearInterval(this.imgZooming),"left"==a&&this.__leftImageUpdate()},__leftImageUpdate:function(){var a=app.options.servers.portal+"pixels/",b=this.images[this._currentActiveLeft],c=(b.file.data.image.dimensions.width,b.file.data.image.dimensions.height,this._leftImage.Image.img.offsetWidth),d=this._leftImage.Image.img.offsetHeight,e=this._leftImage.Image.offsetWidth,f=this._leftImage.Image.offsetHeight,g=this._leftImage.Image.img.offsetLeft,h=this._leftImage.Image.img.offsetTop;g>0&&(g=0),h>0&&(h=0);var i=a;i+=b.file.uuid,i+="?width="+c,i+="&height="+d,i+="&cropw="+e,i+="&croph="+f,i+="&cropx="+Math.abs(g),i+="&cropy="+Math.abs(h);var j=new Image,k=this;j.onload=function(){k._rightImage.Image.img.style.top="0px",k._rightImage.Image.img.style.left="0px",k._rightImage.Image.img.src=j.src},j.src=i},removeHooks:function(){},addEditHooks:function(){},removeEditHooks:function(){},deactivate:function(){},updateContent:function(){this.update()},update:function(){this.project=app.activeProject,this.reset(),this.refresh(),this.addEditHooks()},thumbClick:function(a,b){var c=this.images[a];if("left"==b){var d=this._leftImage;this._currentActiveLeft=a}if("right"==b){var d=this._rightImage;this._currentActiveRight=a}d.Image.img.removeAttribute("style");var e=app.options.servers.portal+"pixels/",f=c.file.data.image.dimensions.width,g=c.file.data.image.dimensions.height;d.nativeResolution.innerHTML=f+" x "+g+" pixels",d.filename.innerHTML=c.file.name,d.fileCaptured.innerHTML=new Date(c.file.data.image.created).toDateString();var h=new Date(c.file.created).toDateString();d.fileUploaded.innerHTML=h,d.fileUploadedBy.innerHTML=c.file.createdByName;var i=d.Image.offsetWidth,j=Math.round(i/f*100);d.percent.innerHTML=j;var k=f/g;k>=1?(Wu.DomUtil.addClass(d.Image,"landscape",this),Wu.DomUtil.removeClass(d.Image,"portrait",this)):(Wu.DomUtil.removeClass(d.Image,"landscape",this),Wu.DomUtil.addClass(d.Image,"portrait",this));var l=900,m=l/f,n=g*m,o=d.Image.offsetWidth,p=d.Image.offsetHeight,q=o/l,r=n*q,s=p/2-r/2;d.Image.img.style.top=Math.round(s)+"px",d.Image.img.src=e+a+"?width="+l+"&height="+n},refresh:function(){var a=this.project.getFiles(),b="http://85.10.202.87:8080/pixels/",c=_.filter(a,function(a){return a.format.indexOf("jpg")>-1});this.images={},c.forEach(function(a){var c=this.images[a.uuid]={};c.file=a,c.left={},c.left.div=Wu.DomUtil.create("div","mediaLibrary-slider-thumb",this._leftImage.innerSlider),c.left.img=Wu.DomUtil.create("img","",c.left.div),c.left.img.src=b+a.uuid+"?width=145&height=500",c.right={},c.right.div=Wu.DomUtil.create("div","mediaLibrary-slider-thumb",this._rightImage.innerSlider),c.right.img=Wu.DomUtil.create("img","",c.right.div),c.right.img.src=b+a.uuid+"?width=145&height=500",Wu.DomEvent.on(c.left.div,"click",function(){this.thumbClick(a.uuid,"left")},this),Wu.DomEvent.on(c.right.div,"click",function(){this.thumbClick(a.uuid,"right")},this)},this),this._imgDraggable(),this._addHooks()},_imgDraggable:function(){var a=this._leftImage.grabGrid;Wu.DomEvent.on(a,"mousedown",function(){this._initDragging()},this),Wu.DomEvent.on(a,"mousemove",function(a){this._draggingImage(a)},this),this.__x_pos=0,this.__y_pos=0,this.__x_elem=0,this.__y_elem=0},_initDragging:function(){return this.__x_elem=this.__x_pos-this._leftImage.Image.img.offsetLeft,this.__y_elem=this.__y_pos-this._leftImage.Image.img.offsetTop,this._draggingLeftImage=!0,!1},_draggingImage:function(a){if(this.__x_pos=document.all?window.event.clientX:a.pageX,this.__y_pos=document.all?window.event.clientY:a.pageY,this._draggingLeftImage){var b=this.__x_pos-this.__x_elem,c=this.__y_pos-this.__y_elem,d=this._leftImage.Image.img.offsetLeft-b,e=this._rightImage.Image.img.offsetLeft,f=this._leftImage.Image.img.offsetTop-c,g=this._rightImage.Image.img.offsetTop;this._leftImage.Image.img.style.left=b+"px",this._leftImage.Image.img.style.top=c+"px",this._rightImage.Image.img.style.left=e-d+"px",this._rightImage.Image.img.style.top=g-f+"px"}},_stopDragging:function(){this._draggingLeftImage=!1,this.__leftImageUpdate()},reset:function(){this.removeHooks()}}),Wu.SidePane.Share=Wu.SidePane.Item.extend({type:"share",title:"Share",initContent:function(){this.initLayout()},update:function(){this.reset(),this.project=app.activeProject,this.options.panes.share&&this.project.getSettings().share&&this.initLayout(),this.initLayout(),this.addHooks()},addHooks:function(){this.removeHooks(),Wu.DomEvent.on(this.imageButton,"click",this.createImage,this),Wu.DomEvent.on(this.printButton,"click",this.createPrint,this),Wu.DomEvent.on(this.linkButton,"click",this.createLink,this)},removeHooks:function(){Wu.DomEvent.off(this.imageButton,"click",this.createImage,this),Wu.DomEvent.off(this.printButton,"click",this.createPrint,this),Wu.DomEvent.off(this.linkButton,"click",this.createLink,this)},initLayout:function(){{var a=Wu.DomUtil.create("div","share-wrapper",this._content);Wu.DomUtil.create("div","share-header",a,"Publish")}this.imageButton=Wu.DomUtil.create("div","share-wrap image",a);Wu.DomUtil.create("div","share-icon-box image",this.imageButton),Wu.DomUtil.create("div","share-title image",this.imageButton,"Image"),Wu.DomUtil.create("div","share-subtitle image",this.imageButton,"Create snapshot of map");this.printButton=Wu.DomUtil.create("div","share-wrap print",a);Wu.DomUtil.create("div","share-icon-box print",this.printButton),Wu.DomUtil.create("div","share-title print",this.printButton,"PDF"),Wu.DomUtil.create("div","share-subtitle print",this.printButton,"Create printable map");this.linkButton=Wu.DomUtil.create("div","share-wrap link",a);Wu.DomUtil.create("div","share-icon-box link",this.linkButton),Wu.DomUtil.create("div","share-title link",this.linkButton,"Link"),Wu.DomUtil.create("div","share-subtitle link",this.linkButton,"Create share link");app.Tooltip.add(this._menu,"Create image, PDF or link to project. The link will hold your current view (zoom, coordinates and active layers).")},createImage:function(){var a=this;app.setHash(function(b,c){a._createImageView(),Wu.post("/api/util/snapshot",c,a.createdImage,a)}),app.ProgressBar.timedProgress(2e3)},createdImage:function(a,b){var c=JSON.parse(b),d=c.image,e=a._imageContainer.offsetHeight,f=a._imageContainer.offsetWidth,g=app.options.servers.portal;g+="pixels/",g+=d;var h=g;g+="?width="+f,g+="&height="+e;var i='url("';i+=g,i+='")',a._imageContainer.style.backgroundImage=i,h+="?raw=true",a._downloadButton.href=h},_createImageView:function(){this._resetExpands(),Wu.DomUtil.addClass(this._content,"expand-share-image"),this._imageWrap=Wu.DomUtil.create("div","share-image-wrap",this._content);Wu.DomUtil.create("div","share-image-title",this._imageWrap,"Created image:");this._imageContainer=Wu.DomUtil.create("div","share-image-image",this._imageWrap);var a=Wu.DomUtil.create("div","share-image-meta-wrap",this._imageWrap),b=(Wu.DomUtil.create("div","share-image-meta-size",a),Wu.DomUtil.create("div","share-image-meta-name",a),Wu.DomUtil.create("div","share-image-download",this._imageWrap));this._downloadButton=Wu.DomUtil.create("a","share-image-download-button",b,"Download"),this._downloadButton.setAttribute("target","_blank")},createLink:function(){app.setHash(function(a,b){this._createLinkView(b)}.bind(this))},_createLinkView:function(a){var b=JSON.parse(a),c=b.hash,d=app.Projects[c.project],e=d.getSlugs(),f=app.options.servers.portal+e.client+"/"+e.project+"/"+c.id;this._resetExpands(),this._inputWrap=Wu.DomUtil.create("div","share-link-wrap",this._content);var g=(Wu.DomUtil.create("div","share-link-title",this._inputWrap,"Share this link:"),Wu.DomUtil.create("input","share-link-input",this._inputWrap));g.value=f,Wu.DomEvent.on(g,"click",function(){g.setSelectionRange(0,g.value.length)},this),Wu.DomUtil.addClass(this._content,"expand-share-link")},createPrint:function(){var a=this;app.setHash(function(b,c){Wu.post("/api/util/pdfsnapshot",c,a.createdPrint,a)}),app.ProgressBar.timedProgress(2e3)},createdPrint:function(a,b){var c=JSON.parse(b),d=c.pdf,e="/api/file/download?file="+d+"&type=file";a._createPrintView(e)},_createPrintView:function(a){this._resetExpands(),this._inputWrap=Wu.DomUtil.create("div","share-link-wrap",this._content);var b=(Wu.DomUtil.create("div","share-link-title",this._inputWrap,"Download the PDF:"),Wu.DomUtil.create("div","share-print-download",this._inputWrap));this._pdfDownloadButton=Wu.DomUtil.create("a","share-print-download-button",b,"Download"),this._pdfDownloadButton.setAttribute("href",a),Wu.DomUtil.addClass(this._content,"expand-share-link")},_resetExpands:function(){this._inputWrap&&Wu.DomUtil.remove(this._inputWrap),this._imageWrap&&Wu.DomUtil.remove(this._imageWrap),this._printWrap&&Wu.DomUtil.remove(this._printWrap),Wu.DomUtil.removeClass(this._content,"expand-share-link"),Wu.DomUtil.removeClass(this._content,"expand-share-image"),Wu.DomUtil.removeClass(this._content,"expand-share-print")},reset:function(){this.removeHooks(),this._content.innerHTML="",this._resetExpands()},_activate:function(){app.SidePane.widenContainer()},_deactivate:function(){this._resetExpands()},enableSocial:function(){},disableSocial:function(){},enableScreenshot:function(){},disableScreenshot:function(){}}),Wu.SidePane.Account=Wu.SidePane.Item.extend({_:"sidepane.account",type:"account",title:"Logout",initContent:function(){this._account=app.Account,this._content.innerHTML="",app.Tooltip.add(this._menu,"Logs you out of the portal")},addHooks:function(){},update:function(){},_logout:function(){},_clickActivate:function(){confirm("Are you sure you want to log out?")&&(window.location.href=app.options.servers.portal+"logout")}}),Wu.HeaderPane=Wu.Class.extend({_:"headerpane",initialize:function(){return this.options={},this.options.editMode=!1,this._initContainer(),this},_initContainer:function(){this._container=Wu.app._headerPane=Wu.DomUtil.create("div","displayNone",Wu.app._mapContainer),this._container.id="header",this._logoContainer=Wu.DomUtil.create("div","header-logo-container",this._container),this._logo=Wu.DomUtil.create("img","header-logo",this._logoContainer),this._titleWrap=Wu.DomUtil.create("div","header-title-wrap",this._container),this._title=Wu.DomUtil.create("div","header-title editable",this._titleWrap),this._subtitle=Wu.DomUtil.create("div","header-subtitle editable",this._titleWrap),this._title.whichTitle="title",this._subtitle.whichTitle="subtitle",app.Tooltip.add(this._logo,"Click to upload a new logo"),Wu.DomEvent.on(this._logo,"mouseover",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._title,"mouseover",Wu.DomEvent.stopPropagation,this)},getContainer:function(){return this._container},addHooks:function(){},addEditHooks:function(){this.logodz?this.logodz.enable():this.addDropzone(),Wu.DomUtil.addClass(this._logo,"editable")},removeEditHooks:function(){this.logodz&&this.logodz.disable(),Wu.DomUtil.removeClass(this._logo,"editable")},addDropzone:function(){this.logodz=new Dropzone(this._logo,{url:"/api/upload/image",createImageThumbnails:!1,autoDiscover:!1})},refreshDropzone:function(){var a=this;this.logodz.options.params.project=this.project.store.uuid,this.logodz.on("success",function(b,c){a.addedLogo(c)})},addedLogo:function(a){var b="/images/"+a,c=this.project;c.setHeaderLogo(b);var d=c.getHeaderLogo()?c.getHeaderLogo():"/css/images/defaultProjectLogo.png";this._logo.src=d},disableResize:function(){},enableResize:function(){},_enableEdit:function(a,b){var c=a.target,d=a.target.innerHTML,b=a.target.whichTitle;if(b){if("title"==b)var e=Wu.DomUtil.create("input","header-title editable");if("subtitle"==b)var e=Wu.DomUtil.create("input","header-subtitle");e.value=d,c.innerHTML="",c.appendChild(e);var f=e;f.focus(),f.selectionStart=f.selectionEnd,Wu.DomEvent.on(f,"blur",this._editBlur,this),Wu.DomEvent.on(f,"keydown",this._editKey,this)}},_editBlur:function(a){var b=a.target.value,c=a.target.parentNode;c.innerHTML=b,this.save()},_editKey:function(a){(13==event.which||13==event.keyCode)&&a.target.blur()},setTitle:function(a){this._title.innerHTML=a},setSubtitle:function(a){this._subtitle.innerHTML=a},_setLeft:function(a){this._container.style.left=a+"px"},_update:function(a){this.update(a)},update:function(a){this.project=a,this._container.style.display="block";var b=a.getHeaderLogo()?a.getHeaderLogo():"/css/images/defaultProjectLogo.png";this._logo.src=b,this._title.innerHTML=a.getHeaderTitle(),this._subtitle.innerHTML=a.getHeaderSubtitle(),a.editMode?(this.addEditHooks(),this.refreshDropzone()):this.removeEditHooks()},getHeight:function(){return this._headerHeight},reset:function(){Wu.app.HeaderPane._title.innerHTML="",Wu.app.HeaderPane._subtitle.innerHTML="",Wu.app.HeaderPane._logo.src=""},_resetView:function(){},resize:function(){},_resize:function(a){return},_resized:function(){this._resizer.style.backgroundColor="",window.onmousemove=null,this.save(),setTimeout(function(){var a=Wu.app._map;a&&a.reframe()},300)},save:function(){this.project.store.header.height=this._headerHeight,this.project.store.header.title=this._title.innerHTML,this.project.store.header.subtitle=this._subtitle.innerHTML;var a=this._logo.src.slice(4).slice(0,-1);this.project.store.header.logo=a,this._save()},_save:function(){this.project._update("header")},setProject:function(a){this._update(a)}}),Wu.ProgressPane=Wu.Class.extend({initialize:function(a){Wu.setOptions(this,a),this.initContainer()},initContainer:function(){this._progressBar=app._progressBar=app._progressBar||Wu.DomUtil.create("div","status-progress-bar",app._appPane),this.options.addTo&&this.addTo(this.options.addTo)},addTo:function(){var a=this.options.addTo;a.appendChild(this._progressBar)},setProgress:function(a){if(!(a<this._current+2)){var b=this._progressBar;b.style.opacity=1,b.style.width=a+"%",this._current=a}},hideProgress:function(){var a=this._progressBar;a.style.opacity=0,this._current=0,a.style.width=0},timedProgress:function(a){var b=a||5e3,c=10,d=0,e=parseInt(b)/c;this._timedProgress(d,e,c)},_timedProgress:function(a,b,c){var d=this;a+=100/c,this.setProgress(a),setTimeout(function(){return 100>a?d._timedProgress(a,b,c):void d.hideProgress()},b)}}),Wu.MapPane=Wu.Class.extend({initialize:function(){return this._initContainer(),this._activeLayers=[],this._baselayerZIndex=new Wu.ZIndexControl.Baselayers,this._layermenuZIndex=new Wu.ZIndexControl.Layermenu,this},_initContainer:function(){this._container=app._mapPane=Wu.DomUtil.createId("div","map",app._mapContainer),Wu.DomUtil.addClass(this._container,"click-to-start")},resizeEvent:function(a){this._updateWidth(a)},_updateWidth:function(a){var b=this._map;b&&a&&(b._container.style.width=a.width-parseInt(b._container.offsetLeft)+"px",setTimeout(function(){b&&b.reframe()},300))},setProject:function(a){this.project=a,this.reset(),this.update(a)},getZIndexControls:function(){var a={b:this._baselayerZIndex,l:this._layermenuZIndex};return a},clearBaseLayers:function(){var a=this._map;this.baseLayers&&(this.baseLayers.forEach(function(b){a.removeLayer(b.layer)}),this.baseLayers={})},setBaseLayers:function(){this._map;this.clearBaseLayers();var a=this.project.getBaselayers();a&&a.forEach(function(a){this.addBaseLayer(a)},this)},addBaseLayer:function(a){var b=this.project.layers[a.uuid];b&&(b.add("baselayer"),b.setOpacity(a.opacity))},removeBaseLayer:function(){map.removeLayer(base.layer)},_setLeft:function(a){this._container.style.left=a+"px",this._container.style.width=parseInt(window.innerWidth)-a+"px"},_update:function(a){this.update(a)},update:function(a){this.project=a,this.clearActiveLayers(),this._isEditor=app.Account.canUpdateProject(app.activeProject.getUuid()),this.setBaseLayers(),this.setMaxBounds(),this.setPosition(),this.setHeaderPadding(),setTimeout(this.updateControlCss.bind(this),100)},setHeaderPadding:function(){var a=this._map,b=a._controlContainer;b.style.paddingTop=this.project.getHeaderHeight()+"px"},setPosition:function(a){var b=this._map,c=a||this.project.getLatLngZoom(),d=c.lat,e=c.lng,f=c.zoom;
void 0!=d&&void 0!=e&&void 0!=f&&b.setView([d,e],f)},getPosition:function(){var a=this._map.getCenter(),b={lat:a.lat,lng:a.lng,zoom:this._map.getZoom()};return b},getActiveLayermenuLayers:function(){if(this.layerMenu){var a=app.zIndex,b=this.layerMenu.getLayers(),c=_.filter(b,function(a){return a.on}),d=_.sortBy(c,function(b){return a.get(b.layer)});return d}},getActiveLayers:function(){return this._activeLayers},addActiveLayer:function(a){this._activeLayers.push(a)},clearActiveLayers:function(){this._activeLayers=[]},removeActiveLayer:function(a){_.remove(this._activeLayers,function(b){return b.getUuid()==a.getUuid()},this)},setMaxBounds:function(){var a=app._map,b=this.project.getBounds();if(b){var c=L.latLng(b.southWest.lat,b.southWest.lng),d=L.latLng(b.northEast.lat,b.northEast.lng),e=L.latLngBounds(c,d);a.setMaxBounds(e),a.options.minZoom=b.minZoom,a.options.maxZoom=b.maxZoom}},_reset:function(){this.reset()},createNewMap:function(){var a={worldCopyJump:!0,attributionControl:!1},b=this.project.getLatLngZoom(),c=b.lat,d=b.lng,e=b.zoom;this._map=app._map=L.map("map",a).setView([c,d],e),this.addEditableLayer(this._map),this._attributionControl=L.control.attribution({position:"bottomright",prefix:'Powered by <a href="http://systemapic.com/" target="_blank">Systemapic.com</a> ©'}),this._map.addControl(this._attributionControl)},addEditableLayer:function(a){this.editableLayers=new L.FeatureGroup,a.addLayer(this.editableLayers)},reset:function(){var a=this._map;a&&(a.eachLayer(function(b){a.removeLayer(b)}),a.remove()),this.createNewMap(),this._updateWidth(),this.resetControls(),this.disableZoom()},updateControlCss:function(){var a=this.project.getControls(),b=app._map._controlCorners,c=(b.topleft,b.bottomright),d=b.topright;if(a.layermenu&&(a.inspect?Wu.DomUtil.removeClass(c,"no-inspector"):Wu.DomUtil.addClass(c,"no-inspector")),a.legends){var e=this.legendsControl._legendsContainer;a.layermenu?Wu.DomUtil.removeClass(e,"legends-padding-right"):Wu.DomUtil.addClass(e,"legends-padding-right"),a.description}a.measure&&(d.style.right=a.layermenu?"295px":"6px"),a.mouseposition,a.vectorstyle,a.zoom,a.baselayertoggle,a.description,a.draw,a.geolocation,a.inspect},resetControls:function(){delete this._drawControl,delete this._drawControlLayer,delete this._scale,delete this.vectorStyle,delete this.layerMenu,delete this.legendsControl,delete this.descriptionControl,delete this.inspectControl,delete this.mousepositionControl,delete this.baselayerToggle,delete this.geolocationControl,this.cartoCss&&this.cartoCss.destroy(),delete this.cartoCss},refreshControls:function(){},hideControls:function(){Wu.DomUtil.addClass(app._map._controlContainer,"displayNone")},showControls:function(){Wu.DomUtil.removeClass(app._map._controlContainer,"displayNone")},addLayer:function(a){var b=L.mapbox.tileLayer(a);b.addTo(this._map)},_addLayer:function(a){a.addto(this._map)},disableInteraction:function(a){var b=this._map;a&&b.dragging.disable(),b.touchZoom.disable(),b.doubleClickZoom.disable(),b.scrollWheelZoom.disable(),b.boxZoom.disable(),b.keyboard.disable()},enableInteraction:function(a){var b=this._map;a&&b.dragging.enable(),b.touchZoom.enable(),b.doubleClickZoom.enable(),b.scrollWheelZoom.enable(),b.boxZoom.enable(),b.keyboard.enable()},disableZoom:function(){this._map.touchZoom.disable(),this._map.doubleClickZoom.disable(),this._map.scrollWheelZoom.disable(),this._map.boxZoom.disable(),this._map.keyboard.disable(),document.getElementsByClassName("leaflet-control-zoom")[0].style.display="none"},enableZoom:function(){this._map.touchZoom.enable(),this._map.doubleClickZoom.enable(),this._map.scrollWheelZoom.enable(),this._map.boxZoom.enable(),this._map.keyboard.enable(),document.getElementsByClassName("leaflet-control-zoom")[0].style.display="block"},enableLegends:function(){this.legendsControl||(this.legendsControl=L.control.legends({position:"bottomleft"}),this.legendsControl.addTo(this._map),this.legendsControl.update())},disableLegends:function(){this.legendsControl&&(this._map.removeControl(this.legendsControl),delete this.legendsControl)},enableMouseposition:function(){this.mousepositionControl||(this.mousepositionControl=L.control.mouseposition({position:"topright"}),this.mousepositionControl.addTo(this._map))},disableMouseposition:function(){this.mousepositionControl&&(this._map.removeControl(this.mousepositionControl),delete this.mousepositionControl)},enableGeolocation:function(){this.geolocationControl||(this.geolocationControl=new L.Control.Search({url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],boundingBox:"boundingbox",filterJSON:function(a){var b,c=[];for(b in a){var d=a[b];if(d.hasOwnProperty("type"))var e={address:d.display_name,boundingbox:d.boundingbox,latlng:L.latLng(d.lat,d.lon),type:d.type};c.push(e)}var f=_.unique(c,function(a){return a?a.address:void 0});return f}}),this.geolocationControl.addTo(this._map))},disableGeolocation:function(){this.geolocationControl&&(this._map.removeControl(this.geolocationControl),delete this.geolocationControl)},enableMeasure:function(){this._scale||(this._scale=L.control.scale({position:"topright"}),this._scale.addTo(this._map))},disableMeasure:function(){this._scale&&(this._map.removeControl(this._scale),delete this._scale)},enableDescription:function(){this.descriptionControl||(this.descriptionControl=L.control.description({position:"topleft"}),this.descriptionControl.addTo(this._map),this.descriptionControl.update())},disableDescription:function(){this.descriptionControl&&(this._map.removeControl(this.descriptionControl),delete this.descriptionControl)},enableInspect:function(){this.inspectControl||(this.inspectControl=L.control.inspect({position:"bottomright"}),this.inspectControl.addTo(this._map),this.inspectControl.update())},enableCartocss:function(){return!this.cartoCss&&this._isEditor?(this.cartoCss=L.control.cartoCss({position:"topleft"}),this.cartoCss.addTo(this._map),app.activeProject&&this.cartoCss.update(),this.cartoCss):void 0},disableCartocss:function(){this.cartoCss&&(this._map.removeControl(this.cartoCss),delete this.cartoCss)},disableInspect:function(){this.inspectControl&&(this._map.removeControl(this.inspectControl),delete this.inspectControl)},enableLayermenu:function(){return this.layerMenu?void 0:(this.layerMenu=L.control.layermenu({position:"bottomright"}),this.layerMenu.addTo(this._map),this.layerMenu.update(),this.layerMenu)},disableLayermenu:function(){this.layerMenu&&(this._map.removeControl(this.layerMenu),delete this.layerMenu)},enableBaselayertoggle:function(){return this.baselayerToggle?void 0:(this.baselayerToggle=L.control.baselayerToggle(),this.baselayerToggle.addTo(this._map),this.baselayerToggle.update(),this.baselayerToggle)},disableBaselayertoggle:function(){this.baselayerToggle&&(this._map.removeControl(this.baselayerToggle),delete this.baselayerToggle)},enableVectorstyle:function(){},disableVectorstyle:function(){},enableDraw:function(){this._drawControl||this.addDrawControl()},disableDraw:function(){this._drawControl&&"undefined"!==this._drawControl&&this.removeDrawControl()},removeDrawControl:function(){this._drawControl&&"undefined"!==this._drawControl&&(this._map.removeControl(this._drawControl),this._drawControl=!1,this.disableVectorstyle())},addDrawControl:function(){{var a=this._map;this.editableLayers}options={position:"topleft",draw:{circle:{shapeOptions:{fill:!0,color:"#FFF",fillOpacity:.3}},rectangle:{shapeOptions:{fill:!0,color:"#FFF",fillOpacity:.3,fillColor:"#FFF"}},polygon:{shapeOptions:{fill:!0,color:"#FFF",fillOpacity:.3,fillColor:"#FFF"}},polyline:{shapeOptions:{fill:!1,color:"#FFF"}}}};var b=this._drawControl=new L.Control.Draw(options);a.addControl(b);var c=b._container;L.DomUtil.addClass(c,"elizaveta"),Wu.DomEvent.on(b,"mousemove",L.DomEvent.stop,this),Wu.DomEvent.on(b,"mouseover",a.closePopup,this),Wu.DomEvent.on(c,"mousedown mouseup click",L.DomEvent.stopPropagation,this),a.on("draw:created",function(a){a.layer.layerType=a.layerType,app._map.addLayer(a.layer)})},getEditableLayerParent:function(a){var b=this.editableLayers._layers;for(l in b)for(m in b[l]._layers){if(m==a)return b[l];var c=b[l]._layers[m];for(n in c){var d=c[n];if(n==a)return c;for(o in d){{d[o]}if(o==a)return d}}}return!1},_addPopupContent:function(a){var b=this._createPopupContent(a),c="<hr>";this._popup=null,b&&(this._popupContent?this._popupContent+=c:this._popupContent="",this._popupContent+=b)},_clearPopup:function(){this._popupContent="",this._popup=null},openPopup:function(a){if(!this._popup){var b=this._createPopup(),c=this._popupContent,d=app._map,e=a.latlng;if(!c)return this._clearPopup();this._addPopupCloseEvent(),this._popup=b,b.setContent(c),b.setLatLng(e),setTimeout(function(){b.openOn(d)},100)}},_createPopup:function(){var a=L.popup({offset:[18,0],closeButton:!0,zoomAnimation:!1,maxWidth:400,minWidth:200,maxHeight:350});return a},_addPopupCloseEvent:function(){if(!this._popInit){this._popInit=!0;var a=app._map;a.on("popupclose",this._clearPopup,this)}},_createPopupContent:function(a){var b=a.data,c=a.layer,d=c.getTooltip(),e="";if(d){d.title&&(e+='<div class="tooltip-title-small">'+d.title+"</div>");for(var f in d.fields){var g=d.fields[f];if(g.on){var h=g.title||g.key,i=b[g.key];e+=h+": "+i+"<br>"}}return e}var e="";for(var j in b){var i=b[j];"NULL"!=i&&"null"!=i&&null!=i&&""!=i&&"undefined"!=i&&"__sid"!=j&&(e+=j+": "+i+"<br>")}return e}}),Wu.StatusPane=Wu.Class.extend({_:"statuspane",initialize:function(a){Wu.setOptions(this,a),this.initContainer(),this.addHooks()},initContainer:function(){{var a=this._container=Wu.DomUtil.create("div","home-container"),b=(this._logo=Wu.DomUtil.create("div","home-logo",a),this._statusWrap=Wu.DomUtil.create("div","home-status-wrap",a)),c=Wu.DomUtil.create("div","home-status",b);Wu.DomUtil.create("div","home-status-inner",c)}this.clearStatus(),this.options.addTo&&this.addTo(this.options.addTo),app.Tooltip.add(this._container,"This is the main menu. Here you can change projects, view documents, download files, etc.",{"extends":"systyle",tipJoint:"bottom right"})},addHooks:function(){Wu.DomEvent.on(this._container,"mousedown",this.toggle,this)},tab:function(a){9==a.keyCode&&this.toggle()},toggle:function(){this.isOpen?this.close():this.open(),this.cleaningJobs()},cleaningJobs:function(){var a=Wu.app.MapPane.layerMenu;a&&a.disableEdit(),app.SidePane.Map.closeAll()},open:function(){this.isOpen=!0,app.SidePane&&app.SidePane.expand(),this.refresh(),this.checkMapBlur(),this.setContentHeights(),app._activeMenu._activate(),app._map&&(app._map._controlCorners.topleft.style.opacity=0),app.MapPane.descriptionControl;var a=app.MapPane.layerMenu;a&&a.disableEdit(),app.StartPane.isOpen&&(app.StartPane._banner.style.opacity="0.1"),Wu.app.mobile&&app.MapPane&&(app.MapPane.layerMenu&&(app.MapPane.layerMenu.closeLayerPane(),app.MapPane.layerMenu._openLayers.style.opacity=0),app.MapPane.legendsControl&&(app.MapPane.legendsControl._isOpen&&app.MapPane.legendsControl.MobileCloseLegends(),app.MapPane.legendsControl._legendsOpener.style.opacity=0),app.MapPane.descriptionControl&&(app.MapPane.descriptionControl._isClosed||app.MapPane.descriptionControl.mobileClosePane()))},close:function(){this.isOpen=!1,app.SidePane&&app.SidePane.collapse(),this.refresh();var a=app.MapPane,b=a.descriptionControl;if(Wu.DomUtil.removeClass(app.MapPane._container,"map-blur"),app._map){var c=app._map._controlCorners.topleft;c.style.opacity=1,c.style.display="block"}app.StartPane.isOpen&&(app.StartPane._banner.style.opacity="1"),app.mobile&&(a&&(a.layerMenu&&(a.layerMenu._openLayers.style.opacity=1),a.legendsControl&&(a.legendsControl._legendsOpener.style.opacity=1),a.descriptionControl&&(a.descriptionControl._button.style.opacity=1),app.SidePane.fullscreen&&app.SidePane.Clients.activate()),app._map._controlContainer.style.opacity=1),b&&b.activeLayer&&(""!=b.activeLayer.store.description&&b.activeLayer.store.description||b.hide())},setContentHeights:function(){var a=app.SidePane.Clients,b=app.SidePane.Map;a&&a.setContentHeight(),b&&b.setContentHeight()},checkMapBlur:function(){("documents"==app._activeMenuItem||"dataLibrary"==app._activeMenuItem||"users"==app._activeMenuItem)&&Wu.DomUtil.addClass(app.MapPane._container,"map-blur")},addTo:function(a,b){b?a.insertBefore(this._container,a.firstChild):a.appendChild(this._container)},setHeight:function(a){this._container.style.height=parseInt(a)+"px"},refresh:function(){if(this.project){var a=this.project.getHeaderHeight();this.setHeight(a)}},updateContent:function(a){this.project=a,this.refresh(),this.close()},setStatus:function(a,b){var c=this;this.clearTimer&&clearTimeout(this.clearTimer);var d=Wu.DomUtil.create("div","home-status"),e=Wu.DomUtil.create("div","home-status-inner",d);e.innerHTML=a,this.pushStatus(d),this.clearTimer=setTimeout(function(){c.clearStatus()},b||3e3)},setSaveStatus:function(a){this.setStatus("Saved!",a)},pushStatus:function(a){var b=this._statusWrap.firstChild;this._statusWrap.insertBefore(a,b),setTimeout(function(){Wu.DomUtil.addClass(a,"status-in"),setTimeout(function(){Wu.DomUtil.remove(b)},250)},50)},clearStatus:function(){var a=app.getPortalName();a!=this.getStatus()&&this.setStatus(a)},getStatus:function(){return this._statusWrap.firstChild.firstChild.innerHTML}}),Wu.StartPane=Wu.Class.extend({initialize:function(a){Wu.setOptions(this,a),this.dimensions={screenW:0,screenH:0,boxW:350,boxH:233,sizeMode:"",projectNo:0},this.projectContainers=[]},activate:function(){this.isOpen=!0,this.initSpinner(),this.addHooks(),this.refreshProjects(),Wu.DomUtil.removeClass(Wu.app.HeaderPane._container,"displayNone")},deactivate:function(){this.isOpen=!1,this.removeHooks(),this._spinner&&this._spinner.disable(),this._container&&Wu.DomUtil.remove(this._container)},initSpinner:function(){this._container=Wu.DomUtil.create("div","startpane-canvas-container",app._appPane);var a=this._initSpinnerContent();this._wrapper=Wu.DomUtil.create("div","spinning-wrapper",this._container),this._wrapper.appendChild(a),this._spinner=!1},_initSpinnerContent:function(){var a=Wu.DomUtil.create("div","startpane-spinning-content");return this._bannerContainer=Wu.DomUtil.create("div","startpane-banner-container",a),this._banner=Wu.DomUtil.create("div","startpane-banner",this._bannerContainer),this._recentProjectsContainer=Wu.DomUtil.create("div","startpane-recent-projects-container",this._banner),this._recentProjectsHeader=Wu.DomUtil.create("h1","startpane-header-title",this._recentProjectsContainer,"Recent projects:"),this._projectList=Wu.DomUtil.create("div","startpane-project-list",this._recentProjectsContainer),a},refreshProjects:function(){if(this._projectList.innerHTML="",this.projects=this._getLatestProjects(),this.dimensions.projectNo=this.projects.length,this.projects){this.projects.forEach(function(a,b){b>5||this.createStartProject(a)},this);var a=app._getDimensions();this.dimensions.screenW=a.width,this.dimensions.screenH=a.height,this.positionSpinner(a)}},_getLatestProjects:function(){var a=app.Projects,b=_.sortBy(a,function(a){return a.getLastUpdated()});return b.reverse(),b},createStartProject:function(a){var b=a.store.client,c=app.Clients[b].name,d=app.Clients[b].logo,e={};e._projectContainer=Wu.DomUtil.create("div","start-panne-recent-projects",this._projectList),e._projectThumb=Wu.DomUtil.create("img","",e._projectContainer),e._projectThumb.src=a.store.logo,e._projectTitle=Wu.DomUtil.create("div","start-project-name",e._projectContainer),e._projectTitle.innerHTML=a.getName(),e._clientName=Wu.DomUtil.create("div","start-project-client-name",e._projectContainer),e._clientName.innerHTML=c,d&&(e._clientLogo=Wu.DomUtil.create("img","start-project-client-logo",e._projectContainer),e._clientLogo.src=d),this.projectContainers.push(e),a.getName().length<22&&Wu.DomUtil.addClass(e._projectTitle,"short-name"),Wu.DomEvent.on(e._projectContainer,"mousedown",function(){this.selectProject(a)},this)},addHooks:function(){},removeHooks:function(){},selectProject:function(a){a.select(),app.SidePane.refreshProject(a),this.deactivate()},update:function(){},createImage:function(){var a=this;app.setHash(function(b,c){Wu.post("/api/util/snapshot",c,a.createdImage,a)})},createdImage:function(a,b){var c=JSON.parse(b),d=c.image,e=app.options.servers.portal;e+="pixels/",e+=d;e+="?width=250",e+="&height=150";var f='url("';f+=e,f+='")'},resizeEvent:function(a){this.positionSpinner(a)},positionSpinner:function(a){var b=a.width,c=a.height;if(c!=this.dimensions.screenH&&(this.dimensions.screenH=c,this.changeHeight(a)),b>=1091){if("full"==this.dimensions.sizeMode)return;this.dimensions.sizeMode="full",this.setYposition(a)}if(1090>=b&&b>=761){if("medium"==this.dimensions.sizeMode)return;this.dimensions.sizeMode="medium",this.setYposition(a)}if(760>=b){if("small"==this.dimensions.sizeMode)return;this.dimensions.sizeMode="small",this.setYposition(a)}},changeHeight:function(a){this.setYposition(a)},setYposition:function(a){var b=(a.width,a.height);if("full"==this.dimensions.sizeMode){if(b>=691&&this.showBoxes(6),690>=b&&this.showBoxes(3),this.dimensions.projectNo>=4)var c=2*this.dimensions.boxH;else var c=this.dimensions.boxH;this.calcPadding(b,c)}if("medium"==this.dimensions.sizeMode){if(b>=921&&this.showBoxes(6),920>=b&&b>=661&&this.showBoxes(4),660>=b&&this.showBoxes(2),this.dimensions.projectNo>=5)var c=3*this.dimensions.boxH;else if(this.dimensions.projectNo>=3&&this.dimensions.projectNo<=4)var c=2*this.dimensions.boxH;else var c=this.dimensions.boxH;this.calcPadding(b,c)}if("small"==this.dimensions.sizeMode){if(b>=921&&this.showBoxes(3),920>=b&&b>=661&&this.showBoxes(2),660>=b&&this.showBoxes(1),this.dimensions.projectNo>=3)var c=3*this.dimensions.boxH;else if(2==this.dimensions.projectNo)var c=2*this.dimensions.boxH;else if(1==this.dimensions.projectNo)var c=this.dimensions.boxH;this.calcPadding(b,c)}},showBoxes:function(a){this.dimensions.projectNo=a;for(var b=0;b<this.projects.length;b++)if(a>b){var c=this.projectContainers[b];c&&Wu.DomUtil.removeClass(c._projectContainer,"displayNone")}else{var c=this.projectContainers[b];c&&Wu.DomUtil.addClass(c._projectContainer,"displayNone")}},calcPadding:function(a,b){var c=Math.floor((a-b)/2);100>=c&&(c=100),this._wrapper.style.paddingTop=c+"px"}}),Wu.ErrorPane=Wu.Class.extend({options:{clearTimer:!1,clearDelay:1e3,severityColors:{1:"yellow",2:"cyan",3:"rgb(255, 122, 122)"}},initialize:function(){this.initLayout()},initLayout:function(){this._container=Wu.DomUtil.create("div","error-pane displayNone",app._mapContainer),this._content=Wu.DomUtil.create("div","error-pane-content",this._container),this._title=Wu.DomUtil.create("div","error-pane-title",this._content),this._description=Wu.DomUtil.create("div","error-pane-description",this._content),this._icon=Wu.DomUtil.create("div","error-pane-icon",this._content),this.addEvents()},addEvents:function(){Wu.DomEvent.on(this._container,"mousedown",this.clear,this)},setError:function(a,b,c){a&&this.setTitle(a),b&&this.setDescription(b),c&&this.setSeverity(c),this.show(),this.clearTimer()},clearTimer:function(a){this.options.clearTimer&&(this._clearTimer=setTimeout(this.clear.bind(this),a||this.options.clearDelay))},clear:function(){this.hide()},setTitle:function(a){this._title.innerHTML=a},setDescription:function(a){this._description.innerHTML=a},setSeverity:function(a){a&&this.setBackground(this.options.severityColors[a])},setBackground:function(a){this._content.style.background=a},hide:function(){Wu.DomUtil.addClass(this._container,"displayNone")},show:function(){Wu.DomUtil.removeClass(this._container,"displayNone")}}),Wu.Dropzone=Wu.Class.extend({options:{metaDelay:3e3},initialize:function(){this.initLayout()},initLayout:function(){this._container=Wu.DomUtil.create("div","dropzone-pane",app._appPane),this._content=Wu.DomUtil.create("div","dropzone-content",this._container),this._hidden=Wu.DomUtil.create("div","dropzone-hidden",this._container),this._meta=Wu.DomUtil.create("div","dropzone-meta",app._appPane),this._metaTitle=Wu.DomUtil.create("div","drop-meta-title",this._meta,"Uploading"),this._metaWrapper=Wu.DomUtil.create("div","dropzone-meta-outer",this._meta),this.progress=new Wu.ProgressPane,this.hide(),this.hideMeta()},show:function(){Wu.DomUtil.removeClass(this._container,"displayNone")},hide:function(){Wu.DomUtil.addClass(this._container,"displayNone")},showMeta:function(){this._showingMeta||(this._showingMeta=!0,Wu.DomUtil.removeClass(this._meta,"fadeOut"),Wu.DomUtil.removeClass(this._meta,"displayNone"),this._fadeTimer=setTimeout(this.fadeMeta.bind(this),this.options.metaDelay))},fadeMeta:function(){this._fadeTimer&&clearTimeout(this._fadeTimer),Wu.DomUtil.addClass(this._meta,"fadeOut"),setTimeout(this.hideMeta.bind(this),500)},hideMeta:function(){Wu.DomUtil.addClass(this._meta,"displayNone"),this._clearMeta(),this._showingMeta=!1},_clearMeta:function(){this._metaWrapper.innerHTML=""},addMeta:function(a){var b=this._addMeta(a);this._metaWrapper.appendChild(b)},_addMeta:function(a){if(a){var b=Wu.DomUtil.create("div","drop-meta-wrapper"),c=Wu.DomUtil.create("div","drop-meta-name",b),d=Wu.DomUtil.create("div","drop-meta-size",b),e=Wu.DomUtil.create("div","drop-meta-type",b),f=Wu.DomUtil.create("div","drop-meta-type",b);return c.innerHTML="Name: "+a.name,d.innerHTML="Size: "+Wu.Util.bytesToSize(a.size),e.innerHTML="Type: "+a.type.split("/")[0].camelize(),f.innerHTML="Filetype: "+a.type.split("/")[1],b}},initDropzone:function(a){this._uploadedCallback=a.uploaded,this._clickable=a.clickable,this.dz=new Dropzone(this._container,{url:"/api/upload",createImageThumbnails:!1,autoDiscover:!1,uploadMultiple:!0,acceptedFiles:".zip,.gz,.png,.jpg,.jpeg,.geojson,.docx,.pdf,.doc,.txt",maxFiles:10,parallelUploads:10,clickable:this._clickable||!1}),this.addDropzoneEvents()},addDropzoneEvents:function(){Wu.DomEvent.on(document.body,"dragenter",this.dropping,this),Wu.DomEvent.on(document.body,"dragleave",this.undropping,this),Wu.DomEvent.on(document.body,"dragover",this.dragover,this),Wu.DomEvent.on(document.body,"drop",this.dropped,this)},removeDropzoneEvents:function(){Wu.DomEvent.off(document.body,"dragenter",this.dropping,this),Wu.DomEvent.off(document.body,"dragleave",this.undropping,this),Wu.DomEvent.off(document.body,"dragover",this.dragover,this),Wu.DomEvent.off(document.body,"drop",this.dropped,this)},disable:function(){this.removeDropzoneEvents()},enable:function(){this.addDropzoneEvents()},refresh:function(){var a=this;this.project=app.activeProject,this.dz.removeAllListeners(),this.dz.options.params.project=this.project.getUuid(),this.dz.on("drop",function(){a.hide()}),this.dz.on("dragenter",function(){}),this.dz.on("addedfile",function(b){a.showMeta(),a.progress.setProgress(0),a.addMeta(b),app.setStatus("Uploading")}),this.dz.on("complete",function(b){a.dz.removeFile(b),a.fadeMeta()}),this.dz.on("uploadprogress",function(b,c){a.progress.setProgress(c)}),this.dz.on("successmultiple",function(b,c){var d=Wu.parse(c);app.setStatus("Done!",2e3),d&&a._uploadedCallback(d),a.progress.hideProgress()})},dropping:function(a){a.preventDefault(),this.show(a)},undropping:function(a){a.preventDefault();var b=a.target;b==this._container&&this.hide()},dropped:function(a){a.preventDefault(),this.dz.drop(a)},dragover:function(a){a.preventDefault()}}),Wu.ZIndexControl=Wu.Class.extend({initialize:function(){this._index=[],app.zIndex=this},add:function(a){this._index.push(a),this.enforce()},remove:function(a){_.remove(this._index,function(b){return b==a}),this.enforce()},set:function(){},get:function(a){return a?_.findIndex(this._index,function(b){return a==b}):this._index},getIndex:function(){var a=[];return this._index.forEach(function(b){a.push(b.getTitle())}),a},up:function(a){var b=this.get(a);this._move(b,b+1),this.enforce()},_move:function(a,b){this._index.splice(b,0,this._index.splice(a,1)[0])},down:function(a){var b=this.get(a);this._move(b,b-1),this.enforce()},top:function(){},bottom:function(){},enforce:function(){var a=this._index;a.forEach(function(a,b){var c=b+this._z;a._setZIndex(c)},this)}}),Wu.ZIndexControl.Baselayers=Wu.ZIndexControl.extend({_z:0,_me:"base"}),Wu.ZIndexControl.Layermenu=Wu.ZIndexControl.extend({_z:1e3,_me:"layermenu"}),L.Control.Layermenu=L.Control.extend({options:{position:"bottomright"},onAdd:function(){{var a="leaflet-control-layermenu",b=this._innerContainer=L.DomUtil.create("div",a);this.options}this._layermenuOuter=Wu.DomUtil.create("div","scroller-frame");var c=(Wu.DomUtil.create("div","scroll-up",this._layermenuOuter),Wu.DomUtil.create("div","inner-scroller",this._layermenuOuter));return this._content=Wu.DomUtil.createId("div","layer-menu-inner-content",c),b.appendChild(this._layermenuOuter),this.initLayout(),Wu.DomEvent.on(b,"mouseup",Wu.DomEvent.stop,this),b},initLayout:function(){if(this._layerMenuHeader=Wu.DomUtil.createId("div","layer-menu-header"),Wu.DomUtil.addClass(this._layerMenuHeader,"menucollapser"),this._layerMenuHeaderTitle=Wu.DomUtil.create("div","layer-menu-header-title",this._layerMenuHeader,"Layers"),this._bhattan1=Wu.DomUtil.createId("div","bhattan1"),Wu.DomUtil.addClass(this._bhattan1,"dropdown-button rotate270"),this._layerMenuHeader.appendChild(this._bhattan1),this._innerContainer.insertBefore(this._layerMenuHeader,this._innerContainer.getElementsByTagName("div")[0]),this._openLayers=Wu.DomUtil.createId("div","open-layers"),this._openLayers.innerHTML="Open Layer Menu",Wu.DomUtil.addClass(this._openLayers,"leaflet-control ol-collapsed"),app._map._controlCorners.bottomright.appendChild(this._openLayers),app.MapPane.legendsControl&&(this._legendsContainer=app.MapPane.legendsControl._legendsContainer,this._legendsCollapser=app.MapPane.legendsControl._legendsCollapser),Wu.DomEvent.on(this._bhattan1,"click",this.closeLayerPane,this),Wu.DomEvent.on(this._openLayers,"click",this.toggleLayerPane,this),Wu.DomEvent.on(this._openLayers,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._bhattan1,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._innerContainer,"mouseenter",this.cancelEditClose,this),Wu.DomEvent.on(this._innerContainer,"mouseleave",this.timedEditClose,this),!app.MapPane.inspectControl){var a=app._map._controlCorners.bottomright;a.style.paddingBottom="6px"}app.Tooltip.add(this._layerMenuHeaderTitle,"The layer menu lets you choose what layers you want to be on top of the map",{"extends":"systyle",tipJoint:"right"}),app.Tooltip.add(this._bhattan1,"Minimize the layer menu",{"extends":"systyle",tipJoint:"left"}),this._open=!0,app.mobile&&Wu.DomUtil.create("div","layers-mobile-arrow",this._innerContainer)},show:function(){Wu.DomUtil.removeClass(this._container,"displayNone")},hide:function(){Wu.DomUtil.addClass(this._container,"displayNone")},resizeEvent:function(a){var b=a.height-135;this.setMaxHeight(b)},setMaxHeight:function(a){var b=app.MapPane.inspectControl;b&&(a-=120),this._layermenuOuter.style.maxHeight=a+"px"},cancelEditClose:function(){if(this.editMode){var a=app.SidePane.Map.mapSettings.layermenu.closeEditTimer;clearTimeout(a),setTimeout(function(){var a=app.SidePane.Map.mapSettings.layermenu.closeEditTimer;clearTimeout(a)},301)}},timedEditClose:function(){if(this.editMode){var a=this;app.SidePane.Map.mapSettings.layermenu.closeEditTimer=setTimeout(function(){a.disableEdit()},3e3)}},toggleLayerPane:function(){this._open?this.closeLayerPane():this.openLayerPane()},closeLayerPane:function(){this._open=!1,app._map._controlCorners.bottomright.style.width="0px",Wu.DomUtil.removeClass(this._openLayers,"ol-collapsed"),app.MapPane.inspectControl&&this._legendsContainer&&Wu.DomUtil.removeClass(this._legendsContainer,"legends-padding-right"),app._map._controlCorners.topright.style.right="140px"},openLayerPane:function(){this._open=!0,app._map._controlCorners.bottomright.style.width="290px",Wu.DomUtil.addClass(this._openLayers,"ol-collapsed"),app.MapPane.inspectControl&&this._legendsContainer&&Wu.DomUtil.addClass(this._legendsContainer,"legends-padding-right"),app._map._controlCorners.topright.style.right="295px",Wu.app.mobile&&(app.MapPane.legendsControl._isOpen&&app.MapPane.legendsControl.MobileCloseLegends(),app.MapPane.descriptionControl._isClosed||app.MapPane.descriptionControl.mobileClosePane())},enableEdit:function(){this.editMode||(this.editMode=!0,Wu.app.MapPane.disableInteraction(!0),app.Dropzone&&app.Dropzone.disable(),this.enableSortable(),this._layerMenuHeaderTitle.innerHTML="Edit Layer Menu",Wu.DomUtil.addClass(this._innerContainer,"edit-mode"),this._insertMenuFolder(),this.openAll())},disableEdit:function(){this.editMode&&(this.editMode=!1,Wu.app.MapPane.enableInteraction(!0),app.Dropzone&&app.Dropzone.enable(),this.disableSortable(),this._layerMenuHeaderTitle.innerHTML="Layers",Wu.DomUtil.removeClass(this._innerContainer,"edit-mode"),this._removeMenuFolder())},_insertMenuFolder:function(){this._menuFolder?Wu.DomUtil.removeClass(this._menuFolder,"displayNone"):(this._menuFolder=Wu.DomUtil.create("div","smap-button-white middle-item ct12 ct18",this._innerContainer,"Add folder"),this._layerMenuHeader.parentNode.insertBefore(this._menuFolder,this._layerMenuHeader.nextSibling),Wu.DomEvent.on(this._menuFolder,"click",this.addMenuFolder,this))},_removeMenuFolder:function(){this._menuFolder&&Wu.DomUtil.addClass(this._menuFolder,"displayNone")},enableSortable:function(){this.initSortable()},disableSortable:function(){this.resetSortable()},refreshSortable:function(){this.resetSortable(),this.initSortable()},initSortable:function(){for(var a=document.getElementsByClassName("layer-menu-item-wrap"),b=0;b<a.length;b++){var c=a[b];c.setAttribute("draggable","true"),Wu.DomEvent.on(c,"dragstart",this.drag.start,this)}var d=this._content;d&&(Wu.DomEvent.on(d,"dragover",this.drag.over,this),Wu.DomEvent.on(d,"dragleave",this.drag.leave,this),Wu.DomEvent.on(d,"drop",this.drag.drop,this))},resetSortable:function(){var a=this._content;a&&(Wu.DomEvent.off(a,"dragover",this.drag.over,this),Wu.DomEvent.off(a,"dragleave",this.drag.leave,this),Wu.DomEvent.off(a,"drop",this.drag.drop,this))},drag:{start:function(a){var b=a.target;Wu.DomUtil.addClass(b,"dragged-ghost");var c=b.id;return this.drag.currentDragElement=b,this.drag.currentDragUuid=c,this.drag.startDragLevel=this.layers[c].item.pos,a.dataTransfer.setData("uuid",c),!1},drop:function(a){var b=a.dataTransfer.getData("uuid"),c=document.getElementById(b);Wu.DomUtil.removeClass(c,"dragged-ghost");var d=Array.prototype.slice.call(this._content.childNodes),e=d.indexOf(c),f=_.findIndex(this.project.store.layermenu,{uuid:b});return this.project.store.layermenu.move(f,e),this.save(),this.drag.currentDragElement=null,this.drag.currentDragLevel=null,this.movingX=!1,!1},over:function(a){a.preventDefault&&a.preventDefault(),this.movingX||(this.movingX=a.layerX);a.layerX-this.movingX;return!1},leave:function(a){var b=a.clientX,c=a.clientY,d=document.elementFromPoint(b,c),e=this.drag.currentDragElement,f=d.getAttribute("type");return"layerItem"==f?(this.drag.moveElementNextTo(e,d),!1):void 0},moveElementNextTo:function(a,b){b=b.parentNode,this.isBelow(a,b)?b.parentNode.insertBefore(a,b):b.parentNode.insertBefore(a,b.nextSibling)},isBelow:function(a,b){var c=a.parentNode;if(b.parentNode!=c)return!1;for(var d=a.previousSibling;d&&9!==d.nodeType;){if(d===b)return!0;d=d.previousSibling}return!1}},_isFolder:function(a){var b=this.layers[a.uuid];return b.layer?!1:!0},markInvalid:function(a){a.forEach(function(a){var b=this.layers[a.uuid].el;Wu.DomUtil.addClass(b,"invalidLayermenuitem")},this)},clearInvalid:function(){for(l in this.layers){var a=this.layers[l];Wu.DomUtil.removeClass(a.el,"invalidLayermenuitem")}},checkLogic:function(){this.clearInvalid();var a=this.project.store.layermenu,b=[];return a.forEach(function(a,c,d){if(0==c)return 0!=a.pos?b.push(a):b;if(a.folder){var e=a.pos,f=d[c-1].pos;if(e>f)return b.push(a)}var e=parseInt(a.pos),f=parseInt(d[c-1].pos);return e>f&&!d[c-1].folder?b.push(a):parseInt(e)>parseInt(f+1)?b.push(a):void 0
},this),this.markInvalid(b),b},updateLogic:function(){var a=this.project.store.layermenu;this._logic=this._logic||{},a.forEach(function(b){if(this._isFolder(b)){var c=b.pos,d=[],e=[],f=!1;if(_.each(a,function(a){if(b.uuid==a.uuid&&(f=!0),f){if(parseInt(a.pos)>parseInt(c)){var e=this.layers[a.uuid].el;d.push(e)}if(parseInt(a.pos)==parseInt(c)&&b.uuid!=a.uuid)return!1}},this),f=!1,_.each(a,function(a){if(f){if(parseInt(a.pos)==parseInt(c)+1){var d=this.layers[a.uuid].el;e.push(d)}if(parseInt(a.pos)==parseInt(c))return!1}b.uuid==a.uuid&&(f=!0)},this),this._logic[b.uuid])var g=this._logic[b.uuid].isOpen||!1;else var g=!0;this._logic[b.uuid]={toOpen:e,toClose:d,isOpen:g}}},this)},enforceLogic:function(a){var b=a.item.uuid,c=this._logic[b];if(c.isOpen){var d=c.toClose;d.forEach(function(a){Wu.DomUtil.addClass(a,"layeritem-closed"),Wu.DomUtil.removeClass(a,"layeritem-open");var b=a.id;this._logic[b]&&this._logic[b].isOpen&&(this._logic[b].isOpen=!1)},this),this._logic[b].isOpen=!1}else{var d=c.toOpen;d.forEach(function(a){Wu.DomUtil.removeClass(a,"layeritem-closed"),Wu.DomUtil.addClass(a,"layeritem-open")},this),this._logic[b].isOpen=!0}},closeAll:function(){this.updateLogic();for(l in this._logic){var a=this.layers[l];this._logic[l].isOpen=!0,this.enforceLogic(a)}},openAll:function(){this.updateLogic();for(l in this._logic){var a=this.layers[l];this._logic[l].isOpen=!1,this.enforceLogic(a)}},toggleFolder:function(a){this.updateLogic(),this.enforceLogic(a)},toggleLayer:function(a){this.editMode||(a.on?this.disableLayer(a):this.enableLayer(a))},_enableLayer:function(a){var b=_.find(this.layers,function(b){return b.item.layer==a});Wu.DomUtil.addClass(b.el,"layer-active"),b.on=!0},enableLayer:function(a){var b=a.layer;return b?(b.add(),a.on=!0,void Wu.DomUtil.addClass(a.el,"layer-active")):this.toggleFolder(a)},disableLayer:function(a){var b=a.layer;b&&this._disableLayer(b)},_disableLayer:function(a){var b=this._getLayermenuItem(a.store.uuid);a.remove(),b.on=!1,Wu.DomUtil.removeClass(b.el,"layer-active")},_getLayermenuItem:function(a){var b=_.find(this.layers,function(b){return b.item.layer==a});return b},onDelete:function(a){if(!a)return void 0;var b=a.getUuid(),c=this._getLayermenuItem(b);if(c){var d=c.el;d&&d.parentNode.removeChild(d)}},remove:function(a){var b=this.layers[a],c=b.el;c&&c.parentNode.removeChild(c),b.layer&&app.SidePane.Map.mapSettings.layermenu._off(b.layer);var d=b.layer;d&&d.remove(),delete this.layers[a],_.remove(this.project.store.layermenu,function(b){return b.uuid==a}),this.save();var e=app.SidePane.Map.mapSettings.baselayer,f=app.SidePane.Map.mapSettings.layermenu;e&&e.markOccupied(),f&&f.markOccupied()},removeLayermenuItem:function(){},removeLayer:function(){},_remove:function(a){var b=this._getLayermenuItem(a);this.remove(b.item.uuid)},add:function(a){var b={uuid:"layerMenuItem-"+Wu.Util.guid(),layer:a.store.uuid,caption:a.store.title,pos:0,zIndex:1,opacity:1},c={item:b,layer:a};this._add(c),this.project.store.layermenu.push(b),this.save()},_add:function(a){var b=a.item,c=a.layer,d="layer-menu-item-wrap";c||(d+=" menufolder");var e=Wu.DomUtil.create("div",d),f=b.uuid,g='<div class="layer-item-up">></div><div class="layer-item-down"><</div><div class="layer-item-delete">x</div><div type="layerItem" class="layer-menu-item">'+b.caption+"</div>";e.innerHTML=g,e.id=f,Wu.DomUtil.addClass(e,"level-"+b.pos),e.setAttribute("draggable",!0),this._content.appendChild(e);var h=e.children[0],i=e.children[1],j=e.children[2],k=e.children[3];Wu.DomEvent.on(h,"click",function(){this.upFolder(f)},this),Wu.DomEvent.on(i,"click",function(){this.downFolder(f)},this),Wu.DomEvent.on(j,"click",function(){this.deleteMenuFolder(f)},this),Wu.DomEvent.on(k,"dblclick",function(){this._editFolderTitle(f)},this),Wu.DomEvent.on(h,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(i,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(j,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(this._container,"touchstart mousedown click dblclick",Wu.DomEvent.stopPropagation,this),a.el=e,Wu.DomEvent.on(e,"mousedown",function(){this.toggleLayer(a)},this),Wu.DomEvent.on(this._innerContainer,"dblclick",Wu.DomEvent.stop,this),this.refreshSortable(),this.layers[b.uuid]=a},getLayers:function(){return this.layers},_fill:function(){this.project.store.layermenu&&this.project.store.layermenu.forEach(function(a){var b=_.find(this.project.layers,function(b){return b.store.uuid==a.layer}),c={item:a,layer:b};this._add(c)},this)},addMenuFolder:function(){this.addFolder()},_addMenuFolder:function(){this._addFolder()},addFolder:function(){var a={uuid:"layerMenuItem-"+Wu.Util.guid(),caption:"New folder",pos:0,folder:!0},b={item:a,layer:!1};this._add(b),this.project.store.layermenu.push(a),this.save()},_editFolderTitle:function(a){if(this.editMode&&!this.currentlyEditing){this.currentlyEditing=!0;var b=this.layers[a],c=b.el.children[3],d=c.innerHTML;c.innerHTML="";var e=Wu.DomUtil.create("input","layer-item-title-input");e.value=d,c.appendChild(e),e.focus(),Wu.DomEvent.on(e,"blur",function(){var b=e.value;Wu.DomUtil.remove(e),c.innerHTML=b;var d=_.findIndex(this.project.store.layermenu,{uuid:a});this.project.store.layermenu[d].caption=b,this.save(),this.currentlyEditing=!1},this),Wu.DomEvent.on(e,"keydown",function(){(13==event.which||13==event.keyCode)&&e.blur(),(27==event.which||27==event.keyCode)&&e.blur()},this)}},upFolder:function(a){var b=this.layers[a].el,c=_.findIndex(this.project.store.layermenu,{uuid:a}),d=parseInt(this.project.store.layermenu[c].pos),e=d+1;this.project.store.layermenu[c].pos=e,Wu.DomUtil.addClass(b,"level-"+e),Wu.DomUtil.removeClass(b,"level-"+d),this.save()},downFolder:function(a){var b=this.layers[a].el,c=_.findIndex(this.project.store.layermenu,{uuid:a}),d=parseInt(this.project.store.layermenu[c].pos),e=d-1;this.project.store.layermenu[c].pos=e,Wu.DomUtil.addClass(b,"level-"+e),Wu.DomUtil.removeClass(b,"level-"+d),this.save()},deleteMenuFolder:function(a){this.remove(a)},save:function(){var a=this,b=this.checkLogic();return b.length?void 0:(this.saveTimer&&clearTimeout(this.saveTimer),void(this.saveTimer=setTimeout(function(){a.project._update("layermenu")},1e3)))},update:function(a){this.project=a||Wu.app.activeProject,this.layers={},this._fill(),this.closeAll();var b=app._map;Wu.DomEvent.on(this._container,"mouseenter",function(){b.scrollWheelZoom.disable()},this),Wu.DomEvent.on(this._container,"mouseleave",function(){b.scrollWheelZoom.enable()},this);var c=window.innerHeight-135;this.setMaxHeight(c)}}),L.control.layermenu=function(a){return new L.Control.Layermenu(a)},L.Control.Inspect=L.Control.extend({options:{position:"bottomright",draggable:!0},onAdd:function(){{var a="leaflet-control-inspect ct14",b=L.DomUtil.create("div",a);this.options}return this._content=Wu.DomUtil.create("div","inspect-control-inner-content",b),this._header=Wu.DomUtil.create("div","menucollapser inspector-header",this._content,"Layer inspector"),this._scroller=Wu.DomUtil.create("div","inspector-list-outer-scroller",this._content),this._list=Wu.DomUtil.create("div","inspector-list",this._scroller),app.Tooltip.add(b,"Shows a list of active layers",{"extends":"systyle",tipJoint:"top left"}),b},addTo:function(a){this._map=a;var b=this._container=this.onAdd(a),c=this.getPosition(),d=a._controlCorners[c];return L.DomUtil.addClass(b,"leaflet-control"),d.appendChild(b),Wu.DomEvent.on(b,"mousedown click dblclick",Wu.DomEvent.stop,this),this},show:function(){Wu.DomUtil.removeClass(this._container,"displayNone")},hide:function(){Wu.DomUtil.addClass(this._container,"displayNone")},update:function(a){this.project=a||app.activeProject,this.layers=[],this.disableScrollzoom(),this._zx=app.MapPane.getZIndexControls().l,this._addAlreadyActiveLayers()},_addAlreadyActiveLayers:function(){var a=app.MapPane.getActiveLayers();a.forEach(function(a){a._isBase||this.addLayer(a)},this)},disableScrollzoom:function(){this.resetScrollzoom();var a=app._map;Wu.DomEvent.on(this._container,"mouseenter",function(){a.scrollWheelZoom.disable()},this),Wu.DomEvent.on(this._container,"mouseleave",function(){a.scrollWheelZoom.enable()},this)},resetScrollzoom:function(){var a=app._map;Wu.DomEvent.off(this._container,"mouseenter",function(){a.scrollWheelZoom.disable()},this),Wu.DomEvent.off(this._container,"mouseleave",function(){a.scrollWheelZoom.enable()},this)},addLayer:function(a){this._content.style.display="block";var b=Wu.DomUtil.create("div","inspect-layer"),c=Wu.DomUtil.create("div","inspect-arrows-wrap",b),d=Wu.DomUtil.create("div","inspect-arrow-up",c),e=Wu.DomUtil.create("div","inspect-arrow-down",c),f=Wu.DomUtil.create("div","inspect-text",b,a.store.title),g=Wu.DomUtil.create("div","inspect-fly",b),h=Wu.DomUtil.create("div","inspect-eye",b),i=Wu.DomUtil.create("div","inspect-kill",b);app.Tooltip.add(c,"Arrange layer order",{"extends":"systyle",tipJoint:"right",group:"inspect-control"}),app.Tooltip.add(g,"Zoom to layer extent",{"extends":"systyle",tipJoint:"bottom left",group:"inspect-control"}),app.Tooltip.add(h,"Isolate layer",{"extends":"systyle",tipJoint:"bottom left",group:"inspect-control"}),app.Tooltip.add(i,"Disable layer",{"extends":"systyle",tipJoint:"bottom left",group:"inspect-control"}),this._list.insertBefore(b,this._list.firstChild);var j={wrapper:b,upArrow:d,downArrow:e,text:f,eye:h,kill:i,layer:a,uuid:a.store.uuid,isolated:!1};this.layers.unshift(j),Wu.DomEvent.on(d,"dblclick click",function(a){Wu.DomEvent.stop(a),this.moveUp(j)},this),Wu.DomEvent.on(e,"dblclick click",function(a){Wu.DomEvent.stop(a),this.moveDown(j)},this),Wu.DomEvent.on(g,"dblclick click",function(a){Wu.DomEvent.stop(a),this.flyTo(j)},this),Wu.DomEvent.on(h,"dblclick click",function(a){Wu.DomEvent.stop(a),this.isolateToggle(j)},this),Wu.DomEvent.on(i,"dblclick click",function(a){Wu.DomEvent.stop(a),this.killLayer(j)},this),Wu.DomEvent.on(f,"dblclick click",function(a){Wu.DomEvent.stop(a),this.select(j)},this),this.options.draggable&&this._makeSortable(j)},_makeSortable:function(a){var b=a.wrapper;Wu.DomEvent.on(b,"mousedown",function(b){a.e=b,this._dragStart(a)},this),this._initSortable()},_initSortable:function(){this._initedSortable||(this._initedSortable=!0,Wu.DomEvent.on(document,"mousemove",this._dragMove,this),Wu.DomEvent.on(document,"mouseup",this._dragStop,this))},_dragStart:function(a){this._dragging=a,this._n=1,this._m=1,this._md=0;a.wrapper},_dragMove:function(a){if(this._dragging){var b=this._dragging,c=this._md,d=a.y-b.e.y,e=b.wrapper,f=(this._n,this._m,18);this._md+=a.movementY,-f>c&&this._moveUp(d),c>f&&this._moveDown(d),this._dragClassAdded||L.DomUtil.addClass(e,"dragging")}},_dragStop:function(){if(this._dragging){var a=this._dragging.wrapper;L.DomUtil.removeClass(a,"dragging"),this._dragClassAdded=!1,this._dragging=!1}},_moveUp:function(){var a=this._dragging,b=a.wrapper,c=b.previousSibling,d=this._dragging.layer;c&&(c.parentNode.insertBefore(b,c),this._zx.up(d),this._md=0)},_moveDown:function(){var a=this._dragging,b=a.wrapper,c=b.nextSibling,d=this._dragging.layer;c&&(c.parentNode.insertBefore(b,c.nextSibling),this._zx.down(d),this._md=0)},removeLayer:function(a){var b=_.find(this.layers,function(b){return b.uuid==a.store.uuid});this._removeLayer(b),0==this.layers.length&&(this._content.style.display="none")},_removeLayer:function(a){a&&(Wu.DomUtil.remove(a.wrapper),_.remove(this.layers,function(b){return b.uuid==a.uuid}),0==this.layers.length&&(this._content.style.display="none"))},moveUp:function(a){var b=a,c=b.wrapper,d=c.previousSibling,e=b.layer;d&&(d.parentNode.insertBefore(c,d),this._zx.up(e))},moveDown:function(a){var b=a,c=b.wrapper,d=c.nextSibling,e=b.layer;d&&(d.parentNode.insertBefore(c,d.nextSibling),this._zx.down(e))},flyTo:function(a){var b=a.layer;if(b){var c=b.getMeta().extent;if(c){var d=L.latLng(c[1],c[0]),e=L.latLng(c[3],c[2]),f=L.latLngBounds(d,e),g=app._map;g.fitBounds(f)}}},isolateToggle:function(a){a.isolated?(a.isolated=!1,this.isolateLayers(),Wu.DomUtil.removeClass(a.eye,"inspecting")):(a.isolated=!0,this.isolateLayers(),Wu.DomUtil.addClass(a.eye,"inspecting"))},_noneAreIsolated:function(){var a=_.filter(this.layers,function(a){return 1==a.isolated});return a.length?!1:!0},isolateLayers:function(){return this._noneAreIsolated()?void this.layers.forEach(function(a){a.layer.show()},this):void this.layers.forEach(function(a){a.isolated?a.layer.show():a.layer.hide()},this)},killLayer:function(a){this._removeLayer(a);var b=app.MapPane.layerMenu;b&&b._disableLayer(a.layer);var c=app.MapPane.legendsControl;c&&c.removeLegend(a.layer);var d=app.MapPane.descriptionControl;d&&d.removeLayer(a.layer),this.layers.length||(this._content.style.display="none")},select:function(a){var b=app.MapPane.descriptionControl;b&&b.setLayer(a.layer),this.activeEntry=a},getListPosition:function(){},setListPosition:function(){}}),L.control.inspect=function(a){return new L.Control.Inspect(a)},L.Control.Description=L.Control.extend({options:{position:"bottomright"},onAdd:function(){{var a="leaflet-control-description",b=L.DomUtil.create("div",a);this.options}return this._button=Wu.DomUtil.create("div","dropdown-button description-toggle-button",b),this._content=Wu.DomUtil.create("div","description-control-inner-content",b),this._collapser=Wu.DomUtil.create("div","menucollapser collapse-description",this._content,"Info"),this._outer=Wu.DomUtil.create("div","description-control-inner-content-box",this._content),b},initContainer:function(){this._container.style.display="none",this._inner=Wu.DomUtil.create("div","description-scroller",this._outer),app.Tooltip.add(this._container,"Shows layer information",{"extends":"systyle",tipJoint:"left"}),Wu.app.mobile&&(this._content.style.left=Wu.app.nativeResolution[1]+"px",this._isClosed=!0,Wu.DomUtil.create("div","description-mobile-arrow",this._content))},setDescription:function(a){this._inner.innerHTML=a.store.description},show:function(){this._container.style.display="block"},hide:function(){this._container.style.display="none"},clear:function(){this.activeLayer=!1,this._inner.innerHTML=""},setActiveLayer:function(a){this.setLayer(a)},setLayer:function(a){this.activeLayer=a,this.setDescription(a),a.store.description||this.editMode||(this.closePane(),this.clear())},removeLayer:function(a){this.activeLayer==a&&this.clear()},update:function(a){this.project=a||Wu.app.activeProject,this.editMode=this.project.editMode,this.editing=!1,this.activeLayer=!1,this.initContainer(),this.addHooks(),this.clear()},addHooks:function(){Wu.DomEvent.on(this._button,"click",this.toggleCloser,this),this.editMode&&Wu.DomEvent.on(this._outer,"dblclick",this.toggleEdit,this),Wu.DomEvent.on(this._container,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._button,"mousedown mouseup click dblclick",Wu.DomEvent.stopPropagation,this)},removeHooks:function(){Wu.DomEvent.off(this._button,"click",this.closePane,this),this.editMode&&Wu.DomEvent.off(this._inner,"dblclick",this.toggleEdit,this),Wu.DomEvent.off(this._container,"dblclick",Wu.DomEvent.stop,this),Wu.DomEvent.off(this._container,"dblclick",Wu.DomEvent.stop,this),Wu.DomEvent.off(this._container,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.off(this._button,"mousedown mouseup click dblclick",Wu.DomEvent.stopPropagation,this)},toggleEdit:function(){this.editing||this.editOn()},editOn:function(){if(this.activeLayer){this.editing=!0,this.addGrande(),app._map.dragging.disable(),Wu.DomUtil.addClass(this._inner,"description-editing"),Wu.DomEvent.on(this._inner,"keydown",this.keyDown,this);var a=app._map;a.scrollWheelZoom.disable()}},keyDown:function(a){(27==a.keyCode||9==a.keyCode)&&this.editOff()},editOff:function(){this.editing=!1,this.removeGrande(),app._map.dragging.enable(),Wu.DomUtil.removeClass(this._inner,"description-editing"),this._inner.setAttribute("contenteditable","false");var a=app._map;if(a.scrollWheelZoom.enable(),this.activeLayer){var b=this._inner.innerHTML;this.activeLayer.store.description=b,this.activeLayer.save("description"),app.setSaveStatus()}},textChange:function(a){a||this.editOff()},removeGrande:function(){this.grande&&(this.grande.destroy(),delete this.grande)},addGrande:function(){var a=this._inner,b=(this.project.getFiles(),this.project.getGrandeFiles()),c=this.project.getGrandeImages(),d={plugins:{attachments:new G.Attachments(b,{icon:[app.options.servers.portal+"images/image-c9471cb2-7e0e-417d-a048-2ac501e7e96f",app.options.servers.portal+"images/image-7b7cc7e4-404f-4e29-9d7d-11f0f24faf42"],className:"attachment"}),images:new G.Attachments(c,{icon:[app.options.servers.portal+"images/image-0359b349-6312-4fe5-b5d7-346a7a0d3c38",app.options.servers.portal+"images/image-087ef5f5-b838-48bb-901f-7e896de7c59e"],embedImage:!0,className:"image-attachment"})},events:{change:this.textChange.bind(this)}};this.grande=G.rande(a,d)},toggleCloser:function(){Wu.app.mobile?this._isClosed?this.mobileOpenPane():this.mobileClosePane():this.closePane()},mobileOpenPane:function(){Wu.DomUtil.addClass(this._button,"active-description"),this._content.style.left="0px",this._isClosed=!1,app.MapPane.legendsControl._isOpen&&app.MapPane.legendsControl.MobileCloseLegends(),app.MapPane.layerMenu._open&&app.MapPane.layerMenu.closeLayerPane()},mobileClosePane:function(){Wu.DomUtil.removeClass(this._button,"active-description"),this._content.style.left=Wu.app.nativeResolution[1]+"px",this._isClosed=!0},closePane:function(){this._container.style.display="none",this._isClosed=!0},openPane:function(){this._container.style.display="block",this._isClosed=!1}}),L.control.description=function(a){return new L.Control.Description(a)},L.Control.Legends=L.Control.extend({options:{position:"bottomleft"},_isOpen:!1,onAdd:function(){{var a="leaflet-control-legends",b=L.DomUtil.create("div",a);this.options}return b.style.display="none",this._legendsOpener=Wu.DomUtil.create("div","legends-opener",b,"Open Legends"),this._legendsOpener.style.display="none",this._legendsContainer=Wu.DomUtil.create("div","legends-control-inner-content",b),this._legendsInner=Wu.DomUtil.create("div","leaflet-drag-target legends-inner",this._legendsContainer),this._legendsCollapser=Wu.DomUtil.create("div","legends-collapser dropdown-button legends-collapser-trans",this._legendsInner),this._legendsScrollLeft=Wu.DomUtil.create("div","legends-scroll-left",this._legendsInner),this._legendsScrollRight=Wu.DomUtil.create("div","legends-scroll-right",this._legendsInner),this._legendsInnerSlider=Wu.DomUtil.create("div","legends-inner-slider",this._legendsInner),b},addHooks:function(){Wu.DomEvent.on(this._legendsCollapser,"click",this.closeLegends,this),Wu.DomEvent.on(this._legendsOpener,"click",this.toggleOpen,this),Wu.DomEvent.on(this._container,"mousewheel",Wu.DomEvent.stop,this),Wu.DomEvent.on(this._legendsScrollLeft,"click",this.legendsScrollLeft,this),Wu.DomEvent.on(this._legendsScrollRight,"click",this.legendsScrollRight,this),Wu.DomEvent.on(this._container,"dblclick",Wu.DomEvent.stop,this),Wu.DomEvent.on(this._container,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._legendsCollapser,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this)},checkWidth:function(){var a=window.innerWidth;this.setMaxWidth(a)},show:function(){Wu.DomUtil.removeClass(this._container,"displayNone")},hide:function(){Wu.DomUtil.addClass(this._container,"displayNone")},resizeEvent:function(a){var b=a.width;this.setMaxWidth(b)},setMaxWidth:function(a){var b=app.MapPane.inspectControl,c=app.MapPane.layerMenu;b&&c._open&&(a-=300),this._container.style.maxWidth=a+"px",this.sliderWidth>a?this.showScrollers():this.hideScrollers()},showScrollers:function(){this._legendsScrollLeft.style.display="block",this._legendsScrollRight.style.display="block"},hideScrollers:function(){this._legendsScrollLeft.style.display="none",this._legendsScrollRight.style.display="none"},toggleOpen:function(){Wu.app.mobile?this._isOpen?this.MobileCloseLegends():this.MobileOpenLegends():this._isOpen?this.closeLegends():this.openLegends()},MobileCloseLegends:function(){Wu.DomUtil.removeClass(this._legendsOpener,"legends-open"),this._content.style.left=Wu.app.nativeResolution[1]+"px",this._setClosed()},MobileOpenLegends:function(){app.MapPane.layerMenu._open&&app.MapPane.layerMenu.closeLayerPane(),app.MapPane.descriptionControl._isClosed||app.MapPane.descriptionControl.mobileClosePane(),Wu.DomUtil.addClass(this._legendsOpener,"legends-open"),this._content.style.left="0px",this._setOpen()},closeLegends:function(){this._legendsOpener.style.display="block",this._legendsInner.style.width=this._legendsWidth+"px",this._legendsInner.style.height=this._legendsHeight+"px";var a=this;setTimeout(function(){a._legendsOpener.style.opacity="1",a._legendsInner.style.width="150px",a._legendsInner.style.height="24px",a._legendsScrollLeft.style.display="none",a._legendsScrollRight.style.display="none"},10),setTimeout(function(){a._legendsCollapser.style.opacity="0",this._openWidth=0,this._openHeight=0,this._legendsWidth=0,this._legendsHeight=0},500),this._setClosed()},openLegends:function(){Wu.app.mobile||(this._legendsOpener.style.opacity="0"),this._legendsInner.style.width=this.sliderWidth+"px",this.checkWidth(),this._legendsInner.style.height=this._openHeight+"px";var a=this;setTimeout(function(){a._legendsInner.removeAttribute("style"),a._legendsCollapser.style.opacity="1",a._legendsOpener.style.display="none"},500),this._setOpen()},update:function(a){this.project=a||Wu.app._activeProject,this._content=this._legendsContainer,this.initContainer(),this.calculateHeight()},initContainer:function(){this.addHooks(),this.legends={},this._layers=[],this.legendsCounter=[],this.sliderWidth=0,this.sliderOffset=0,app.Tooltip.add(this._legendsInner,"Shows legends of active layers",{"extends":"systyle",tipJoint:"top right"}),Wu.app.mobile&&(this._content.style.left=Wu.app.nativeResolution[1]+"px",this._setClosed(),Wu.DomUtil.create("div","legends-mobile-arrow",this._content))},addLegend:function(a){this._layers.push(a),this.refreshLegends()},removeLegend:function(a){_.remove(this._layers,function(b){return b.store.uuid==a.store.uuid});_.remove(this._legendsContainer,function(b){return b.id==a.store.uuid}),this.refreshLegends()},refreshAllLegends:function(){var a=app.MapPane.getActiveLayers();this.refreshLegends(a)},refreshLegends:function(a){this.legendsCounter=[],this.sliderWidth=0,this._legendsInnerSlider.innerHTML="";var a=a||this._getActiveLayers();a.forEach(function(a){this._legendOn(a)&&this._addLegend(a)},this),0==this.legendsCounter.length&&(this._container.style.display="none",this._setClosed())},_legendOn:function(a){var b=[],c=a.getLegends();return c?(c.forEach(function(a){a.on&&b.push(a)}),b.length):!1},_getActiveLayers:function(){var a=app.MapPane.getActiveLayers(),b=_.filter(a,function(a){return!a._isBase});return b},_addLegend:function(a){var b=a.store.uuid,c=a.getActiveLegends();if(c){this._container.style.display="block";var d=Wu.DomUtil.create("div","legends-item",this._legendsInnerSlider),e=150*Math.round(c.length/4);150>e&&(e=150),d.style.width=e+"px",this.sliderWidth+=e,this._legendsInnerSlider.style.width=this.sliderWidth+"px";var f=d.offsetWidth;this.legends[b]={layer:a,div:d,width:f};var g={id:b,width:f};this.legendsCounter.push(g);{var h=this._getLegendHeader(a);Wu.DomUtil.create("div","legend-header",d,h)}this._legendsList=Wu.DomUtil.create("div","legend-list",d),c.forEach(function(a){if(a.on){{var b=Wu.DomUtil.create("div","legend-each",this._legendsList),c=Wu.DomUtil.create("div","legend-feature",b),d=Wu.DomUtil.create("img","legend-image1",c),e=Wu.DomUtil.create("img","legend-image2",c);Wu.DomUtil.create("div","legend-feature-name",b,a.value)}d.src=a.base64,e.src=a.base64}},this),Wu.app.mobile||this._setOpen(),this.checkWidth(),this.calculateHeight()}},_setOpen:function(){this._isOpen=!0,this._setContentHeight()},_setClosed:function(){this._isOpen=!1,this._setContentHeight()},_setContentHeight:function(){var a=app.SidePane.Clients,b=app.SidePane.Map;a&&a.setContentHeight(),b&&b.setContentHeight()},_getLegendHeader:function(a){var b=a.getTooltip();return b?b.title:""},_adjustLegendSlider:function(a){var b=a.div.getBoundingClientRect();b.left<0&&(Wu.DomUtil.removeClass(this._legendsInnerSlider,"legends-inner-slider-sliding"),this._legendsInnerSlider.style.left=this._legendsInnerSlider.offsetLeft+a.width+"px",this.sliderOffset--);var c=this;setTimeout(function(){Wu.DomUtil.addClass(c._legendsInnerSlider,"legends-inner-slider-sliding")},500),this.sliderWidth-=a.width},legendsScrollLeft:function(){if(!this.scrolling&&this.sliderOffset>=1){this.sliderOffset--;var a=this.legendsCounter[this.sliderOffset].width,b=this._legendsInnerSlider.offsetLeft;this._legendsInnerSlider.style.left=b+a+"px",this.scrolling=!0;var c=this;setTimeout(function(){c.scrolling=!1},500)}},legendsScrollRight:function(){if(!this.scrolling&&this.sliderOffset<=this.legendsCounter.length-1){var a=this.legendsCounter[this.sliderOffset].width,b=this._legendsInnerSlider.offsetLeft,c=this._legendsInner.offsetWidth-(this._legendsInnerSlider.offsetWidth+b);if(0>=c){this._legendsInnerSlider.style.left=b-a+"px",this.sliderOffset++,this.scrolling=!0;var d=this;setTimeout(function(){d.scrolling=!1},500)}}},calculateHeight:function(){this._legendsHeight=this._legendsInner.offsetHeight,this._legendsWidth=this._legendsInner.offsetWidth,this._openHeight=this._legendsInner.offsetHeight,this._openWidth=this._legendsInner.offsetWidth,app.StatusPane.setContentHeights()}}),L.control.legends=function(a){return new L.Control.Legends(a)},L.Control.MousePosition=L.Control.extend({options:{position:"topright",separator:" : ",emptyString:"Lat/Lng",lngFirst:!1,numDigits:5,lngFormatter:void 0,latFormatter:void 0,prefix:"",zoomLevel:!0},onAdd:function(a){return this._map=a,this._container=L.DomUtil.create("div","leaflet-control-mouseposition"),this._container.innerHTML=this.options.emptyString,L.DomEvent.disableClickPropagation(this._container),a.on("mousemove",this._onMouseMove,this),this.options.zoomLevel&&(a.on("zoomend",this._updateZoom,this),this._updateZoom()),app.Tooltip.add(this._container,"Gives the coordinates of the mouse pointer",{"extends":"systyle",tipJoint:"bottom middle"}),this._container},_updateZoom:function(){this._zoom=this._map.getZoom()},onRemove:function(a){a.off("mousemove",this._onMouseMove,this),this.options.zoomLevel&&a.off("zoomend",this._updateZoom,this)},_onMouseMove:function(a){var b=this.options.lngFormatter?this.options.lngFormatter(a.latlng.lng):L.Util.formatNum(a.latlng.lng,this.options.numDigits),c=this.options.latFormatter?this.options.latFormatter(a.latlng.lat):L.Util.formatNum(a.latlng.lat,this.options.numDigits),d=this.options.lngFirst?b+this.options.separator+c:c+this.options.separator+b,e=this.options.prefix+" "+d;this.options.zoomLevel&&(e+=" | "+this._zoom),this._container.innerHTML=e}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.mouseposition=function(a){return new L.Control.MousePosition(a)},L.Control.BaselayerToggle=L.Control.extend({options:{collapsed:!0,position:"topleft",autoZIndex:!0},onAdd:function(){return this._initLayout(),this.update(),this._container},addTo:function(a){this._map=a;var b=this._container=this.onAdd(a),c=this.getPosition(),d=a._controlCorners[c];return L.DomUtil.addClass(b,"leaflet-control"),d.appendChild(b),this},_initLayout:function(){var a="leaflet-control-baselayertoggle",b=this._container=L.DomUtil.create("div",a);app.Tooltip.add(b,"Toggle between baselayers",{"extends":"systyle",offset:[23,0]}),Wu.DomEvent.on(b,"mousedown",this.toggle,this),Wu.DomEvent.on(b,"dblclick",Wu.DomEvent.stop,this),Wu.DomEvent.on(b,"mousedown dblclick mouseup click",Wu.DomEvent.stopPropagation,this)},update:function(){if(this._container){this.project=this.project||app.activeProject,this._list&&Wu.DomUtil.remove(this._list),this._layers={},this._list=L.DomUtil.create("div","baselayertoggle-list collapsed",this._container),Wu.DomEvent.on(this._list,"dblclick",Wu.DomEvent.stop,this);var a=this.project.getBaselayers();if(a)return a.forEach(function(a){var b={layer:this.project.getLayer(a.uuid),baseLayer:a};this.addLayer(b)},this),this}},addLayer:function(a){if(!a.layer)return void 0;var b=a.layer.getTitle(),c=Wu.DomUtil.create("div","baselayertoggle-item active",this._list,b);a.active=!0;var d=L.stamp(a);this._layers[d]=a,Wu.DomEvent.on(c,"mousedown",function(b){Wu.DomEvent.stop(b),this.toggleLayer(a,c)},this)},toggleLayer:function(a,b){var c=this._layers[L.stamp(a)].layer;a.active?(c.disable(),a.active=!1,Wu.DomUtil.removeClass(b,"active")):(c.add("baselayer"),a.active=!0,Wu.DomUtil.addClass(b,"active"))},toggle:function(){this._isOpen?this.collapse():this.expand()},collapse:function(){this._isOpen=!1,Wu.DomUtil.addClass(this._list,"collapsed")},expand:function(){this._isOpen=!0,Wu.DomUtil.removeClass(this._list,"collapsed")}}),L.control.baselayerToggle=function(a){return new L.Control.BaselayerToggle(a)},Wu.Style=Wu.Class.extend({initialize:function(){this._styletag=Wu.DomUtil.get("styletag")},setDarkTheme:function(){var a=document.createElement("link");a.rel="stylesheet",a.href=app.options.servers.portal+"css/darktheme.css",this._styletag.appendChild(a),this.setDarkThemeCartoCSS()},setLightTheme:function(){this._styletag.innerHTML="",this.setLightThemeCartoCSS()},setLightThemeCartoCSS:function(){if(app.MapPane.cartoCss){var a=Wu.DomUtil.get("cartoCSStheme");app.MapPane.cartoCss._codeMirror.setOption("theme","default"),a.setAttribute("href",app.options.servers.portal+"js/lib/codemirror/mode/cartocss/codemirror.carto.css")}},setDarkThemeCartoCSS:function(){if(app.MapPane.cartoCss){var a=Wu.DomUtil.get("cartoCSStheme");app.MapPane.cartoCss._codeMirror.setOption("theme","mbo"),a.setAttribute("href",app.options.servers.portal+"js/lib/codemirror/mode/cartocss/codemirror.carto.darktheme.css")}},initSVGpatterns:function(){var a='<!-- SVG fill properties: url(#diagonal-dots) // url(#dots) url(#diagonal-circles) url(#diagonal-stripes) url(#grid) --><svg xmlns="http://www.w3.org/2000/svg"><defs><pattern id="diagonal-dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke:none; fill:blue;" /></pattern></defs><defs><pattern id="dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="4" style="stroke:none; fill:red;" /></pattern><pattern id="diagonal-circles" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke-width:2; stroke:green; fill:none;" /></pattern><pattern id="diagonal-stripes" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(30)"><rect x="0" y="0" width="4" height="8" style="stroke:none; fill:purple;" /></pattern><pattern id="grid" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="10" height="4" style="stroke:none; fill:orange;" /><rect x="3" y="3" width="4" height="10" style="stroke:none; fill:orange;" /></pattern></defs></svg>';this._styletag.innerHTML=a},phantomJS:function(){var a=document.createElement("link");a.rel="stylesheet",a.href=app.options.servers.portal+"css/phantomJS.css",this._styletag.appendChild(a)},phantomJSthumb:function(){var a=document.createElement("link");a.rel="stylesheet",a.href=app.options.servers.portal+"css/phantomJSthumb.css",this._styletag.appendChild(a)}}),L.Control.CartoCSS=L.Control.extend({options:{position:"topleft"},_laidout:!1,onAdd:function(){var a=Wu.DomUtil.create("div","leaflet-control-cartocss leaflet-control");return Wu.DomEvent.on(a,"click mousedown ",Wu.DomEvent.stopPropagation,this),this._toolbarButton=Wu.DomUtil.create("div","cartocss-toolbar-button",a),app.Tooltip.add(this._toolbarButton,"CartoCSS editor, tooltip controller, and legends builder"),this.initLayout(),this.initCodeMirror(),this.addHooks(),a
},onRemove:function(){this.removeHooks(),Wu.DomUtil.remove(this._codeMirror.getWrapperElement()),Wu.DomUtil.remove(this._editorContainer)},initLayout:function(){this._editorContainer=Wu.DomUtil.create("div","cartocss-control-container"),this._resizeHandle=Wu.DomUtil.create("div","cartocss-control-resizer",this._editorContainer),this._wrapper=Wu.DomUtil.create("div","cartocss-control-wrapper",this._editorContainer),this._xButton=Wu.DomUtil.create("div","close-cartocss-editor-x",this._wrapper),this._zoomVal=Wu.DomUtil.create("div","cartocss-zoomval",this._wrapper,app._map.getZoom()),this._styleHeaderWrapper=Wu.DomUtil.create("div","cartocss-style-header-wrapper",this._wrapper),this._styleHeaderLayerName=Wu.DomUtil.create("div","cartocss-style-header-layer",this._styleHeaderWrapper,"Select layer"),this._styleHeaderDropDownButton=Wu.DomUtil.create("div","cartocss-style-dropdown-arrow",this._styleHeaderWrapper),this._layerSelectorOuter=Wu.DomUtil.create("div","cartocss-layerselector-outer",this._wrapper),this._layerSelector=Wu.DomUtil.create("div","cartocss-layerselector",this._layerSelectorOuter),this._tabsWrapper=Wu.DomUtil.create("div","cartocss-tab-wrapper",this._wrapper),this._tabStyling=Wu.DomUtil.create("div","cartocss-tab cartocss-tab-styling cartocss-active-tab",this._tabsWrapper,"Styling"),this._tabTooltip=Wu.DomUtil.create("div","cartocss-tab cartocss-tab-tooltip",this._tabsWrapper,"Tooltip"),this._tabLegends=Wu.DomUtil.create("div","cartocss-tab cartocss-tab-legends",this._tabsWrapper,"Legend"),this._legendsWrapper=Wu.DomUtil.create("div","cartocss-legends-wrapper displayNone",this._wrapper),this._tooltipOuterWrapper=Wu.DomUtil.create("div","cartocss-tooltip-outer-wrapper displayNone",this._wrapper),this._tooltipWrapper=Wu.DomUtil.create("div","cartocss-tooltip-wrapper",this._tooltipOuterWrapper),this._formWrapper=Wu.DomUtil.create("form","cartocss-form-wrapper",this._wrapper),this._inputArea=Wu.DomUtil.create("textarea","cartocss-input",this._formWrapper),this._errorPane=Wu.DomUtil.create("div","cartocss-error-pane",this._wrapper),this._updateButton=Wu.DomUtil.create("div","cartocss-update-button",this._wrapper,"Render changes..."),app._map.getContainer().appendChild(this._editorContainer),app.Tooltip.add(this._styleHeaderWrapper,"Shows a list of active layers for this project.",{"extends":"systyle",tipJoint:"top left"}),app.Tooltip.add(this._zoomVal,"Shows current zoom level.",{"extends":"systyle",tipJoint:"top left"}),app.Tooltip.add(this._tabStyling,"Style selected layer. Takes CartoCSS code.",{"extends":"systyle",tipJoint:"top left"}),app.Tooltip.add(this._tabTooltip,"Customize tooltip to appear when clicking on different shapes in layer.",{"extends":"systyle",tipJoint:"top left"}),app.Tooltip.add(this._tabLegends,"Decide which legends you want to show for selected layer.",{"extends":"systyle",tipJoint:"top left"})},addHooks:function(){Wu.DomEvent.on(this._updateButton,"click",this.renderStyling,this),Wu.DomEvent.on(this._toolbarButton,"click",this.toggle,this),Wu.DomEvent.on(this._xButton,"click",this.toggle,this),Wu.DomEvent.on(this._styleHeaderLayerName,"click",this.toggleLayerDropDown,this),Wu.DomEvent.on(this._tabLegends,"mousedown",this.toggleLegends,this),Wu.DomEvent.on(this._tabStyling,"mousedown",this.toggleStyles,this),Wu.DomEvent.on(this._tabTooltip,"mousedown",this.toggleTooltip,this),Wu.DomEvent.on(this._resizeHandle,"mousedown",this.resize,this),Wu.DomEvent.on(this._editorContainer,"mousewheel mousedown dblclick click",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._toolbarButton,"dblclick",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._styleHeaderLayerName,"click mousedown",Wu.DomEvent.stopPropagation,this),Wu.DomEvent.on(this._formWrapper,"click mousedown",Wu.DomEvent.stopPropagation,this);var a=app._map;a.on("zoomend",function(){this._zoomVal.innerHTML=a.getZoom()},this)},removeHooks:function(){},resize:function(){this.__cartoContainer_offsetLeft=this._editorContainer.offsetLeft,this.__cartoContainer_width=this._editorContainer.offsetWidth,this._ghost=Wu.DomUtil.create("div","resize-ghost",app._appPane),Wu.DomEvent.on(this._ghost,"mouseup",this.removeResizeHooks,this),Wu.DomEvent.on(this._ghost,"mousemove",this.resizeEditor,this)},removeResizeHooks:function(){Wu.DomEvent.off(this._ghost,"mousemove",this.resizeEditor,this),Wu.DomEvent.off(this._ghost,"mouseup",this.removeResizeHooks,this),Wu.DomUtil.remove(this._ghost)},resizeEditor:function(a){var b=a.clientX||a.pageX||0,c=this._editorContainer.offsetLeft,d=this._editorContainer.offsetWidth,e=d+(c-b);e>=300&&(this._editorContainer.style.width=e+"px")},update:function(){this._updated=!1},_update:function(){this._updated||(this.project=app.activeProject,this._layers=this.project.getStylableLayers(),this._fillLayers(),this.setLastUpdatedLayer(),this._updated=!0,this._codeMirror.refresh())},initCodeMirror:function(){this._codeMirror=CodeMirror.fromTextArea(this._inputArea,{lineNumbers:!0,mode:{name:"carto",reference:window.cartoRef},matchBrackets:!0,lineWrapping:!0,paletteHints:!0,gutters:["CodeMirror-linenumbers","errors"]})},_initStylingDefault:function(){var a=this._layer.getMetaFields(),b="// CartoCSS reference guide:\n// https://bit.ly/1z5OvXT\n\n\n";b+="// #layer is always the layer identifier \n",b+="#layer {\n\n",b+="    // Available fields in layer:\n\n";for(key in a){var c=a[key];b+="    // ["+key+"="+c+"] {}\n"}b+="\n\n}",this.updateCodeMirror(b)},setLastUpdatedLayer:function(){var a=(this._layers,_.sortBy(this._layers,function(a){return a.store.lastUpdated})),b=_.last(a);this._selectLayer(b)},updateCodeMirror:function(a){this._codeMirror.setValue(a)},clearCodeMirror:function(){this._codeMirror.setValue("")},_fillLayers:function(){this._layerSelector.innerHTML="",this._layerWrapperList={},this._layers.forEach(function(a){{var b=Wu.DomUtil.create("div","layer-selector-item-wrap");Wu.DomUtil.create("div","layer-selector-item",b,a.getTitle())}this._layerSelector.appendChild(b),this._layerWrapperList[a.getUuid()]=b,Wu.DomEvent.on(b,"mousedown",function(){this._selectLayer(a)},this),Wu.DomEvent.on(b,"click mousedown",Wu.DomEvent.stopPropagation,this)},this)},setSelected:function(a){if(a){var b=this._layerWrapperList[a.getUuid()];this._clearSelected(b),Wu.DomUtil.addClass(b,"vt-selected",this)}},_clearSelected:function(a){for(var b=0;b<a.parentNode.children.length;b++){var c=a.parentNode.children[b];Wu.DomUtil.removeClass(c,"vt-selected",this)}},_selectLayer:function(a){this.closeLayerDropDown(),this.initStyling(a),this.initTooltip(a),this.initLegends(a),this.setSelected(a)},toggleLegends:function(){Wu.DomUtil.addClass(this._formWrapper,"displayNone"),Wu.DomUtil.addClass(this._tooltipOuterWrapper,"displayNone"),Wu.DomUtil.removeClass(this._legendsWrapper,"displayNone"),Wu.DomUtil.removeClass(this._tabTooltip,"cartocss-active-tab"),Wu.DomUtil.removeClass(this._tabStyling,"cartocss-active-tab"),Wu.DomUtil.addClass(this._tabLegends,"cartocss-active-tab")},toggleStyles:function(){Wu.DomUtil.removeClass(this._formWrapper,"displayNone"),Wu.DomUtil.addClass(this._tooltipOuterWrapper,"displayNone"),Wu.DomUtil.addClass(this._legendsWrapper,"displayNone"),Wu.DomUtil.removeClass(this._tabTooltip,"cartocss-active-tab"),Wu.DomUtil.addClass(this._tabStyling,"cartocss-active-tab"),Wu.DomUtil.removeClass(this._tabLegends,"cartocss-active-tab")},toggleTooltip:function(){Wu.DomUtil.removeClass(this._tooltipOuterWrapper,"displayNone"),Wu.DomUtil.addClass(this._formWrapper,"displayNone"),Wu.DomUtil.addClass(this._legendsWrapper,"displayNone"),Wu.DomUtil.addClass(this._tabTooltip,"cartocss-active-tab"),Wu.DomUtil.removeClass(this._tabStyling,"cartocss-active-tab"),Wu.DomUtil.removeClass(this._tabLegends,"cartocss-active-tab")},initStyling:function(a){return a?(this._layer=a,this._cartoid=!1,this._styleHeaderLayerName.innerHTML=a.store.title.camelize(),this._cartoid=this._layer.getCartoid(),this._cartoid?void this._layer.getCartoCSS(this._cartoid,function(a,b){this.updateCodeMirror(b)}.bind(this)):this._initStylingDefault()):void 0},initLegends:function(){return this._legendsWrapper.innerHTML="",this._layer?(this._legends=this._layer.getLegends(),this._legends?this.fillLegends(this._legends):this._initLegendsDefaultMeta()):void 0},initTooltip:function(){if(this._tooltipWrapper.innerHTML="",this._layer){var a=this._layer.getTooltip();return a?this._initTooltipStoredMeta(a):this._initTooltipDefaultMeta()}},fillLegends:function(a){var b=this._layer.getTooltip();this._legendsWrapper.innerHTML="",this._legendsWrapperInner=Wu.DomUtil.create("div","legends-inner-scroller",this._legendsWrapper),this._legendsTitle=Wu.DomUtil.create("div","legends-title",this._legendsWrapperInner),this._legendsTitle.innerHTML=b.title||"No title",this._legendsListWrapper=Wu.DomUtil.create("div","legends-list-wrapper",this._legendsWrapperInner),a.forEach(function(a){var b=this._legendEntry(a);this._legendsListWrapper.appendChild(b)},this)},_legendEntry:function(a){var b=Wu.DomUtil.create("div","legend-entry-wrap"),c=Wu.DomUtil.create("div","legend-entry-image",b),d=Wu.DomUtil.create("img","legend-image1",c),e=Wu.DomUtil.create("img","legend-image2",c),f=Wu.DomUtil.create("div","legend-entry-key",b),g=Wu.DomUtil.create("div","legend-entry-value",b),h=this._createCheckbox(a.id);return b.appendChild(h),d.src=a.base64,e.src=a.base64,f.innerHTML=this._normalizeKey(a.key),g.innerHTML=a.value,b.setAttribute("legendid",a.id),a.on&&h.firstChild.setAttribute("checked","checked"),Wu.DomEvent.on(h,"change",this._saveLegends,this),b},_saveLegends:function(){app.setSaveStatus(1e3);for(var a=this._layer.getLegends(),b=this._legendsListWrapper.childNodes,c=0;c<b.length;c++){{var d=b[c],e=d.childNodes[3].querySelector("input:checked"),f=e?!0:!1,g=d.getAttribute("legendid");_.find(a,function(a){return a.id==g})}a[c].on=f}this._layer.setLegends(a);var h=app.MapPane.legendsControl;h&&h.refreshLegends()},_normalizeKey:function(a){var b=this._layer.getTooltip(),c=_.find(b.fields,function(b){return a==b.key});return c&&c.title?c.title:a},_createCheckbox:function(a){var b="switch-"+a,c=Wu.DomUtil.create("div","switch carto-switch-legend"),d=Wu.DomUtil.createId("input",b,c),e=Wu.DomUtil.create("label","",c);return Wu.DomUtil.addClass(d,"cmn-toggle cmn-toggle-round-flat"),d.setAttribute("type","checkbox"),e.setAttribute("for",b),c},_initLegendsDefaultMeta:function(){this._legendsWrapper.innerHTML="",Wu.DomUtil.create("div","legends-default-box",this._legendsWrapper,"No legends yet. Style the geo and magic will happen!")},_updateLegends:function(){this._layer.getMeta(),this._layer.getMetaFields();this._layer.createLegends(function(a,b){var c=JSON.parse(b);if(c&&c.err)return this.handleError(c.err);var d=_.remove(c,function(a){return"layer"==a.key});c.unshift(d[0]),c=this._mergePreviousLegendsSettings(c,this._layer.getLegends()),this.fillLegends(c),this._layer.setLegends(c),this._legends=c}.bind(this))},_mergePreviousLegendsSettings:function(a,b){return a.forEach(function(c,d){var e=_.find(b,function(a){return a.value==c.value});e&&(a[d].on=e.on)}),a},_initTooltipStoredMeta:function(a){var b=Wu.DomUtil.createId("input","cartocss-tooltip-custom-header",this._tooltipWrapper);b.setAttribute("placeholder","Tooltip title"),b.value=a.title,Wu.DomEvent.on(b,"keyup",this._saveTip,this);var c=a.fields;c.forEach(function(a){this._createTooltipEntry(a.key,a.title,a.on)},this)},_initTooltipDefaultMeta:function(){var a=this._layer.getMetaFields(),b=Wu.DomUtil.createId("input","cartocss-tooltip-custom-header",this._tooltipWrapper);b.setAttribute("placeholder","Tooltip title"),Wu.DomEvent.on(b,"keyup",this._saveTip,this);for(key in a){{a[key]}this._createTooltipEntry(key,null,!0)}},_createTooltipEntry:function(a,b,c){var d=Wu.DomUtil.create("div","tooltip-field-wrapper",this._tooltipWrapper),e=Wu.DomUtil.create("input","tooltip-field-key",d);e.setAttribute("type","text"),e.setAttribute("placeholder",a),b&&(e.value=b);var f=Wu.DomUtil.create("div","switch carto-switch-tooltip",d),g="switch-"+a,h=Wu.DomUtil.createId("input",g,f);Wu.DomUtil.addClass(h,"cmn-toggle cmn-toggle-round-flat"),h.setAttribute("type","checkbox");var i=Wu.DomUtil.create("label","",f);i.setAttribute("for",g),c&&h.setAttribute("checked","checked"),Wu.DomEvent.on(h,"change",this._saveTip,this),Wu.DomEvent.on(e,"keyup",this._saveTip,this)},_saveTip:function(){this._savingTooltip&&clearTimeout(this._savingTooltip);var a=this;this._savingTooltip=setTimeout(function(){a._saveTooltipMeta(),app.setSaveStatus()},1e3)},_saveTooltipMeta:function(){for(var a={title:"",fields:[]},b=this._tooltipWrapper.childNodes,c=0;c<b.length;c++){var d=b[c];if(0!=c){var e=d.childNodes[0].getAttribute("placeholder"),f=d.childNodes[0].value,g=d.childNodes[1].querySelector("input:checked"),h=g?!0:!1;a.fields.push({key:e,title:f,on:h})}else a.title=d.value}this._layer.setTooltip(a),this._legendsTitle.innerHTML=a.title},closeLayerDropDown:function(){this._openDropDown=!0,this.toggleLayerDropDown()},toggleLayerDropDown:function(){if(this._openDropDown)this._openDropDown=!1,this._layerSelectorOuter.style.height="0px",Wu.DomUtil.removeClass(this._styleHeaderDropDownButton,"carrow-flipped",this);else{this._openDropDown=!0;var a=27*this._layers.length;this._layers.length<=2&&(a+=2),this._layerSelectorOuter.style.height=a+"px",Wu.DomUtil.addClass(this._styleHeaderDropDownButton,"carrow-flipped",this)}},toggle:function(){this._open?this.close():this.open()},open:function(){this._update(),Wu.DomUtil.addClass(this._editorContainer,"open"),this._open=!0},close:function(){Wu.DomUtil.removeClass(this._editorContainer,"open"),this._open=!1},renderStyling:function(){if(this._layer){var a=this._codeMirror.getValue();if(a){var b=this._layer.getFileUuid(),c=Wu.Util.createRandom(7),d={css:a,fileUuid:b,cartoid:c,layerUuid:this._layer.getUuid()};this._layer.setCartoCSS(d,this.renderedStyling.bind(this))}}},renderedStyling:function(a,b){var c=JSON.parse(b);return c.ok?(this._layer.updateStyle(),void this._updateLegends(c.cartoid)):this.handleError(c.error)},handleError:function(a){return"string"==typeof a&&a.indexOf("Unrecognized rule")>-1?this._handleSyntaxError(a):"string"==typeof a&&a.indexOf("Invalid code")>-1?this._handleSyntaxError(a):"string"==typeof a&&a.indexOf("Error: file could not be found:")>-1?this._handlePathError(a):void("string"==typeof a&&a.indexOf("debug")>-1||this._setError(a))},_handleSyntaxError:function(a){var b=a.split(":"),c=parseInt(b[2].trim())-1,d=(b[3].split(" ")[0].trim(),b[3].split(" ")[1]+" "+b[3].split(" ")[2]);d=d.trim().camelize();var e=b[4].split(" ")[1].trim(),f=b[4].split(" ");f.splice(0,2),f=f.join(" ");var g=d+": "+e+". "+f;this._setError(g,c)},_setError:function(a,b){var c=this._codeMirror.getDoc();b&&c.addLineClass(b,"wrap","gutter-syntax-error"),this._errorPane.innerHTML=a,Wu.DomUtil.addClass(this._errorPane,"active-error"),c.on("change",function(){this._clearError(b||0)}.bind(this))},_handlePathError:function(a){var b="Wrong path for pattern-file.";this._setError(b)},_clearError:function(a){this._errorPane.innerHTML="",Wu.DomUtil.removeClass(this._errorPane,"active-error");var b=this._codeMirror.getDoc();b.removeLineClass(a,"wrap"),b.off("change",function(){this._clearError(a||0)}.bind(this))},destroy:function(){this.onRemove()},getPatternList:function(){}}),L.control.cartoCss=function(a){return new L.Control.CartoCSS(a)},Wu.Tooltip=Wu.Class.extend({options:{fixed:!0,target:!0,tipJoint:"middle right",background:"#333",borderColor:"#333",className:"systip",delay:1},defaultStyle:{fixed:!0,target:!0,tipJoint:"middle right",background:"#333",borderColor:"#333",className:"systip",delay:1},initialize:function(){this.tips=[],Opentip.styles.systyle=this.defaultStyle},_isActive:function(){var a=app.activeProject;return a?a.getSettings().tooltips:!1},add:function(a,b,c){var d=_.extend(_.clone(this.options),c);this.tips.push({div:a,content:b,options:d}),this._isActive()?this.on():this.off()},on:function(){this.tips.forEach(function(a){if(!a.inited){var b=new Opentip(a.div,a.content,a.options);return a.inited=!0,void(a.tip=b)}a.tip&&a.tip.activate()},this)},off:function(){this.tips.forEach(function(a){a.tip&&a.tip.deactivate()},this)},activate:function(){this.on()},deactivate:function(){this.off()}}),L.SpinningMap=L.Class.extend({options:{gl:!1,accessToken:null,layer:null,logo:"",content:"",container:"map",speed:1e3,tileFormat:"jpg70",position:{lat:59.91843,lng:10.74721,zoom:[4,17]},circle:{radius:120,color:"rgba(33,33,33,0.5)",border:{px:4,solid:"solid",color:"white"}},autoStart:!1,interactivity:!1,spinning:["spinning","spinning90","spinning270","spinning-reversed","spinning-reversed90","spinning-reversed270"],listeners:[{event:null,action:"changeView"}],duration:1e5},initialize:function(a){L.setOptions(this,a),L.mapbox.accessToken=this.options.accessToken,this.initLayout(),this.addHooks(),this.options.autoStart&&this.start()},initLayout:function(){this._wrapper=this.options.wrapper||L.DomUtil.create("div","spinning-wrapper",document.body),this._container=this.options.container,this._wrapper.appendChild(this._container),this.options.content&&this.initContent(),this._gl=this.options.gl&&mapboxgl.util.supported(),this._gl?this.initGLMap():this.initMap(),this._logo=L.DomUtil.get("login-logo");var a='url("'+this.options.logo+'")';this._logo.style.backgroundImage=a},initContent:function(){var a=this.options.content;this._wrapper.appendChild(a)},initMap:function(){this.setDimensions(),this.createMap(),this.options.circle&&this.createCircle(),L.DomEvent.on(window,"resize",this.setDimensions,this)},disable:function(){Wu.DomUtil.remove(this._wrapper),setTimeout(this.kill,1e3)},kill:function(){this._wrapper=null,delete this._wrapper,delete this._map,delete this._container,delete this},createMap:function(){{var a=this.options.position.lat,b=this.options.position.lng,c=(this.options.position.zoom,this._map=L.mapbox.map(this._container));L.mapbox.tileLayer(this.options.layer,{format:this.options.tileFormat}).addTo(c)}this.setView(a,b,this._getZoomLevel()),this.options.interactivity||(c.dragging.disable(),c.touchZoom.disable(),c.doubleClickZoom.disable(),c.scrollWheelZoom.disable(),c.boxZoom.disable(),c.keyboard.disable()),c.zoomControl.removeFrom(c),c.attributionControl.removeFrom(c)},setView:function(a,b,c){this._map.setView([a,b],c)},changeView:function(){var a=this.options.position.lat,b=this.options.position.lng;this.setView(a,b,this._getZoomLevel()),this.stop(),this.start()},addHooks:function(){var a=this._map;a.on("resize",this._onResize.bind(this))},removeHooks:function(){var a=this._map;a.off("resize",this._onResize.bind(this))},contentClick:function(){this._resetMoves(),this._gl&&this.changeViewGL()},_onResize:function(){var a=this._container.offsetWidth,b=this._past||a,c=b-a,d=c/2*.75;this._past=a,this._map.panBy([-d,0],{duration:0})},createCircle:function(){this._circleContainer=L.DomUtil.create("div","startpane-circle-container",this._wrapper),this._circle=L.DomUtil.create("div","startpane-circle",this._circleContainer);var a=this.options.circle.radius,b=this.options.circle.border,c=b.px+"px "+b.solid+" "+b.color;this._circle.style.width=a+"px",this._circle.style.height=a+"px",this._circle.style.borderRadius=a+"px",this._circle.style.top=a/-2+"px",this._circle.style.left=a/-2+"px",this._circle.style.background=this.options.circle.color,this._circle.style.border=c,this._gl||L.DomEvent.on(this._circle,"mousedown",this.changeView,this),this._gl&&L.DomEvent.on(this._circle,"mousedown",this.changeViewGL,this)},setDimensions:function(){var a=this._getDimensions(),b=.125*a.width-a.width,c=.5*a.height-a.width;this._container.style.height=2*a.width+"px",this._container.style.width=2*a.width+"px",this._container.style.top=c+"px",this._container.style.left=b+"px"},_getDimensions:function(a){var b=window,c=document,a=c.documentElement,d=c.getElementsByTagName("body")[0],e=b.innerWidth||a.clientWidth||d.clientWidth,f=b.innerHeight||a.clientHeight||d.clientHeight,c={height:f,width:e};return c},start:function(){this._gl?this._startGL():this._start()},stop:function(){this._gl?this._stopGL():this._stop()},_start:function(){this._direction=this._getDirection(),L.DomUtil.addClass(this._container,this._direction)},_stop:function(){L.DomUtil.removeClass(this._container,this._direction)},_getDirection:function(){var a=this.options.spinning,b=Math.floor(Math.random()*a.length);return a[b]},_getZoomLevel:function(){var a=this.options.position.zoom[0],b=this.options.position.zoom[1],c=Math.floor(Math.random()*(b-a+1)+a);return 13==c||14==c||15==c?this._getZoomLevel():c},createGLmap:function(){var a=this.options.position.lat,b=this.options.position.lng,c=this._getZoomLevel(),d=this.options.accessToken,e=(this._container,this.options.layer);mapboxgl.accessToken=d;this._map=new mapboxgl.Map({container:this._container.id,style:{version:6,sources:{"simple-tiles":{tiles:"raster",url:"mapbox://"+e,tileSize:256,type:"raster"}},layers:[{id:"simple-tiles",type:"raster",source:"simple-tiles",minzoom:0,maxzoom:22}]},center:[a,b],zoom:c})},initGLMap:function(){this._extendMapboxGL(),this.createGLmap(),this.createCircle()},_extendMapboxGL:function(){mapboxgl.Map.prototype._normalizeBearing=function(a){return a}},panGL:function(){var a=this._container.offsetWidth,b=this._pan=.375*a;this._map.panBy([b,0],{duration:0})},restartGLRotation:function(){clearTimeout(this._rotationTimer),this.startGLRotation()},startGLRotation:function(){var a=this.options.duration,b=(new mapboxgl.LatLng(37.76,-122.44),this._container.offsetWidth,this._getOffset());this._deg||(this._deg=90),this._map.rotateTo(this._deg,{duration:a,offset:b,easing:function(a){return a}}),this._rotationTimer=setTimeout(this.startGLRotation.bind(this),a),this._deg=this._deg+90},changeViewGL:function(){var a=(this._map.getBearing(),this._bearing=this._bearing?this._bearing+90:90);this._bearing>=360&&(this._bearing=0);var b=this._getBearingOffset(a),c=this.options.position.lat,d=this.options.position.lng,e=this._getZoomLevel(this._map.getZoom());this._map.flyTo([c,d],e,a,{offset:b,speed:.8})},_getBearingOffset:function(a){var b=this._getOffset(),c=b[0];if(90==a)var d=[0,c];if(180==a)var d=[-c,0];if(270==a)var d=[0,-c];if(360==a||0==a)var d=[c,0];return d},_randomIntFromInterval:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},_getOffset:function(a){var b=this._container.offsetWidth,c=b*-.375;return a?[0,c]:[c,0]},_startGL:function(){this.panGL(),this.startGLRotation()},_stopGL:function(){}}),Wu.Project=Wu.Class.extend({initialize:function(a){this.store={},Wu.extend(this.store,a),this.setEditMode(),this.lastSaved={},this._client=Wu.app.Clients[this.store.client]},initFiles:function(){var a=this.getFiles();this.files={},a.forEach(function(a){this.files[a.uuid]=new Wu.Files(a)},this)},initLayers:function(){this.store.layers&&(this.layers={},this.addLayers(this.store.layers))},addLayers:function(a){a.forEach(function(a){this.addLayer(a)},this)},addLayer:function(a){return this.store.layers.push(a),this.layers[a.uuid]=new Wu.createLayer(a),this.layers[a.uuid]},addBaseLayer:function(a){this.store.baseLayers.push(a),this._update("baseLayers")},removeBaseLayer:function(a){_.remove(this.store.baseLayers,function(b){return b.uuid==a.getUuid()}),this._update("baseLayers")},createOSMLayer:function(a){var b=this._getOSMLayerTitle(),c=JSON.stringify({projectUuid:this.getUuid(),title:b});Wu.Util.postcb("/api/layers/osm/new",c,function(b,c){var d=b.addLayer(JSON.parse(c));a(null,d)},this)},_getOSMLayerTitle:function(){var a=_.filter(this.getLayers(),function(a){return a.store.data.osm}),b="Open Street Map",c=a.length;return c&&(b+=" #"+c),b},createLayerFromGeoJSON:function(a){var b=JSON.stringify({project:this.getUuid(),geojson:a,layerType:"geojson"});Wu.Util.postcb("/api/layers/new",b,this._createdLayerFromGeoJSON,this)},_createdLayerFromGeoJSON:function(a,b){var c=JSON.parse(b);app.SidePane.DataLibrary.uploaded(c,{autoAdd:!0})},createLayer:function(){},setActive:function(){this.select()},setEditMode:function(){this.editMode=!1,app.Account.canUpdateProject(this.store.uuid)&&(this.editMode=!0)},refresh:function(){this._refresh(),this.refreshMappane(),this.refreshHeaderpane(),this.refreshSidepane(),this._menuItem&&this._menuItem._markActive(),app.StatusPane.isOpen&&(app._map._controlCorners.topleft.style.opacity=0,app._map._controlCorners.topleft.style.display="none")},addNewLayer:function(a){this.addLayer(a)},refreshSidepane:function(){Wu.Util.isObject(Wu.app.SidePane)&&Wu.app.SidePane.setProject(this)},refreshHeaderpane:function(){Wu.Util.isObject(Wu.app.HeaderPane)&&Wu.app.HeaderPane.setProject(this)},refreshMappane:function(){Wu.Util.isObject(Wu.app.MapPane)&&Wu.app.MapPane.setProject(this)},_refresh:function(){this.setEditMode(),this.initFiles(),this.initLayers(),this._setUrl(),this.refreshSettings(),this.setColorTheme()},select:function(){app._headerPane&&Wu.DomUtil.removeClass(app._headerPane,"displayNone"),app.activeProject=this,this.selected=!0,this.refresh()},_setUrl:function(){var a="/";a+=this._client.slug,a+="/",a+=this.store.slug,Wu.Util.setAddressBar(a)},setNewStore:function(a){this.store=a,this.select()},setStore:function(a){this.store=a,this.refresh()},setMapboxAccount:function(a){this.store=a,this._refresh(),this.refreshSidepane()},_update:function(a){var b={};b[a]=this.store[a],b.uuid=this.store.uuid;var c=JSON.stringify(b);this._save(c)},save:function(){},_save:function(a){Wu.save("/api/project/update",a),app.setSaveStatus()},_saveNew:function(a){var b={name:this.store.name,description:this.store.description,keywords:this.store.keywords,client:this._client.uuid},c=JSON.stringify(b);Wu.Util.postcb("/api/project/new",c,a.callback.bind(a.context),this)},unload:function(){Wu.app.MapPane.reset(),Wu.app.HeaderPane.reset(),this.selected=!1},_delete:function(){var a=JSON.stringify({pid:this.store.uuid,projectUuid:this.store.uuid,clientUuid:this._client.uuid});Wu.Util.postcb("/api/project/delete",a,this._deleted,this)},_deleted:function(a){app.Account.removeProjectAccess(a);var b=a.getClient().getSlug(),c=app.options.servers.portal+b+"/";Wu.Util.setAddressBar(c),delete Wu.app.Projects[a.store.uuid],app.activeProject==this&&(app.SidePane.refresh(["Projects","Users","Account"]),app.activeProject=null);var d=a.store.uuid;delete app.Projects[d],app.setStatus("Deleted!")},saveColorTheme:function(){this.colorTheme=savedCSS,this._update("colorTheme")},setColorTheme:function(){this.colorTheme&&(savedCSS=this.colorTheme,Wu.Util.setColorTheme())},removeMapboxAccount:function(a){_.remove(this.store.connectedAccounts.mapbox,function(b){return b==a});this._update("connectedAccounts");var b=this.getLayers(),c=[];b.forEach(function(b){if(b.store.data&&b.store.data.mapbox){var d=b.store.data.mapbox,e=d.split(".")[0];e==a.username&&(this._removeLayer(b),c.push(b.getUuid()))}},this);var d={projectUuid:this.getUuid(),layerUuids:c},e=JSON.stringify(d);Wu.save("/api/layers/delete",e)},_removeLayer:function(a){_.remove(this.store.layermenu,function(b){return b.layer==a.getUuid()}),_.remove(this.store.baseLayers,function(b){return b.uuid==a.getUuid()});var b=app.MapPane.layerMenu;b&&b.onDelete(a),a.remove();_.remove(this.store.layers,function(b){return b.uuid==a.getUuid()});delete this.layers[a.getUuid()],this._update("layermenu"),this._update("baseLayers")},getName:function(){return this.store.name},getDescription:function(){return this.store.description},getLogo:function(){return this.store.logo},getUuid:function(){return this.store.uuid},getLastUpdated:function(){return this.store.lastUpdated},getClient:function(){return app.Clients[this.store.client]},getClientUuid:function(){return this.store.client},getBaselayers:function(){return this.store.baseLayers},getLayermenuLayers:function(){return _.filter(this.store.layermenu,function(a){return!a.folder})},getLayers:function(){return _.toArray(this.layers)},getActiveLayers:function(){var a=this.getBaselayers(),b=this.getLayermenuLayers(),c=a.concat(b),d=[];return c.forEach(function(a){if(!a.folder){var b=a.layer||a.uuid,c=this.layers[b];d.push(c)}},this),d},getLayer:function(a){return this.layers[a]},getStylableLayers:function(){var a=this.getActiveLayers(),b=_.filter(a,function(a){return a?a.store.data.hasOwnProperty("geojson")?!0:a.store.data.hasOwnProperty("osm")?!0:void 0:!1});return b},getLayerFromFile:function(a){return _.find(this.layers,function(b){return b.store.file==a})},getFiles:function(){return this.store.files},getFileObjects:function(){return this.files},getFileStore:function(a){var b=_.find(this.store.files,function(b){return b.uuid==a});return b},getFile:function(a){return this.files[a]},getBounds:function(){var a=this.store.bounds;return _.isEmpty(a)?!1:a},getLatLngZoom:function(){var a={lat:this.store.position.lat,lng:this.store.position.lng,zoom:this.store.position.zoom};return a},getPosition:function(){return this.getLatLngZoom()},getCollections:function(){},getCategories:function(){return this.store.categories},addCategory:function(a){this.store.categories.push(a),this._update("categories")},removeCategory:function(a){_.remove(this.store.categories,function(b){return b.toLowerCase()==a.toLowerCase()}),this._update("categories")},setCollection:function(){},setFileAttribute:function(a,b,c){},getUsers:function(){var a=this.store.uuid,b=_.filter(app.Users,function(b){return b.store.role.reader.projects.indexOf(a)>-1});return b},getSlug:function(){return this.store.slug},getSlugs:function(){var a={project:this.store.slug,client:this.getClient().getSlug()};return a},getUsersHTML:function(){var a=this.getUsers(),b="",c=app.options.silentUsers;return a.forEach(function(a){var d=a.store.uuid.slice(0,13);-1==c.indexOf(d)&&(b+="<p>"+a.store.firstName+" "+a.store.lastName+"</p>")},this),b},addAccess:function(){var a=app.Users;for(u in a){var b=a[u];b.isSuperadmin()&&b.addProjectAccess(this)}app.Account.addProjectAccess(this)},getHeaderLogo:function(){var a=this.store.header.logo;return a||(a="/css/images/defaultProjectLogo.png"),a},getHeaderLogoBg:function(){var a=this.store.header.logo;a||(a=this.store.logo);var b="url('"+a+"')";return b},getHeaderTitle:function(){return this.store.header.title},getHeaderSubtitle:function(){return this.store.header.subtitle},getHeaderHeight:function(){return parseInt(this.store.header.height)},getMapboxAccounts:function(){return this.store.connectedAccounts.mapbox},getControls:function(){return this.store.controls},getSettings:function(){return this.store.settings},setSettings:function(a){this.store.settings=a,this._update("settings")},setFile:function(a){this.store.files.push(a),this.files[a.uuid]=new Wu.Files(a)},setLogo:function(a){this.store.logo=a,this._update("logo")},setHeaderLogo:function(a){this.store.header.logo=a,this._update("header")},setHeaderTitle:function(a){this.store.header.title=a,this._update("header")},setHeaderSubtitle:function(a){this.store.header.subtitle=a,this._update("header")},setName:function(a){this.store.name=a,this._update("name")},setDescription:function(a){this.store.description=a,this._update("description")},setSlug:function(a){var b=a.replace(/\s+/g,"").toLowerCase();b=Wu.Util.stripAccents(b),this.store.slug=b,this._update("slug"),this._setUrl()},setThumbCreated:function(a){this.store.thumbCreated=a,this._update("thumbCreated")},getThumbCreated:function(){return this.store.thumbCreated},setBounds:function(a){this.store.bounds=a,this._update("bounds")},setBoundsSW:function(a){this.store.bounds.southWest=a,this._update("bounds")},setBoundsNE:function(a){this.store.bounds.northEast=a,this._update("bounds")},setBoundsZoomMin:function(a){this.store.bounds.zoomMin=a,this._update("bounds")},setPosition:function(a){this.store.position=a,this._update("position")},setSidepane:function(a){this._menuItem=a},getSidepane:function(){return this._menuItem},removeFiles:function(a){var b=app.SidePane.DataLibrary.list,c=app.MapPane.layerMenu,d=[],e=[],f=this;a.forEach(function(a){b.remove("uuid",a.uuid),_.remove(this.store.files,function(b){return b.uuid==a.uuid
}),delete this.files[a.uuid];var f=_.find(this.layers,function(b){return b.store.file==a.uuid});if(f){_.remove(this.store.layermenu,function(a){return a.layer==f.store.uuid}),_.remove(this.store.baseLayers,function(a){return a.uuid==f.store.uuid}),c&&c.onDelete(f),f.remove();{_.remove(this.store.layers,function(a){return a.uuid==f.store.uuid})}delete this.layers[f.store.uuid]}d.push(a._id),e.push(a.uuid)},this),this._update("layermenu"),this._update("baseLayers"),setTimeout(function(){var a={_fids:d,puuid:f.store.uuid,uuids:e},b=JSON.stringify(a);Wu.save("/api/file/delete",b)},1e3)},getGrandeFiles:function(){var a=this.getFiles(),b=this._formatGrandeFiles(a);return b},getGrandeImages:function(){var a=this.getFiles(),b=this._formatGrandeImages(a);return b},_formatGrandeImages:function(a){var b=[];return a.forEach(function(a){if("image"==a.type){var c="/pixels/"+a.uuid+"?width=75&height=50",d="/pixels/"+a.uuid+"?width=200&height=200",e={title:a.name,thumbnail:c,uuid:a.uuid,type:a.type,url:d};b.push(e)}},this),b},_formatGrandeFiles:function(a){var b=[];return a.forEach(function(a){var c="image"==a.type?"/pixels/"+a.uuid+"?width=50&height=50":"",d="image"==a.type?"/images/":"/api/file/download/?file=",e=d+a.uuid,f={title:a.name,thumbnail:c,uuid:a.uuid,type:a.type,url:e};b.push(f)},this),b},refreshSettings:function(){for(setting in this.getSettings())this.getSettings()[setting]?this["enable"+setting.camelize()]():this["disable"+setting.camelize()]();app.SidePane._refresh()},toggleSetting:function(a){this.getSettings()[a]?this["disable"+a.camelize()](!0):this["enable"+a.camelize()](!0),this.store.settings[a]=!this.store.settings[a],this._update("settings")},enableDarkTheme:function(){app.Style.setDarkTheme()},disableDarkTheme:function(){app.Style.setLightTheme()},enableTooltips:function(){app.Tooltip.activate()},disableTooltips:function(){app.Tooltip.deactivate()},enableScreenshot:function(){app.SidePane.Share.enableScreenshot()},disableScreenshot:function(){app.SidePane.Share.disableScreenshot()},enableDocumentsPane:function(a){a?app.SidePane.addPane("Documents"):app.SidePane._addPane("Documents")},disableDocumentsPane:function(a){a?app.SidePane.removePane("Documents"):app.SidePane._removePane("Documents")},enableDataLibrary:function(a){a?app.SidePane.addPane("DataLibrary"):app.SidePane._addPane("DataLibrary")},disableDataLibrary:function(a){a?app.SidePane.removePane("DataLibrary"):app.SidePane._removePane("DataLibrary")},enableMediaLibrary:function(){},disableMediaLibrary:function(){},enableSocialSharing:function(a){a?app.SidePane.addPane("Share"):app.SidePane._addPane("Share")},disableSocialSharing:function(a){a?app.SidePane.removePane("Share"):app.SidePane._removePane("Share")},enableAutoHelp:function(){},disableAutoHelp:function(){},enableAutoAbout:function(){},disableAutoAbout:function(){},enableMapboxGL:function(){},disableMapboxGL:function(){},createProjectThumb:function(){this.setTempLogo(),app.setHash(function(a,b){var c=JSON.parse(b);c.dimensions={height:233,width:350},Wu.post("/api/util/createThumb",JSON.stringify(c),this.createdProjectThumb,this)}.bind(this),this)},createdProjectThumb:function(a,b){var c=JSON.parse(b),d=c.cropped,e=(c.fileUuid,"/images/"+d);a.setLogo(e),a.setHeaderLogo(e),a._menuItem.logo.src=e,a==app.activeProject&&app.HeaderPane.addedLogo(d)},setTempLogo:function(){this._sidePaneLogoContainer.src="/css/images/grinders/BG-grinder-small-grayDark-on-white.gif"}}),Wu.Client=Wu.Class.extend({initialize:function(a){Wu.extend(this,a),this.options={},this.options.editMode=!1},setEditMode:function(){this.editMode=!1,app.Account.canUpdateClient(this.uuid)&&(this.editMode=!0)},setActive:function(){this.setEditMode(),this._setUrl(),this._isActive()||(Wu.app._activeClient=this)},_isActive:function(){return Wu.Util.isObject(Wu.app._activeClient)&&Wu.app._activeClient.uuid==this.uuid?!0:!1},_setUrl:function(){var a="/"+this.slug+"/";Wu.Util.setAddressBar(a)},update:function(a){var b={};b[a]=this[a],b.uuid=this.uuid;var c=JSON.stringify(b);this._save(c)},_save:function(a){Wu.save("/api/client/update",a)},saveNew:function(){var a={name:this.name,description:this.description,keywords:this.keywords},b=JSON.stringify(a),c=Wu.app.SidePane.Clients;Wu.Util.postcb("/api/client/new",b,c._created,this)},destroy:function(){this._delete()},_delete:function(){var a=this,b={cid:a.uuid};b=JSON.stringify(b),Wu.Util.postcb("/api/client/delete",b,a._deleted,a)},_deleted:function(a){delete Wu.app.Clients[a.uuid]},getName:function(){return this.name},getDescription:function(){return this.description},getLogo:function(){return this.logo},getUuid:function(){return this.uuid},getSlug:function(){return this.slug},setName:function(a){this.name=a,this.update("name")},setDescription:function(a){this.description=a,this.update("description")},setLogo:function(a){this.logo=a,this.update("logo")}}),Wu.User=Wu.Class.extend({initialize:function(a){this.store=a,this.lastSaved=_.cloneDeep(a)},setLastName:function(a){this.store.lastName=a,this.save()},setFirstName:function(a){this.store.firstName=a,this.save()},setCompany:function(a){this.store.company=a,this.save()},setPosition:function(a){this.store.position=a,this.save()},setPhone:function(a){this.store.phone=a,this.save()},setMobile:function(a){this.store.mobile=a,this.save()},setEmail:function(a){this.store.local.email=a,this.save()},setKey:function(a,b){return"lastName"==a?this.setLastName(b):"firstName"==a?this.setFirstName(b):"company"==a?this.setCompany(b):"position"==a?this.setPosition(b):"mobile"==a?this.setMobile(b):"phone"==a?this.setPhone(b):"email"==a?this.setEmail(b):void 0},setAccess:function(){},save:function(){this._saveTimer&&clearTimeout(this._saveTimer);var a=this;this._saveTimer=setTimeout(function(){var b=a._findChanges();b&&a._save(b)},1e3)},_save:function(a){Wu.save("/api/user/update",JSON.stringify(a))},isSuperuser:function(){return this.isSuperadmin()},isSuperadmin:function(){return this.store.role.superadmin?!0:!1},isAdmin:function(){return this.store.role.admin?!0:!1},isManager:function(){return _.size(this.store.role.manager.projects)>0||this.isAdmin()||this.isSuperadmin()?!0:!1},attachToApp:function(){app.Users[this.getUuid()]=this},deleteUser:function(a,b){delete app.Users[this.store.uuid];var c=this.store.uuid,d=JSON.stringify({uuid:c});Wu.Util.postcb("/api/user/delete",d,a[b],a)},delegateAccess:function(a,b,c){var d={userUuid:this.getUuid(),projectUuid:a.getUuid(),role:b,add:c};Wu.Util.postcb("/api/user/delegate",JSON.stringify(d),this.delegatedAccess,this),app.setSaveStatus()},delegatedAccess:function(){},addReadProject:function(a){this.delegateAccess(a,"reader",!0),this.store.role.reader.projects.push(a.getUuid())},removeReadProject:function(a){this.delegateAccess(a,"reader",!1),_.remove(this.store.role.reader.projects,function(b){return b==a.getUuid()})},addUpdateClient:function(a){this.store.role.editor.clients.push(a.getUuid())},addUpdateProject:function(a){this.delegateAccess(a,"editor",!0),this.store.role.editor.projects.push(a.getUuid())},removeUpdateProject:function(a){this.delegateAccess(a,"editor",!1),_.remove(this.store.role.editor.projects,function(b){return b==a.getUuid()})},addManageProject:function(a){this.delegateAccess(a,"manager",!0),this.store.role.manager.projects.push(a.getUuid())},removeManageProject:function(a){this.delegateAccess(a,"manager",!1),_.remove(this.store.role.manager.projects,function(b){return b==a.getUuid()})},addProjectAccess:function(a){var b=a.getUuid();this.store.role.editor.projects.push(b),this.store.role.reader.projects.push(b),this.store.role.manager.projects.push(b)},removeProjectAccess:function(a){_.remove(this.store.role.manager.projects,function(b){return b==a.getUuid()}),_.remove(this.store.role.editor.projects,function(b){return b==a.getUuid()}),_.remove(this.store.role.reader.projects,function(b){return b==a.getUuid()})},getKey:function(a){return this.store[a]},getFirstName:function(){return this.store.firstName},getLastName:function(){return this.store.lastName},getFullName:function(){return this.store.firstName+" "+this.store.lastName},getName:function(){return this.getFullName()},getCompany:function(){return this.store.company},getPosition:function(){return this.store.position},getPhone:function(){return this.store.phone},getMobile:function(){return this.store.mobile},getEmail:function(){return this.store.local.email},getProjects:function(){var a=[];return a.push(this.store.role.reader.projects),a.push(this.store.role.editor.projects),a.push(this.store.role.manager.projects),a=_.flatten(a),a=_.unique(a)},getProjectsByRole:function(){var a={};return a.read=this.store.role.reader.projects,a.update=this.store.role.editor.projects,a.manage=this.store.role.manager.projects,a},getClients:function(){var a={};return a.read=this.store.role.reader.clients,a.update=this.store.role.editor.clients,a},getUuid:function(){return this.store.uuid},canCreateProject:function(){var a=this.store;return a.role.superadmin?!0:a.role.admin?!0:!1},canReadProject:function(a){var b=this.store;return b.role.superadmin?!0:b.role.reader.projects.indexOf(a)>=0?!0:!1},canUpdateProject:function(a){var b=this.store;return b.role.superadmin?!0:b.role.editor.projects.indexOf(a)>=0?!0:!1},canDeleteProject:function(a){var b=this.store,c=b.role.editor.projects.indexOf(a)>=0?!0:!1;return b.role.superadmin?!0:b.role.admin&&c?!0:!1},canManageProject:function(a){var b=this.store;return b.role.superadmin?!0:b.role.manager.projects.indexOf(a)>=0?!0:!1},canCreateClient:function(){var a=this.store;return a.role.superadmin?!0:a.role.admin?!0:!1},canReadClient:function(a){var b=this.store;return b.role.superadmin?!0:b.role.reader.clients.indexOf(a)>=0?!0:!1},canUpdateClient:function(a){var b=this.store;return b.role.superadmin?!0:this.store.role.editor.clients.indexOf(a)>=0?!0:!1},canDeleteClient:function(a){var b=this.store.role.editor.clients.indexOf(a)>=0?!0:!1;return this.store.role.superadmin&&b?!0:this.store.role.admin&&b?!0:!1},canCreateSuperadmin:function(){return this.store.role.superadmin?!0:!1},canCreateAdmin:function(){var a=this.store;return a.role.superadmin?!0:a.role.admin?!0:!1},canCreateUser:function(a){var b=this.store;return b.role.superadmin?!0:b.role.admin?!0:b.role.manager.projects.indexOf(a)>=0?!0:!1},canUpdateUser:function(){var a=this.store;return a.role.superadmin?!0:a.role.admin?!0:!1},canDeleteUser:function(){},_findChanges:function(){var a=_.cloneDeep(this.store),d=_.cloneDeep(this.lastSaved),e=[];for(c in a)if(_.isObject(a[c])){var f=a[c];for(b in f){{f[b]}if(h=_.isEqual(a[c][b],d[c][b]),!h){var g={};g[c]={},g[c][b]=a[c][b],e.push(g)}}}else{var h=_.isEqual(a[c],d[c]);if(!h){var g={};g[c]=a[c],e.push(g)}}if(0==e.length)return!1;var i={};return e.forEach(function(a){for(c in a)i[c]=a[c]},this),i.uuid=this.getUuid(),this.lastSaved=_.cloneDeep(this.store),i}}),Wu.Layer=Wu.Class.extend({type:"layer",options:{hoverTooltip:!0},initialize:function(a){this.store=a,this.loaded=!1,this.initLayer(),Wu.DomEvent.on(this.layer,"load",function(){app._loaded.push(this.getUuid()),app._loaded=_.uniq(app._loaded)},this),this._zx=app.MapPane.getZIndexControls()},initLayer:function(){},add:function(a){"baselayer"==a&&(this._isBase=!0),this.addTo()},addTo:function(){this._addTo(),this.addToControls()},_addTo:function(a){var b=app._map;this.layer.addTo(b),app.MapPane.addActiveLayer(this),this.gridLayer&&b.addLayer(this.gridLayer),this._addToZIndex(a)},addToControls:function(){this._isBase||(this._addToLegends(),this._addToInspect(),this._addToDescription(),this._addToLayermenu())},_addToLayermenu:function(){var a=app.MapPane.layerMenu;a&&a._enableLayer(this.getUuid())},_addToLegends:function(){var a=app.MapPane.legendsControl;a&&a.addLegend(this)},_addToInspect:function(){var a=app.MapPane.inspectControl;a&&a.addLayer(this)},_addToDescription:function(){var a=app.MapPane.descriptionControl;if(a){a.setLayer(this);var b=app.Account.isSuperadmin()||app.Account.canUpdateProject(app.activeProject.getUuid());this.store.description||b?a.show():a.hide()}},leafletEvent:function(a,b){this.layer.on(a,b)},_addToZIndex:function(a){"baselayer"==a&&(this._isBase=!0);var b=this._zx;this._isBase?b.b.add(this):b.l.add(this)},_removeFromZIndex:function(){var a=this._zx;this._isBase?a.b.remove(this):a.l.remove(this)},remove:function(a){var a=a||app._map;a.removeLayer(this.layer),app.MapPane.removeActiveLayer(this),this.gridLayer&&a.removeLayer(this.gridLayer),this._removeFromZIndex();var b=app.MapPane.inspectControl;b&&b.removeLayer(this);var c=app.MapPane.legendsControl;c&&c.removeLegend(this);var d=app.MapPane.descriptionControl;d&&(d.removeLayer(this),d._container.style.display="none")},getActiveLayers:function(){return this._activeLayers},enable:function(){this.addTo()},disable:function(){this.remove()},setOpacity:function(a){this.opacity=a||1,this.layer.setOpacity(this.opacity)},getOpacity:function(){return this.opacity||1},getContainer:function(){return this.layer.getContainer()},getTitle:function(){return this.store.title},setTitle:function(a){this.store.title=a,this.save("title")},getUuid:function(){return this.store.uuid},getFileUuid:function(){return this.store.file},getProjectUuid:function(){return app.activeProject.store.uuid},setCartoid:function(a){this.store.data.cartoid=a,this.save("data")},getCartoid:function(){return this.store.data?this.store.data.cartoid:void 0},setCartoCSS:function(a,b){Wu.post("/api/layers/cartocss/set",JSON.stringify(a),b,this),this.setCartoid(a.cartoid)},getCartoCSS:function(a,b){var c={cartoid:a};Wu.post("/api/layers/cartocss/get",JSON.stringify(c),b,this)},getMeta:function(){var a=this.store.metadata;return a?JSON.parse(a):!1},getMetaFields:function(){var a=this.getMeta();return a&&a.json&&a.json.vector_layers&&a.json.vector_layers[0]&&a.json.vector_layers[0].fields?a.json.vector_layers[0].fields:!1},reloadMeta:function(a){var b=JSON.stringify({fileUuid:this.getFileUuid(),layerUuid:this.getUuid()});Wu.post("/api/layer/reloadmeta",b,a||function(){},this)},getTooltip:function(){var a=this.store.tooltip;if(!a)return!1;var b=JSON.parse(a);return b},setTooltip:function(a){this.store.tooltip=JSON.stringify(a),this.save("tooltip")},getLegends:function(){var a=this.store.legends;return a?JSON.parse(a):!1},getActiveLegends:function(){var a=this.getLegends(),b=_.filter(a,function(a){return a.on});return b},setLegends:function(a){a&&(this.store.legends=JSON.stringify(a),this.save("legends"))},createLegends:function(a){var b=JSON.stringify({fileUuid:this.getFileUuid(),cartoid:this.getCartoid()});Wu.post("/api/layer/createlegends",b,a,this)},getFeaturesValues:function(a,b){if(!a||!b)return void 0;var c=JSON.stringify({fileUuid:this.getFileUuid(),cartoid:this.getCartoid()});Wu.post("/api/util/getfeaturesvalues",c,a.bind(b),this)},hide:function(){var a=this.getContainer();a.style.visibility="hidden"},show:function(){var a=this.getContainer();a.style.visibility="visible"},save:function(a){var b={};b[a]=this.store[a],b.layer=this.store.uuid,b.uuid=app.activeProject.getUuid(),this._save(b)},_save:function(a){var b=JSON.stringify(a);Wu.save("/api/layer/update",b)},_setZIndex:function(a){this.layer.setZIndex(a)},_addGridEvents:function(){var a=this.gridLayer;a&&(a.on("mousedown",function(a){if(a.data){a.layer=this,app.MapPane._addPopupContent(a);var b=a.e.originalEvent;this._event={x:b.x,y:b.y}}},this),a.on("mouseup",function(a){if(a.data){a.layer=this;var b=a.e.originalEvent;void 0===this._event||this._event.x==b.x?app.MapPane.openPopup(a):app.MapPane._clearPopup()}},this),a.on("click",function(){app.MapPane._clearPopup()},this))}}),Wu.RasterLayer=Wu.Layer.extend({type:"rasterLayer"}),Wu.CartoCSSLayer=Wu.Layer.extend({initLayer:function(){this.update()},update:function(){app._map;this.layer&&this.remove(),this._fileUuid=this.store.file,this._defaultCartoid="cartoid",this._prepareRaster(),this._prepareGrid()},_prepareRaster:function(){var a=(this._fileUuid,this.store.data.cartoid||this._defaultCartoid),b=app.options.servers.tiles.uri,c=app.options.servers.tiles.subdomains,d=app.accessToken,e=b+"{fileUuid}/{cartoid}/{z}/{x}/{y}.png"+d;this.layer=L.tileLayer(e,{fileUuid:this._fileUuid,cartoid:a,subdomains:c,maxRequests:0})},_prepareGrid:function(){var a=this._fileUuid,b=(this.store.data.cartoid||"cartoid",app.options.servers.utfgrid.uri),c=app.options.servers.utfgrid.subdomains,d=app.accessToken,e=b+"{fileUuid}/{z}/{x}/{y}.grid.json"+d;this.gridLayer=new L.UtfGrid(e,{useJsonP:!1,subdomains:c,maxRequests:20,requestTimeout:2e4,fileUuid:a}),this._addGridEvents()},updateStyle:function(){this.layer&&this.layer.setOptions({cartoid:this.getCartoid()})},_typeLayer:function(){}}),Wu.OSMLayer=Wu.CartoCSSLayer.extend({update:function(){app._map;this.layer&&this.remove(),this._fileUuid="osm",this._defaultCartoid="cartoidosm",this._prepareRaster(),this._prepareGrid()},_prepareRaster:function(){var a=(this._fileUuid,this.store.data.cartoid||this._defaultCartoid),b=app.options.servers.osm.uri,c=app.options.servers.osm.subdomains,d=app.accessToken,e=b+"{fileUuid}/{cartoid}/{z}/{x}/{y}.png"+d;this.layer=L.tileLayer(e,{fileUuid:this._fileUuid,cartoid:a,subdomains:c,maxRequests:0})},_prepareGrid:function(){this._fileUuid,this.store.data.cartoid||"cartoid",app.options.servers.osm.uri,app.options.servers.osm.subdomains,app.accessToken;this.gridLayer=!1,this._addGridEvents()},getFileUuid:function(){return"osm"},setCartoCSS:function(a,b){Wu.post("/api/layers/cartocss/set",JSON.stringify(a),b,this),this.setCartoid(a.cartoid)},getCartoCSS:function(a,b){var c={cartoid:a};Wu.post("/api/layers/cartocss/get",JSON.stringify(c),b,this)},updateStyle:function(){this.layer&&this.layer.setOptions({cartoid:this.getCartoid()})}}),Wu.MapboxLayer=Wu.Layer.extend({type:"mapboxLayer",initLayer:function(){this.layer=L.mapbox.tileLayer(this.store.data.mapbox,{accessToken:this.store.accessToken}),"grids"in this.store&&(this.gridLayer=L.mapbox.gridLayer(this.store.data.mapbox)),this.loaded=!0}}),Wu.CartodbLayer=Wu.Layer.extend({}),Wu.createLayer=function(a){return a.data.mapbox?new Wu.MapboxLayer(a):a.data.geojson?new Wu.CartoCSSLayer(a):a.data.osm?new Wu.OSMLayer(a):a.data.topojson?new Wu.TopojsonLayer(a):void 0},L.TileLayer.include({setOptions:function(a){L.setOptions(this,a),this.redraw()}}),L.UtfGrid.include({setOptions:function(a){L.setOptions(this,a),this.redraw()}}),Wu.Files=Wu.Class.extend({_:"file",initialize:function(a){this.store=a},getStore:function(){return this.store},getName:function(){return this.store.name},getType:function(){return this.store.type},getUuid:function(){return this.store.uuid},getLastUpdated:function(){return this.store.lastUpdated},getKeywords:function(){return this.store.keywords},getFormat:function(){return this.store.format},getFileList:function(){return this.store.files},getDatasize:function(){return this.store.dataSize},getCreatedByName:function(){return this.store.createdByName},getCreatedBy:function(){return this.store.createdBy},getCreated:function(){return this.store.created},getCategory:function(){return this.store.category},getStatus:function(){return this.store.status},getVersion:function(){return this.store.version},getDescription:function(){return this.store.description},setName:function(a){this.store.name=a,this.save("name")},setKeywords:function(a){this.store.keywords=a,this.save("keywords")},setFormat:function(a){this.store.format=a,this.save("format")},setCategory:function(a){this.store.category=a,this.save("category")},setStatus:function(a){this.store.status=a,this.save("status")},setVersion:function(a){this.store.version=a,this.save("version")},setDescription:function(a){this.store.description=a,this.save("description")},save:function(a){var b={};b[a]=this.store[a],b.uuid=this.store.uuid;var c=JSON.stringify(b);this._save(c)},_save:function(a){Wu.save("/api/file/update",a),app.setSaveStatus()},_delete:function(){}});var systemapicConfigOptions={id:"app",portalName:"systemapic",portalLogo:!1,portalTitle:"Systemapic Secure Portal: Rüppells Griffon",panes:{clients:!0,mapOptions:!0,documents:!0,dataLibrary:!0,users:!0,share:!0,mediaLibrary:!1,account:!0},settings:{chat:!0,colorTheme:!0,screenshot:!0,socialSharing:!0,print:!0},providers:{mapbox:[{username:"systemapic",accessToken:"pk.eyJ1Ijoic3lzdGVtYXBpYyIsImEiOiJkV2JONUNVIn0.TJrzQrsehgz_NAfuF8Sr1Q"}]},servers:{portal:"https://projects.ruppellsgriffon.com/",tiles:{uri:"https://{s}.systemapic.com/r/",subdomains:"abcd"},utfgrid:{uri:"https://{s}.systemapic.com/u/",subdomains:"abcd"},osm:{base:"https://m.systemapic.com/",uri:"https://{s}.systemapic.com/r/",subdomains:"mnop"}},silentUsers:["user-9fed4b5f","user-e6e5d7d9"]};Wu.version="0.4-dev",Wu.App=Wu.Class.extend({_:"app",options:systemapicConfigOptions,_ready:!1,initialize:function(a){Wu.app=this,Wu.setOptions(this,a),L.mapbox.config.FORCE_HTTPS=!0,L.mapbox.accessToken=this.options.providers.mapbox[0].accessToken,document.title=this.options.portalTitle,this.initServer(),this.detectMobile()},detectMobile:function(){if(L.Browser.mobile){Wu.app.mobile=!1,Wu.app.pad=!1;var a=screen.height,b=screen.width;if(Wu.app.nativeResolution=[a,b],a>=b)var c=b;else var c=a;if(450>c){Wu.app.mobile=!0;var d="mobilestyle.css"}else{Wu.app.pad=!0;var d="padstyle.css"}var e=document.getElementById("mobilestyle"),f='<link rel="stylesheet" href="'+app.options.servers.portal+"css/"+d+'">';e.innerHTML=f}},initServer:function(){var a=JSON.stringify(this.options);Wu.post("/api/portal",a,this.initServerResponse,this)},initServerResponse:function(a,b){var c=JSON.parse(b);a.initApp(c)},initApp:function(a){this.options.json=a,this._initContainer(),this._initDependencies(),this._initObjects(),this._initPanes(),this._initView(),this._initEvents(),this._ready=!0,this._debug()},_initEvents:function(){Wu.DomEvent.on(window,"resize",this._resizeEvents,this)},_resizeEvents:function(a){var b=this._getDimensions(a);app.StartPane.isOpen&&app.StartPane.resizeEvent(b),app.MapPane&&app.MapPane.resizeEvent(b);var c=app.MapPane.legendsControl;c&&c.resizeEvent(b);var d=app.MapPane.layerMenu;d&&d.resizeEvent(b)},_getDimensions:function(a){var b=window,c=document,a=c.documentElement,d=c.getElementsByTagName("body")[0],e=b.innerWidth||a.clientWidth||d.clientWidth,f=b.innerHeight||a.clientHeight||d.clientHeight,c={height:f,width:e,e:a};return c},_initContainer:function(){var a=this.options.id;this._appPane=Wu.DomUtil.get(a)||Wu.DomUtil.createId("div",a||"app",document.body),this._mapContainer=Wu.DomUtil.createId("div","map-container",this._appPane)},_initDependencies:function(){ich.grabTemplates()},_isDev:function(a){return"user-b76a8d27-6db6-46e0-8fc3"==a.uuid.slice(0,-13)?!0:"user-9fed4b5f-ad48-479a-88c3"==a.uuid.slice(0,-13)?!0:"user-e6e5d7d9-3b4c-403b-ad80"==a.uuid.slice(0,-13)?!0:!1},_initObjects:function(){this.Account=new Wu.User(this.options.json.account),this.setToken(),this.Users={},this.options.json.users.forEach(function(a){this._isDev(a)||(this.Users[a.uuid]=new Wu.User(a))},this),this.Clients={},this.options.json.clients.forEach(function(a){this.Clients[a.uuid]=new Wu.Client(a,this)},this),this.Projects={},this.options.json.projects.forEach(function(a){this.Projects[a.uuid]=new Wu.Project(a,this)},this)},setToken:function(){this.accessToken="?token=",this.accessToken+=Wu.app.Account.store.token,this.accessToken+=".",this.accessToken+=Wu.app.Account.store._id},_initPanes:function(){this.Tooltip=new Wu.Tooltip,this.Style=new Wu.Style,this.StatusPane=new Wu.StatusPane({addTo:this._appPane}),this.ProgressBar=new Wu.ProgressPane({color:"white",addTo:this._appPane}),this.StartPane=new Wu.StartPane({projects:this.Projects}),this.Dropzone=new Wu.Dropzone,this.SidePane=new Wu.SidePane,this.HeaderPane=new Wu.HeaderPane,this.MapPane=new Wu.MapPane,this.ErrorPane=new Wu.ErrorPane},_initView:function(){if(!this._initLocation()&&!this._initHotlink()&&!this._lonelyProject()){var a=app.Account;(a.isAdmin()||a.isSuperadmin()||a.isManager())&&this.SidePane.refresh(["Clients","Users","Account"]),this.StartPane.activate()}},_lonelyProject:function(){if(1==_.size(app.Projects))for(p in app.Projects){var a=app.Projects[p];return this._setProject(a),!0}return!1},_initLocation:function(){{var a=window.location.pathname,b=a.split("/")[1],c=a.split("/")[2],d=a.split("/")[3];window.location.search.split("?"),Wu.Util.parseUrl()}if(!b||!c)return!1;var c=this._projectExists(c,b);return c?(this._setProject(c),d&&6==d.length?this._initHash(c,d):!0):(Wu.Util.setAddressBar(this.options.servers.portal),!1)},_setProject:function(a){a.select(),app.SidePane.refreshProject(a),Wu.DomUtil.removeClass(app._mapPane,"click-to-start")},_initHotlink:function(){try{this.hotlink=JSON.parse(window.hotlink)}catch(a){this.hotlink=!1}if(!this.hotlink)return!1;var b=this._projectExists(this.hotlink.project,this.hotlink.client);return b?(this._setProject(b),!0):!1},_projectExists:function(a,b){var a=a||window.hotlink.project;for(p in Wu.app.Projects){var c=Wu.app.Projects[p];if(a==c.store.slug&&c._client.slug==b)return c}return!1},getPortalName:function(){return this.options.portalName},setStatus:function(a,b){app.StatusPane.setStatus(a,b)},setSaveStatus:function(a){app.StatusPane.setSaveStatus(a)},_initHash:function(a,b){return this.getHash(b,a,this._renderHash),!0},getHash:function(a,b,c){var d={projectUuid:b.getUuid(),id:a};Wu.post("/api/project/hash/get",JSON.stringify(d),c,this)},_renderHash:function(a,b){var c=JSON.parse(b);c.error;var d=c.hash,e=d.project||c.project,f=app.Projects[e];app.MapPane.setPosition(d.position),d.layers.forEach(function(a){var b=f.getLayer(a),c=f.getBaselayers(),d=_.find(c,function(b){return b.uuid==a});if(d)b.add("baselayer");else{var e=app.MapPane.layerMenu;if(e){var g=e._getLayermenuItem(a);e.enableLayer(g)}}},this)},setHash:function(a,b){var c=app.MapPane.getActiveLayermenuLayers(),d=_.map(c,function(a){return a.item.layer}),b=b||this.activeProject,e={projectUuid:b.getUuid(),hash:{id:Wu.Util.createRandom(6),position:app.MapPane.getPosition(),layers:d}};return Wu.post("/api/project/hash/set",JSON.stringify(e),a,this),e.hash},phantomJS:function(a){var b=a.projectUuid,c=a.hash,d=a.thumb;if(!b)return!1;var e=app.Projects[b];if(!e)return!1;if(this._loading=c.layers.slice(),e.getBaselayers().forEach(function(a){this._loading.push(a)},this),this._setProject(e),this.StartPane&&this.StartPane.deactivate(),d?app.Style.phantomJSthumb():app.Style.phantomJS(),c){var f=JSON.stringify({hash:c,project:b});this._renderHash(this,f)}app.MapPane.legendsControl.refreshAllLegends(),app.setStatus("systemapic")},phantomReady:function(){return this._loaded&&this._loading&&this._loaded.length==this._loading.length?!0:!1},_loaded:[],_loading:[],_debug:function(){this.debug&&(Wu.setStyle("img",{"border-top":"1px solid rgba(255, 0, 0, 0.65)","border-left":"1px solid rgba(255, 0, 0, 0.65)"}),app._map&&app._map.on("mousedown",function(a){{var b=a.latlng.lat,c=a.latlng.lng,d=app._map.getZoom();this._getTileURL(b,c,d)}},this),"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}))},_getTileURL:function(a,b,c){var d=parseInt(Math.floor((b+180)/360*(1<<c))),e=parseInt(Math.floor((1-Math.log(Math.tan(a.toRad())+1/Math.cos(a.toRad()))/Math.PI)/2*(1<<c)));return""+c+"/"+d+"/"+e}});